var Watcher=(()=>{var Tt=Object.defineProperty;var Ra=Object.getOwnPropertyDescriptor;var _a=Object.getOwnPropertyNames;var Ha=Object.prototype.hasOwnProperty;var Da=(e,t)=>{for(var n in t)Tt(e,n,{get:t[n],enumerable:!0})},Aa=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of _a(t))!Ha.call(e,a)&&a!==n&&Tt(e,a,{get:()=>t[a],enumerable:!(s=Ra(t,a))||s.enumerable});return e};var Ua=e=>Aa(Tt({},"__esModule",{value:!0}),e);var qr={};Da(qr,{CHART_COLORS:()=>j,api:()=>nt,charts:()=>tt,pages:()=>Oe,utils:()=>et});function m(e){if(e==null)return"";let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(e).replace(/[&<>"']/g,n=>t[n])}function G(e){let t=document.getElementById(e);t&&(t.style.display="block")}function z(e){let t=document.getElementById(e);t&&(t.style.display="none")}function Ne(e,t){let n=document.getElementById(e);n&&(n.style.display=t?"flex":"none")}function Y(e){if(!e)return"0 Bytes";let t=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,n)).toFixed(2)+" "+t[n]}function be(e){return e!=null?e.toFixed(2)+" ms":"-- ms"}function pn(e,t=1){return e!=null?e.toFixed(t)+"%":"--%"}function We(e){if(!e||e<=0)return"--";let t=Math.floor(e/3600),n=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}h ${n}m ${s}s`:n>0?`${n}m ${s}s`:`${s}s`}function de(e){return e*9/5+32}function ee(e){return e?"\xB0F":"\xB0C"}function ke(e,t){return(t?de(e):e).toFixed(1)+ee(t)}function Ye(e){return e<40?{text:"Cool",color:"#38ef7d",icon:"\u2744\uFE0F"}:e<60?{text:"Normal",color:"#28a745",icon:"\u2705"}:e<80?{text:"Warm",color:"#ffc107",icon:"\u26A0\uFE0F"}:{text:"Hot",color:"#f5576c",icon:"\u{1F525}"}}function Me(e){if(!e)return e;let t={cpu:"CPU",gpu:"GPU",soc:"SoC",acpi:"ACPI",pch:"PCH"},n=e.replace(/[_-]/g," ").replace(/\b\w/g,s=>s.toUpperCase());return Object.entries(t).forEach(([s,a])=>{n=n.replace(new RegExp("\\b"+s+"\\b","gi"),a)}),n}function te(e="lastUpdate"){let t=document.getElementById(e);t&&(t.textContent="Last updated: "+new Date().toLocaleTimeString())}var et={escapeHtml:m,showElement:G,hideElement:z,setLoading:Ne,formatBytes:Y,formatLatency:be,formatPercent:pn,formatDuration:We,toFahrenheit:de,getTempUnit:ee,formatTemp:ke,getTempStatus:Ye,formatThermalZoneName:Me,updateLastUpdateTime:te};var j={purple:{border:"rgb(102, 126, 234)",bg:"rgba(102, 126, 234, 0.1)"},red:{border:"rgb(245, 87, 108)",bg:"rgba(245, 87, 108, 0.1)"},green:{border:"rgb(56, 239, 125)",bg:"rgba(56, 239, 125, 0.1)"},blue:{border:"rgb(79, 172, 254)",bg:"rgba(79, 172, 254, 0.1)"},pink:{border:"rgb(240, 147, 251)",bg:"rgba(240, 147, 251, 0.1)"},orange:{border:"rgb(255, 159, 64)",bg:"rgba(255, 159, 64, 0.1)"},teal:{border:"rgb(75, 192, 192)",bg:"rgba(75, 192, 192, 0.1)"},coral:{border:"rgb(255, 99, 132)",bg:"rgba(255, 99, 132, 0.1)"},yellow:{border:"rgb(255, 193, 7)",bg:"rgba(255, 193, 7, 0.1)"},cyan:{border:"rgb(23, 162, 184)",bg:"rgba(23, 162, 184, 0.1)"},indigo:{border:"rgb(111, 66, 193)",bg:"rgba(111, 66, 193, 0.1)"}},fn=[j.purple,j.green,j.pink,j.blue,j.coral,j.yellow,j.cyan,j.indigo];function Le(e){return fn[e%fn.length]}function mn(e){return e<=.5?{unit:"minute",stepSize:5}:e<=1?{unit:"minute",stepSize:10}:e<=2?{unit:"minute",stepSize:15}:e<=4?{unit:"minute",stepSize:30}:e<=12?{unit:"hour",stepSize:1}:e<=24?{unit:"hour",stepSize:2}:e<=168?{unit:"day",stepSize:1}:{unit:"week",stepSize:1}}function gn(e){return mn(e).unit}function Pt(){return{minute:"HH:mm",hour:"MMM d, HH:mm",day:"MMM d",week:"MMM d, yyyy"}}function M(e,t,n,s={}){var o,r;let a=typeof n=="string"?j[n]||j.purple:n;return{label:e,data:t,borderColor:a.border,backgroundColor:a.bg,borderWidth:2,fill:(o=s.fill)!=null?o:!0,tension:0,spanGaps:!0,pointRadius:(r=s.pointRadius)!=null?r:0,pointHoverRadius:5,...s}}function H(e,t){return((e==null?void 0:e.data)||[]).map(n=>({x:n.timestamp*1e3,y:n[t]}))}function K(e,t={}){let{yLabel:n="Value",beginAtZero:s=!1,yMin:a,yMax:o,yTickFormatter:r=S=>S,tooltipLabel:i,showLegend:l=!0,animation:c=!1,decimationSamples:d=500,extraScales:u={}}=t,f=mn(e),h=Pt(),p=Date.now(),y=p-e*3600*1e3;return{responsive:!0,maintainAspectRatio:!0,animation:c,interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{decimation:{enabled:!0,algorithm:"lttb",samples:d},legend:{display:l,position:"top"},tooltip:{callbacks:{title:S=>new Date(S[0].parsed.x).toLocaleString(),label:i||(S=>`${S.dataset.label}: ${S.parsed.y}`)}}},scales:{x:{type:"time",min:y,max:p,time:{unit:f.unit,stepSize:f.stepSize,displayFormats:h,tooltipFormat:"MMM d, yyyy HH:mm:ss"},ticks:{maxTicksLimit:8,maxRotation:45,minRotation:0,autoSkip:!0},title:{display:!0,text:"Time",font:{size:14,weight:"bold"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.05)"}},y:{beginAtZero:s,...a!==void 0&&{min:a},...o!==void 0&&{max:o},title:{display:!0,text:n,font:{size:14,weight:"bold"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.05)"},ticks:{callback:r}},...u}}}function F(e,t,n,s,a,o){let r=document.getElementById(n);if(!r)return null;if(e[t]){let c=e[t];try{if(c.canvas&&c.canvas===r)return a.forEach((d,u)=>{c.data.datasets[u]?(c.data.datasets[u].data=d.data,c.data.datasets[u].label=d.label,d.borderColor&&(c.data.datasets[u].borderColor=d.borderColor),d.backgroundColor&&(c.data.datasets[u].backgroundColor=d.backgroundColor)):c.data.datasets.push(d)}),c.data.datasets.length=a.length,o.scales&&(o.scales.x&&(c.options.scales.x.min=o.scales.x.min,c.options.scales.x.max=o.scales.x.max,o.scales.x.time&&(c.options.scales.x.time.unit=o.scales.x.time.unit,c.options.scales.x.time.stepSize=o.scales.x.time.stepSize)),o.scales.y&&(o.scales.y.min!==void 0&&(c.options.scales.y.min=o.scales.y.min),o.scales.y.max!==void 0&&(c.options.scales.y.max=o.scales.y.max))),c.update("none"),c}catch(d){console.warn(`Chart ${t} has stale reference, recreating`)}try{e[t].destroy()}catch(d){}delete e[t]}let i=Chart.getChart(r);i&&i.destroy();let l=r.getContext("2d");return l?(e[t]=new Chart(l,{type:s,data:{datasets:a},options:o}),e[t]):null}var tt={CHART_COLORS:j,getChartColor:Le,getTimeUnit:gn,getTimeFormats:Pt,createDataset:M,mapChartData:H,buildChartOptions:K,updateOrCreateChart:F};async function T(e,t=1e4){let n=new AbortController,s=setTimeout(()=>n.abort(),t);try{let a=await fetch(e,{signal:n.signal,cache:"no-store"});if(clearTimeout(s),!a.ok)throw new Error(`HTTP ${a.status}`);return await a.json()}catch(a){throw clearTimeout(s),a}}async function me(e,t,n){let s=e==null?void 0:e.querySelector("i");s&&(s.className="fas fa-spinner fa-spin"),e&&(e.disabled=!0);try{return await n()}finally{s&&(s.className=t),e&&(e.disabled=!1)}}function hn(e,t=3e4){let n=!1,s=null,a={get isRefreshing(){return n},async refresh(o=!0){if(n)return;n=!0;let r=document.querySelector(".refreshButton i");r&&(r.style.animation="spin 1s linear infinite");try{await e(o)}finally{n=!1,r&&(r.style.animation="")}},startAutoRefresh(){s||(s=setInterval(()=>a.refresh(!1),t))},stopAutoRefresh(){s&&(clearInterval(s),s=null)}};return a}async function Be(){let e=localStorage.getItem("temperatureInF");if(e!==null)return e==="true";try{let{value:t}=await T("/api/settings/temperatureInF"),n=t==="1"||t===1;return localStorage.setItem("temperatureInF",n),n}catch(t){return!1}}var nt={fetchJson:T,withButtonLoading:me,createRefreshController:hn,loadTemperaturePreference:Be};var st={0:"#1a1a2e",500:"#16213e",1e3:"#1e5128",2e3:"#4e9f3d",3e3:"#ffc107",4e3:"#fd7e14",5e3:"#dc3545",6e3:"#c82333"},Oa=6e3,Te=16,at=200,Va=500,ja=3e3,yn=["#4e9f3d","#3498db","#9b59b6","#e67e22","#1abc9c","#e74c3c","#34495e","#f1c40f","#16a085","#2ecc71","#8e44ad","#d35400","#00bcd4","#ff5722","#607d8b","#795548"],C={charts:{},currentPortData:{},selectedPort:null,selectedPortConfig:null,refreshInterval:null,chartSkeletonsCreated:!1,lastControlAction:0,confirmModalCallback:null,controlCapabilities:null,config:{}};function ze(e,t){if(!e||e.length<=t)return e;let n=[],s=(e.length-2)/(t-2);n.push(e[0]);for(let a=1;a<t-1;a++){let o=Math.floor((a-1)*s)+1,r=Math.min(Math.floor(a*s)+1,e.length-1),i=o,l=e[o].y;for(let c=o+1;c<r;c++)e[c].y>l&&(l=e[c].y,i=c);n.push(e[i])}return n.push(e[e.length-1]),n}function wn(e){return yn[e%yn.length]}function xn(e){if(e<=0)return st[0];let t=Object.keys(st).map(Number).sort((n,s)=>n-s);for(let n=t.length-1;n>=0;n--)if(e>=t[n])return st[t[n]];return st[0]}function J(e,t=!0){return e==null?"--":e===0?t?"0 mA":"0":e>=1e3?(e/1e3).toFixed(2)+(t?" A":""):e+(t?" mA":"")}function rt(){let e=Date.now();return e-C.lastControlAction<Va?!1:(C.lastControlAction=e,!0)}function q(e,t="info",n=3e3){let s=document.getElementById("toastContainer");if(!s)return;let a=document.createElement("div");a.className=`toast toast-${t}`;let o={success:"fa-check-circle",error:"fa-exclamation-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"};a.innerHTML=`
    <i class="fas ${o[t]||o.info}"></i>
    <span>${m(e)}</span>
  `,s.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")}),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},n)}function En(e,t,n,s){let a=document.getElementById("confirmModal");a&&(document.getElementById("confirmModalTitle").textContent=e,document.getElementById("confirmModalMessage").textContent=t,document.getElementById("confirmModalAction").textContent=n,C.confirmModalCallback=s,a.style.display="flex")}function In(){let e=document.getElementById("confirmModal");e&&(e.style.display="none"),C.confirmModalCallback=null}function vn(){C.confirmModalCallback&&C.confirmModalCallback(),In()}function Sn(e){let t=document.getElementById("efuseHistoryChartsContainer");if(!t||C.chartSkeletonsCreated)return;let n=Math.ceil(e/Te),s="";for(let a=0;a<n;a++){let o=a*Te+1,r=Math.min((a+1)*Te,e),i=`efuseHistoryChart_${a}`;s+=`
      <div class="efuseChartCard" id="chartCard_${a}">
        <div class="efuseChartTitle">
          <span><i class="fas fa-chart-area"></i> Current History - Ports ${o}-${r}</span>
        </div>
        <div class="chartLoading" id="chartLoading_${a}">
          <i class="fas fa-spinner fa-spin"></i> Loading chart data...
        </div>
        <canvas id="${i}" style="max-height: 400px;"></canvas>
      </div>
    `}t.innerHTML=s,C.chartSkeletonsCreated=!0;for(let a=0;a<n;a++)qa(a)}function qa(e){let t=`efuseHistoryChart_${e}`,n=`history_${e}`;if(C.charts[n])return;let s={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}}},y:{min:0,title:{display:!0,text:"mA"}}},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0}},tooltip:{callbacks:{label:function(a){return a.dataset.label+": "+J(a.raw.y)}}}}};F(C.charts,n,t,"line",[],s)}async function Rt(e,t=null){if(!rt()){q("Please wait before trying again","warning");return}try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/port/toggle",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({port:e,state:t})})).json();if(s.success){let a=s.newState==="on"?"enabled":"disabled";q(`${e} ${a}`,"success"),setTimeout(()=>ge(),500)}else q(s.error||"Failed to toggle port","error")}catch(n){console.error("Error toggling port:",n),q("Network error","error")}}async function _t(e){if(!rt()){q("Please wait before trying again","warning");return}try{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/port/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({port:e})})).json();n.success?(q(`${e} fuse reset`,"success"),setTimeout(()=>ge(),500)):q(n.error||"Failed to reset fuse","error")}catch(t){console.error("Error resetting fuse:",t),q("Network error","error")}}async function Na(e){var t;if(!rt()){q("Please wait before trying again","warning");return}if(e==="off"){let n=((t=C.config)==null?void 0:t.ports)||16;En("Disable All Ports?",`This will turn off all ${n} eFuse ports immediately. Your show will stop outputting to all connected pixels.`,"DISABLE ALL",()=>bn(e));return}bn(e)}async function bn(e){try{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/ports/master",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:e})})).json();n.success?(q(`All ports ${e==="on"?"enabled":"disabled"}`,"success"),setTimeout(()=>ge(),500)):q(n.error||"Failed to set all ports","error")}catch(t){console.error("Error with master control:",t),q("Network error","error")}}async function Wa(){if(!rt()){q("Please wait before trying again","warning");return}try{let t=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/ports/reset-all",{method:"POST",headers:{"Content-Type":"application/json"}})).json();if(t.success){let n=t.resetCount||0;n>0?q(`Reset ${n} tripped fuse${n>1?"s":""}`,"success"):q("No fuses to reset","info"),setTimeout(()=>ge(),500)}else q(t.error||"Failed to reset fuses","error")}catch(e){console.error("Error resetting fuses:",e),q("Network error","error")}}function za(){if(!C.selectedPort)return;let e=C.currentPortData[C.selectedPort],t=(e==null?void 0:e.portEnabled)!==!1;Rt(C.selectedPort,t?"off":"on")}function Ja(){C.selectedPort&&_t(C.selectedPort)}function Ga(e,t,n){n?_t(e):Rt(e,t?"off":"on")}function Ka(e){let t=document.getElementById("trippedBanner"),n=document.getElementById("resetTrippedBtn");if(!t)return;let s=Object.entries(e||{}).filter(([o,r])=>r.fuseTripped).map(([o])=>o),a=s.length;a>0?(t.style.display="flex",document.getElementById("trippedCount").textContent=a,document.getElementById("trippedPortList").textContent=s.join(", "),n&&(n.style.display="inline-flex",n.querySelector(".badge").textContent=a)):(t.style.display="none",n&&(n.style.display="none"))}function $n(e){let t=document.getElementById("portOutputConfig");if(!t)return;let n=(e==null?void 0:e.portEnabled)!==!1,s=(e==null?void 0:e.fuseTripped)===!0,a="enabled",o="ENABLED";s?(a="tripped",o="TRIPPED"):n||(a="disabled",o="DISABLED");let c=`
    <div class="portControlRow">
      <div class="portStatusIndicator">
        <span class="statusDot ${a}"></span>
        <span>${o}</span>
      </div>
      <div class="portControlButtons">
        <button class="efuseControlBtn ${n?"danger":"primary"}" onclick="page.toggleSelectedPort()">
          <i class="fas fa-power-off"></i> ${n?"Disable":"Enable"}
        </button>
        <button class="efuseControlBtn warning" onclick="page.resetSelectedPort()" style="display: ${s?"inline-flex":"none"};">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
    </div>
  `;if(!e||!e.pixelCount){t.innerHTML=`
      <div class="outputConfigTitle">Output Configuration</div>
      <div class="noConfig">No output configuration found</div>
      ${c}
    `;return}let d=e.brightness!==null&&e.brightness!==void 0?e.brightness+"%":"--";t.innerHTML=`
    <div class="outputConfigTitle">Output Configuration</div>
    <div class="outputConfigGrid">
      <div class="configItem">
        <span class="configLabel">Type:</span>
        <span class="configValue">${m(e.protocol||"Unknown")}</span>
      </div>
      <div class="configItem">
        <span class="configLabel">Pixels:</span>
        <span class="configValue">${e.pixelCount||0}</span>
      </div>
      <div class="configItem">
        <span class="configLabel">Brightness:</span>
        <span class="configValue">${d}</span>
      </div>
      <div class="configItem">
        <span class="configLabel">Color Order:</span>
        <span class="configValue">${m(e.colorOrder||"RGB")}</span>
      </div>
      ${e.description?`
      <div class="configItem configDesc">
        <span class="configLabel">Description:</span>
        <span class="configValue">${m(e.description)}</span>
      </div>`:""}
    </div>
    <div class="expectedInfo">
      Expected: ~${J(e.expectedCurrentMa)} typical / ${J(e.maxCurrentMa)} max
    </div>
    ${c}
  `}function kn(e){if(e){let t=C.selectedPortConfig?{...e,...C.selectedPortConfig}:e;$n(t)}}function Za(e){let t=document.getElementById("portDetailCurrent");t&&(t.textContent=J(e.currentMa));let n=document.getElementById("portDetailExpected");n&&(n.textContent=J(e.expectedCurrentMa))}function Qa(e){let t=e.totals||{},n=document.getElementById("totalCurrent");n&&(n.textContent=(t.totalAmps||0).toFixed(2)+" A");let s=document.getElementById("activePorts");s&&(s.textContent=(t.activePortCount||0)+" / "+(t.portCount||0))}function Mn(e){let t=document.getElementById("efuseGrid");if(!t)return;let n=Object.entries(e||{}).sort((r,i)=>{let l=parseInt(r[0].replace(/\D/g,""))||0,c=parseInt(i[0].replace(/\D/g,""))||0;return l-c});if(n.length===0){t.innerHTML='<div class="empty-message"><i class="fas fa-plug"></i><h3>No Port Data</h3><p>No port data available</p></div>';return}let s=n.length,a=Math.min(8,s);t.style.gridTemplateColumns=`repeat(${a}, 1fr)`;let o="";for(let[r,i]of n){let l=i.currentMa||0,c=i.portEnabled!==!1,d=i.fuseTripped===!0,u=d?"#c82333":c?xn(l):"#333",f=d?"tripped":i.status||"normal",h=Math.min(100,l/Oa*100),p=C.selectedPort===r?"selected":"",y=c?"":"disabled",w=d?"fa-exclamation-triangle":"fa-power-off",S=d?"tripped":c?"on":"off",x=d?"Reset fuse":c?"Disable port":"Enable port";o+=`
      <div class="efusePort ${f} ${p} ${y}"
           style="background: ${u};" title="Click to view ${m(r)} details">
        <button class="portPowerBtn ${S}" onclick="event.stopPropagation(); page.portPowerClick('${m(r)}', ${c}, ${d})" title="${x}">
          <i class="fas ${w}"></i>
        </button>
        <div class="portClickArea" onclick="page.showPortDetail('${m(r)}')">
          <div class="portName">${m(r.replace("Port","P"))}</div>
          <div class="portValue">${J(l,!1)}</div>
          <div class="portBar">
            <div class="portBarFill" style="width: ${h}%;"></div>
          </div>
        </div>
      </div>
    `}t.innerHTML=o}async function ge(){try{let e=await T("/api/plugin/fpp-plugin-watcher/efuse/current");if(!e.success){console.error("Failed to load current data:",e.error);return}C.currentPortData=e.ports||{},te("lastUpdate"),Qa(e),Mn(e.ports),Ka(e.ports),C.selectedPort&&C.currentPortData[C.selectedPort]&&(Za(C.currentPortData[C.selectedPort]),kn(C.currentPortData[C.selectedPort]))}catch(e){console.error("Error loading current data:",e)}}function Ft(e){let t=document.getElementById("efuseHistoryChartsContainer");t&&(t.innerHTML=`
    <div class="efuseChartCard">
      <div class="efuseChartTitle">
        <span><i class="fas fa-chart-area"></i> Current History</span>
      </div>
      <div class="empty-message">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Error Loading Data</h3>
        <p>${m(e)}</p>
      </div>
    </div>
  `)}function Xa(e){var h;let t=e.totalHistory||[],n=((h=document.getElementById("timeRange"))==null?void 0:h.value)||24,s=n==1?"1h":n+"h",a=document.getElementById("peakLabel");a&&(a.textContent=`Peak (${s})`);let o=document.getElementById("avgLabel");if(o&&(o.textContent=`Average (${s})`),t.length>0){let p=Math.max(...t.map(x=>x.max||x.value)),y=t.reduce((x,v)=>x+v.value,0)/t.length,w=document.getElementById("peakCurrent");w&&(w.textContent=J(p));let S=document.getElementById("avgCurrent");S&&(S.textContent=J(Math.round(y)));return}let r=e.peaks||{},i=0,l=0,c=0;for(let p in r)r[p]>i&&(i=r[p]);let d=e.timeSeries||{};for(let p in d){let y=d[p];if(y.length>0){let w=y.reduce((S,x)=>S+(x.value||0),0);l+=w/y.length,c++}}let u=document.getElementById("peakCurrent");u&&(u.textContent=J(i));let f=document.getElementById("avgCurrent");f&&(f.textContent=c>0?J(Math.round(l/c)):"-- mA")}function Ya(e){let t=e.totalHistory||[],n=document.getElementById("totalHistoryCard");if(t.length===0){n&&(n.style.display="none");return}n&&(n.style.display="block");let s=t.map(u=>({x:new Date(u.timestamp*1e3),y:u.value/1e3})),a=t.map(u=>({x:new Date(u.timestamp*1e3),y:u.min/1e3})),o=t.map(u=>({x:new Date(u.timestamp*1e3),y:u.max/1e3})),r=ze(s,at),i=ze(a,at),c=[{label:"Max",data:ze(o,at),borderColor:"rgba(220, 53, 69, 0.8)",backgroundColor:"rgba(220, 53, 69, 0.1)",fill:"+1",borderWidth:1,pointRadius:0,tension:0},{label:"Average",data:r,borderColor:"#3498db",backgroundColor:"rgba(52, 152, 219, 0.1)",fill:!1,borderWidth:2,pointRadius:0,tension:0},{label:"Min",data:i,borderColor:"rgba(40, 167, 69, 0.8)",backgroundColor:"transparent",fill:!1,borderWidth:1,pointRadius:0,tension:0}],d={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}}},y:{min:0,title:{display:!0,text:"Amps"}}},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0}},tooltip:{callbacks:{label:function(u){return u.dataset.label+": "+u.raw.y.toFixed(2)+" A"}}}}};F(C.charts,"totalHistory","totalHistoryChart","line",c,d)}function eo(e){var l;if(!document.getElementById("efuseHistoryChartsContainer"))return;let n=e.timeSeries||{},s=((l=C.config)==null?void 0:l.ports)||16;C.chartSkeletonsCreated||Sn(s);let a=Object.keys(n).filter(c=>n[c].length>0).sort((c,d)=>{let u=parseInt(c.replace(/\D/g,""))||0,f=parseInt(d.replace(/\D/g,""))||0;return u-f});if(a.length===0){let c=Math.ceil(s/Te);for(let d=0;d<c;d++){let u=document.getElementById(`chartLoading_${d}`);u&&(u.style.display="none");let f=`history_${d}`;C.charts[f]&&(C.charts[f].data.datasets=[],C.charts[f].update("none"))}return}let o=[];for(let c=0;c<a.length;c+=Te)o.push(a.slice(c,c+Te));let r=0;function i(){if(r>=o.length)return;let c=o[r],d=r,u=`history_${d}`,f=document.getElementById(`chartLoading_${d}`);f&&(f.style.display="none");let h=c.map((w,S)=>{let x=n[w],v=wn(S),b=x.map(E=>{var B;return{x:new Date(E.timestamp*1e3),y:(B=E.value)!=null?B:0}});return b=ze(b,at),{label:w,data:b,borderColor:v,backgroundColor:v+"20",fill:!1,tension:0,pointRadius:0}}),p=`efuseHistoryChart_${d}`,y={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}},title:{display:!1}},y:{min:0,title:{display:!0,text:"mA"}}},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0}},tooltip:{callbacks:{label:function(w){return w.dataset.label+": "+J(w.raw.y)}}}}};F(C.charts,u,p,"line",h,y),r++,r<o.length&&requestAnimationFrame(i)}requestAnimationFrame(i)}async function ot(){var t;let e=((t=document.getElementById("timeRange"))==null?void 0:t.value)||24;try{let n=await T(`/api/plugin/fpp-plugin-watcher/efuse/heatmap?hours=${e}`);if(!n.success){console.error("Failed to load heatmap data:",n.error),Ft("Failed to load data");return}try{eo(n),Ya(n),Xa(n)}catch(s){console.error("Error updating chart:",s),Ft("Error rendering chart")}}catch(n){console.error("Error loading heatmap data:",n),Ft("Network error")}}function to(e){let t=e.history||[],n=t.map(r=>{var i,l;return{x:new Date(r.timestamp*1e3),y:(l=(i=r.avg)!=null?i:r.value)!=null?l:0}}),s=t.map(r=>{var i,l;return{x:new Date(r.timestamp*1e3),y:(l=(i=r.max)!=null?i:r.value)!=null?l:0}}),a=[{label:"Average",data:n,borderColor:"#4e9f3d",backgroundColor:"rgba(78, 159, 61, 0.1)",fill:!0,tension:0,pointRadius:0},{label:"Max",data:s,borderColor:"#dc3545",borderDash:[5,5],fill:!1,tension:0,pointRadius:0}],o={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}},title:{display:!1}},y:{min:0,title:{display:!0,text:"mA"}}},plugins:{legend:{position:"top"},tooltip:{callbacks:{label:function(r){return r.dataset.label+": "+J(r.raw.y)}}}}};F(C.charts,"portHistory","portHistoryChart","line",a,o)}async function Ht(e){var n;let t=((n=document.getElementById("timeRange"))==null?void 0:n.value)||24;try{let s=await T(`/api/plugin/fpp-plugin-watcher/efuse/history?port=${encodeURIComponent(e)}&hours=${t}`);if(!s.success){console.error("Failed to load port history:",s.error);return}let a=s.history||[];if(a.length>0){let o=0,r=0;a.forEach(i=>{let l=i.max||i.value||0;l>o&&(o=l),r+=i.avg||i.value||0}),document.getElementById("portDetailPeak").textContent=J(o),document.getElementById("portDetailAvg").textContent=J(Math.round(r/a.length))}if(to(s),s.config){C.selectedPortConfig=s.config;let r={...C.currentPortData[e]||{},...s.config};$n(r)}}catch(s){console.error("Error loading port history:",s)}}async function Ln(e){C.selectedPort=e,Mn(C.currentPortData);let t=document.getElementById("portDetailPanel");if(!t)return;document.getElementById("portDetailName").textContent=e;let n=C.currentPortData[e]||{};document.getElementById("portDetailCurrent").textContent=J(n.currentMa),document.getElementById("portDetailExpected").textContent=J(n.expectedCurrentMa),kn(n),t.style.display="block",await Ht(e)}function no(){let e=document.getElementById("portDetailPanel");e&&(e.style.display="none"),C.selectedPort=null,C.selectedPortConfig=null}function so(e){e&&e.stopPropagation();let t=document.getElementById("expectedHelpModal");t&&(t.style.display="flex")}function ao(){let e=document.getElementById("expectedHelpModal");e&&(e.style.display="none")}function oo(e){e&&e.stopPropagation();let t=document.getElementById("pageHelpModal");t&&(t.style.display="flex")}function ro(){let e=document.getElementById("pageHelpModal");e&&(e.style.display="none")}function Cn(){ge(),ot(),C.selectedPort&&Ht(C.selectedPort)}function io(){var n;let e=((n=C.config)==null?void 0:n.ports)||16;Sn(e),ge().then(()=>{let s=Object.keys(C.currentPortData);if(s.length>0){let a=C.currentPortData["Port 1"]?"Port 1":s.sort((o,r)=>{let i=parseInt(o.replace(/\D/g,""))||0,l=parseInt(r.replace(/\D/g,""))||0;return i-l})[0];Ln(a)}}).catch(s=>{console.error("Error in initial load:",s)}),ot();let t=0;C.refreshInterval=setInterval(()=>{t++,ge(),t%6===0&&(ot(),C.selectedPort&&Ht(C.selectedPort))},ja)}var Bn={pageId:"efuseMonitorUI",init(e){C.config=e,io()},destroy(){C.refreshInterval&&clearInterval(C.refreshInterval),Object.values(C.charts).forEach(e=>e.destroy()),C={charts:{},currentPortData:{},selectedPort:null,selectedPortConfig:null,refreshInterval:null,chartSkeletonsCreated:!1,lastControlAction:0,confirmModalCallback:null,controlCapabilities:null,config:{}}},refresh:Cn,loadAllData:Cn,loadCurrentData:ge,loadHeatmapData:ot,showPortDetail:Ln,closePortDetail:no,togglePort:Rt,resetFuse:_t,masterControl:Na,resetAllTripped:Wa,toggleSelectedPort:za,resetSelectedPort:Ja,portPowerClick:Ga,showExpectedHelp:so,hideExpectedHelp:ao,showPageHelp:oo,hidePageHelp:ro,showConfirmModal:En,hideConfirmModal:In,executeConfirmAction:vn,confirmModalCallback:vn,showToast:q,formatCurrent:J,getEfuseColor:xn,getEfuseChartColor:wn,downsampleData:ze};var R={controllers:[],isRefreshing:!1,autoRefreshInterval:null,useFahrenheit:!1,configuredHosts:[],config:{}};function Tn(e){return R.useFahrenheit?de(e).toFixed(1)+ee(!0):e.toFixed(1)+ee(!1)}function Pn(e){return e>80?"#f5576c":e>60?"#ffc107":e>40?"#4facfe":"#38ef7d"}function Fn(e){return e>0&&e<11?"warning":e>=11&&e<=13?"good":e>13?"warning":"normal"}function lo(e,t=!1){return`
    <div class="watcher-quick-stats">
      ${[{label:"Firmware",value:e==null?void 0:e.firmware_version},{label:"Mode",value:e==null?void 0:e.mode_name},{label:"Ports",value:e==null?void 0:e.num_ports},{label:"Uptime",value:e==null?void 0:e.uptime}].map(s=>`
        <div class="watcher-quick-stats__item">
          <span class="watcher-quick-stats__label">${s.label}</span>
          ${t?'<span class="watcher-skeleton watcher-skeleton--text watcher-skeleton--text-short" style="display:inline-block;"></span>':`<span class="watcher-quick-stats__value">${m(s.value)}</span>`}
        </div>
      `).join("")}
    </div>
  `}function co(e,t=!1){let n=[{label:"CPU",celsius:e==null?void 0:e.temperature1},{label:"Temp1",celsius:e==null?void 0:e.temperature2},{label:"Temp2",celsius:e==null?void 0:e.temperature3}].filter(s=>s.celsius!==void 0&&s.celsius!==null);return`
    <div class="watcher-section-title"><i class="fas fa-thermometer-half"></i> Temperatures</div>
    <div class="watcher-temp-grid">
      ${(t?[{label:"CPU"},{label:"Temp1"},{label:"Temp2"}]:n).map(s=>{if(t)return`
            <div class="watcher-temp-item">
              <div class="watcher-temp-item__label">${s.label}</div>
              <div class="watcher-skeleton watcher-skeleton--temp"></div>
            </div>
          `;let a=Pn(s.celsius),o=Math.min(s.celsius/100*100,100);return`
          <div class="watcher-temp-item">
            <div class="watcher-temp-item__label">${s.label}</div>
            <div class="watcher-temp-item__value" style="color: ${a};">${Tn(s.celsius)}</div>
            <div class="watcher-temp-item__bar">
              <div class="watcher-temp-item__bar-fill" style="width: ${o}%; background-color: ${a};"></div>
            </div>
          </div>
        `}).join("")}
    </div>
  `}function uo(e,t=!1){if(t)return`
      <div class="watcher-section-title"><i class="fas fa-bolt"></i> Power</div>
      <div class="watcher-voltage-info">
        <div class="watcher-voltage-item">
          <span class="watcher-voltage-item__label">V1</span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:50px;"></span>
        </div>
        <div class="watcher-voltage-item">
          <span class="watcher-voltage-item__label">Input</span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:50px;"></span>
        </div>
      </div>
    `;let n=[];if(e!=null&&e.voltage1&&n.push({label:"V1",value:e.voltage1,status:"normal"}),e!=null&&e.voltage2){let s=e.voltage2.match(/([\d.]+)/),a=s?parseFloat(s[1]):0;n.push({label:"Input",value:e.voltage2,status:Fn(a)})}return n.length===0?"":`
    <div class="watcher-section-title"><i class="fas fa-bolt"></i> Power</div>
    <div class="watcher-voltage-info">
      ${n.map(s=>`
        <div class="watcher-voltage-item">
          <span class="watcher-voltage-item__label">${s.label}</span>
          <span class="watcher-voltage-item__value watcher-voltage-item__value--${s.status}">${m(s.value)}</span>
        </div>
      `).join("")}
    </div>
  `}function po(e,t=!1){return t?`
      <div class="watcher-section-title"><i class="fas fa-lightbulb"></i> Pixels</div>
      <div class="watcher-pixel-info">
        <div class="watcher-pixel-total">
          <span class="watcher-pixel-total__label">Total Pixels</span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;height:1.5em;"></span>
        </div>
        <div class="watcher-pixel-banks">
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;"></span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;"></span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;"></span>
        </div>
      </div>
    `:`
    <div class="watcher-section-title"><i class="fas fa-lightbulb"></i> Pixels</div>
    <div class="watcher-pixel-info">
      <div class="watcher-pixel-total">
        <span class="watcher-pixel-total__label">Total Pixels</span>
        <span class="watcher-pixel-total__value">${((e.pixels_bank0||0)+(e.pixels_bank1||0)+(e.pixels_bank2||0)).toLocaleString()}</span>
      </div>
      <div class="watcher-pixel-banks">
        <span class="watcher-pixel-bank">Bank 0: ${(e.pixels_bank0||0).toLocaleString()}</span>
        <span class="watcher-pixel-bank">Bank 1: ${(e.pixels_bank1||0).toLocaleString()}</span>
        <span class="watcher-pixel-bank">Bank 2: ${(e.pixels_bank2||0).toLocaleString()}</span>
      </div>
    </div>
  `}function fo(e,t,n=!1){return`
    <div class="watcher-details">
      <div class="watcher-details__row">
        <span class="watcher-details__label">IP Address</span>
        <a href="http://${m(e)}/" target="_blank" class="watcher-details__value watcher-details__link">${m(e)}</a>
      </div>
      <div class="watcher-details__row">
        <span class="watcher-details__label">Controller Time</span>
        ${n?'<span class="watcher-skeleton watcher-skeleton--text watcher-skeleton--text-medium" style="display:inline-block;"></span>':`<span class="watcher-details__value">${m((t==null?void 0:t.time)||"")} ${m((t==null?void 0:t.date)||"")}</span>`}
      </div>
    </div>
  `}function mo(e,t,n=!1){var i,l,c;if(n)return`
      <div class="watcher-card__footer">
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
      </div>
    `;let s=(i=t.testMode)!=null&&i.enabled?"active":"",a=(l=t.testMode)!=null&&l.enabled?"Test mode is ON - Click to disable":"Click to enable test mode",r=((c=t.status)==null?void 0:c.product_code)===130?`
    <div class="watcher-card__footer-row watcher-fuse-controls">
      <button class="btn btn-sm btn-outline-success" onclick="page.setFuses(${e}, true)" title="Enable all fuses">
        <i class="fas fa-bolt"></i> Fuses On
      </button>
      <button class="btn btn-sm btn-outline-secondary" onclick="page.setFuses(${e}, false)" title="Disable all fuses">
        <i class="fas fa-bolt"></i> Fuses Off
      </button>
      <button class="btn btn-sm btn-outline-info" onclick="page.resetFuses(${e})" title="Reset all tripped fuses">
        <i class="fas fa-redo"></i> Reset Fuses
      </button>
    </div>
  `:"";return`
    <div class="watcher-card__footer">
      <a href="http://${m(t.host)}/" target="_blank" class="btn btn-sm btn-outline-primary">
        <i class="fas fa-external-link-alt"></i> Web UI
      </a>
      <button class="btn btn-sm btn-outline-warning watcher-test-btn ${s}"
              onclick="page.toggleTestMode(${e})" title="${a}">
        <i class="fas fa-lightbulb"></i> Test
      </button>
      <button class="btn btn-sm btn-outline-danger" onclick="page.rebootController(${e})" title="Reboot controller">
        <i class="fas fa-power-off"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" onclick="page.refreshController(${e})">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
    ${r}
  `}function Je(e,t,n=!1){let s=document.createElement("div"),a=e.host||e,o=n?null:e.online,r=e.status,i="watcher-card",l="watcher-card__header",c="fa-microchip",d="";if(n?(l+=" watcher-card__header--loading",c="fa-spinner fa-spin",d='<span class="watcher-skeleton watcher-skeleton--badge"></span>'):o?d=`<span class="watcher-card__badge watcher-card__badge--online">${m((r==null?void 0:r.model)||"")}</span>`:(i+=" watcher-card--offline",l+=" watcher-card__header--offline",c="fa-times-circle",d='<span class="watcher-card__badge watcher-card__badge--offline">Offline</span>'),s.className=i,s.id="controller-"+t,!n&&!o)return s.innerHTML=`
      <div class="${l}">
        <div class="watcher-card__title"><i class="fas ${c}"></i> ${m(a)}</div>
        ${d}
      </div>
      <div class="watcher-card__body watcher-card__body--offline">
        <i class="fas fa-plug"></i>
        <p>Controller not responding</p>
        <small>${m(e.error||"Connection failed")}</small>
      </div>
    `,s;let u=n?a:(r==null?void 0:r.name)||a;return s.innerHTML=`
    <div class="${l}">
      <div class="watcher-card__title"><i class="fas ${c}"></i> ${m(u)}</div>
      ${d}
    </div>
    <div class="watcher-card__body">
      ${lo(r,n)}
      ${co(r,n)}
      ${uo(r,n)}
      ${po(r,n)}
      ${fo(a,r,n)}
    </div>
    ${mo(t,e,n)}
  `,s}function Rn(){document.getElementById("configPanel").classList.toggle("visible")}function go(){document.getElementById("discoveryResults").classList.remove("visible")}async function ho(){let e=document.getElementById("falconHosts").value;try{(await fetch("/api/plugin/fpp-plugin-watcher/falcon/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hosts:e})})).ok?(Rn(),it()):alert("Failed to save configuration")}catch(t){console.error("Error saving configuration:",t),alert("Error saving configuration")}}function yo(e){let t=document.getElementById("controllersGrid");document.getElementById("loadingIndicator").style.display="none",document.getElementById("noControllersMessage").style.display="none",t.style.display="grid",t.innerHTML="",e.forEach((n,s)=>{t.appendChild(Je({host:n},s,!0))})}function vo(){let e=document.getElementById("controllersGrid");e.innerHTML="",R.controllers.forEach((t,n)=>{e.appendChild(Je(t,n,!1))})}async function it(e=!0){var a,o;if(R.isRefreshing)return;R.isRefreshing=!0;let t=document.querySelector(".refreshButton i");t&&(t.style.animation="spin 1s linear infinite");let s=document.getElementById("controllersGrid").querySelector(".watcher-skeleton")!==null;e&&!s&&(document.getElementById("loadingIndicator").style.display="block",document.getElementById("controllersGrid").style.display="none",document.getElementById("noControllersMessage").style.display="none");try{let i=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/status")).json();if(i.success&&((a=i.controllers)==null?void 0:a.length)>0)R.controllers=i.controllers,vo(),document.getElementById("controllersGrid").style.display="grid",document.getElementById("noControllersMessage").style.display="none";else if(((o=i.controllers)==null?void 0:o.length)===0)document.getElementById("noControllersMessage").style.display="block",document.getElementById("controllersGrid").style.display="none";else throw new Error(i.error||"Failed to load controllers");document.getElementById("loadingIndicator").style.display="none",document.getElementById("lastUpdate").textContent="Last updated: "+new Date().toLocaleTimeString()}catch(r){console.error("Error loading controllers:",r),s||(document.getElementById("loadingIndicator").innerHTML=`
        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
        <p style="color: #dc3545;">Error loading controllers</p>
        <button class="btn btn-primary" onclick="watcher.pages.falconMonitor.loadAllControllers()">Retry</button>
      `)}finally{R.isRefreshing=!1,t&&(t.style.animation="")}}async function Dt(e){var a;let t=R.controllers[e];if(!t)return;let n=document.getElementById("controller-"+e);n&&(n.style.opacity="0.5");try{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/status?host="+encodeURIComponent(t.host))).json();if(r.success&&((a=r.controllers)==null?void 0:a.length)>0){R.controllers[e]=r.controllers[0];let i=Je(R.controllers[e],e,!1);n.replaceWith(i);return}}catch(o){console.error("Error refreshing controller:",o)}let s=document.getElementById("controller-"+e);s&&(s.style.opacity="1")}async function bo(e){let t=R.controllers[e];if(!(t!=null&&t.online))return;let n=document.getElementById("controller-"+e),s=n==null?void 0:n.querySelector(".watcher-test-btn");await me(s,"fas fa-lightbulb",async()=>{var i;let a=((i=t.testMode)==null?void 0:i.enabled)||!1,r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:t.host,enable:!a,testMode:5})})).json();r.success?(t.testMode||(t.testMode={enabled:!1,mode:0}),t.testMode.enabled=r.testEnabled,s==null||s.classList.toggle("active",r.testEnabled),s&&(s.title=r.testEnabled?"Test mode is ON - Click to disable":"Click to enable test mode")):alert("Failed to toggle test mode: "+(r.error||"Unknown error"))})}async function Co(e){var a;let t=R.controllers[e];if(!(t!=null&&t.online)||!confirm(`Are you sure you want to reboot ${((a=t.status)==null?void 0:a.name)||t.host}?`))return;let n=document.getElementById("controller-"+e),s=n==null?void 0:n.querySelector(".btn-outline-danger");await me(s,"fas fa-power-off",async()=>{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:t.host})})).json();r.success?(t.online=!1,n.replaceWith(Je(t,e,!1))):alert("Failed to reboot: "+(r.error||"Unknown error"))})}async function wo(e,t){var r;let n=R.controllers[e];if(!(n!=null&&n.online))return;let s=t?"enable":"disable";if(!confirm(`Are you sure you want to ${s} all fuses on ${((r=n.status)==null?void 0:r.name)||n.host}?`))return;let a=document.getElementById("controller-"+e),o=a==null?void 0:a.querySelector(t?".btn-outline-success":".watcher-fuse-controls .btn-outline-secondary");await me(o,"fas fa-bolt",async()=>{let l=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/fuses/master",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:n.host,enable:t})})).json();l.success?Dt(e):alert("Failed to "+s+" fuses: "+(l.error||"Unknown error"))})}async function xo(e){var a;let t=R.controllers[e];if(!(t!=null&&t.online)||!confirm(`Reset all fuses on ${((a=t.status)==null?void 0:a.name)||t.host}?`))return;let n=document.getElementById("controller-"+e),s=n==null?void 0:n.querySelector(".btn-outline-info");await me(s,"fas fa-redo",async()=>{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/fuses/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:t.host})})).json();r.success?Dt(e):alert("Failed to reset fuses: "+(r.error||"Unknown error"))})}async function Eo(){let e=document.querySelector('button[onclick*="discoverControllers"]'),t=document.getElementById("discoveryResults"),n=document.getElementById("discoveryList");n.innerHTML='<div style="text-align:center;padding:1rem;"><i class="fas fa-spinner fa-spin"></i> Scanning network...<br><small style="color:#6c757d;">This may take a few minutes</small></div>',t.classList.add("visible");let s="",a=window.location.hostname.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3})\.\d{1,3}$/);a&&(s=a[1]),await me(e,"fas fa-search",async()=>{var o;try{let r="/api/plugin/fpp-plugin-watcher/falcon/discover"+(s?"?subnet="+s:""),l=await(await fetch(r)).json();l.success&&((o=l.controllers)==null?void 0:o.length)>0?(n.innerHTML=`
          <div style="margin-bottom:0.5rem;color:#6c757d;font-size:0.875rem;">
            Found ${l.count} controller(s) on subnet ${m(l.subnet)}
          </div>
          <div style="display:flex;flex-direction:column;gap:0.5rem;">
            ${l.controllers.map(c=>`
              <div class="watcher-discovery-item">
                <div>
                  <strong>${m(c.name||c.ip)}</strong>
                  ${c.model?`<span style="color:#6c757d;font-size:0.875rem;">(${m(c.model)})</span>`:""}
                  <br><small style="color:#6c757d;">${m(c.ip)}${c.firmware?` - FW: ${m(c.firmware)}`:""}</small>
                </div>
                <button class="btn btn-sm btn-outline-primary watcher-add-controller-btn" data-ip="${m(c.ip)}">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
            `).join("")}
          </div>
          <div style="margin-top:0.75rem;">
            <button class="btn btn-sm btn-primary" onclick="watcher.pages.falconMonitor.addAllDiscoveredControllers()">
              <i class="fas fa-plus-circle"></i> Add All
            </button>
          </div>
        `,n.querySelectorAll(".watcher-add-controller-btn").forEach(c=>{c.addEventListener("click",()=>At(c.dataset.ip))})):l.success?n.innerHTML=`<div style="text-align:center;padding:1rem;color:#6c757d;"><i class="fas fa-info-circle"></i> No Falcon controllers found on subnet ${m(l.subnet)}</div>`:n.innerHTML=`<div style="text-align:center;padding:1rem;color:#dc3545;"><i class="fas fa-exclamation-triangle"></i> ${m(l.error||"Discovery failed")}</div>`}catch(r){console.error("Error discovering controllers:",r),n.innerHTML='<div style="text-align:center;padding:1rem;color:#dc3545;"><i class="fas fa-exclamation-triangle"></i> Error during discovery</div>'}})}function At(e){let t=document.getElementById("falconHosts"),n=t.value.split(",").map(s=>s.trim()).filter(s=>s);n.includes(e)||(n.push(e),t.value=n.join(", "))}function Io(){document.querySelectorAll("#discoveryList .watcher-add-controller-btn").forEach(e=>{e.dataset.ip&&At(e.dataset.ip)})}async function So(){R.configuredHosts.length>0&&yo(R.configuredHosts);try{let t=await(await fetch("/api/settings/temperatureInF")).json();R.useFahrenheit=t.value==="1"||t.value===1}catch(e){console.warn("Could not fetch temperature setting")}it(),R.autoRefreshInterval=setInterval(()=>it(!1),3e4),window.addEventListener("beforeunload",()=>{R.autoRefreshInterval&&(clearInterval(R.autoRefreshInterval),R.autoRefreshInterval=null)})}var _n={pageId:"falconMonitorUI",init(e){R.config=e,R.configuredHosts=e.configuredHosts||[],So()},destroy(){R.autoRefreshInterval&&clearInterval(R.autoRefreshInterval),R={controllers:[],isRefreshing:!1,autoRefreshInterval:null,useFahrenheit:!1,configuredHosts:[],config:{}}},loadAllControllers:it,refreshController:Dt,toggleTestMode:bo,rebootController:Co,setFuses:wo,resetFuses:xo,discoverControllers:Eo,addDiscoveredController:At,addAllDiscoveredControllers:Io,toggleConfig:Rn,hideDiscoveryResults:go,saveConfiguration:ho,formatTemperature:Tn,getTempColor:Pn,getVoltageStatus:Fn,createControllerCard:Je};var ue={isPlayerMode:!1,watcherEditorOriginalContent:"",config:{}};function Hn(e,t,n){let a=3600/e*6,o=50+18*n,r=a*o,i=t*86400,l=Math.min(360,Math.floor(i/60)),c=Math.min(576,Math.floor(i/300)),d=Math.min(672,Math.floor(i/1800)),u=Math.floor(i/7200),f=50+80*n,h=(l+c+d+u)*f;return r+h}function Ut(){let e=document.getElementById("efuseCollectionInterval"),t=document.getElementById("efuseRetentionDays"),n=document.getElementById("efuseStorageEstimate");if(!e||!t||!n)return;let s=parseInt(e.value),a=parseInt(t.value),o=[4,8,16,32],r='<div class="storageEstimateTitle"><i class="fas fa-hdd"></i> Estimated Storage</div>';r+='<div class="storageEstimateGrid">',o.forEach(i=>{let l=Hn(s,a,i);r+=`<div class="storageEstimateItem">
      <span class="storageEstimatePorts">${i} ports</span>
      <span class="storageEstimateSize">${Y(l)}</span>
    </div>`}),r+="</div>",n.innerHTML=r}function $o(){let e=document.getElementById("efuseMonitorEnabled"),t=document.getElementById("efuseOptionsContainer");e&&t&&(t.style.display=e.checked?"":"none",e.checked&&Ut())}function Dn(e,t,n=4){let a=3600/e*6,o=40+n*18,r=a*o,i=t*86400,l=60+n*55,c=Math.min(360,Math.floor(i/60)),d=t>1?Math.min(576,Math.floor(i/300)):0,u=t>3?Math.min(336,Math.floor(i/1800)):0,f=t>7?Math.floor(i/7200):0,h=(c+d+u+f)*l;return r+h+150}function Ot(){let e=document.getElementById("voltageCollectionInterval"),t=document.getElementById("voltageRetentionDays"),n=document.getElementById("voltageStorageEstimate");if(!e||!t||!n)return;let s=parseInt(e.value),a=parseInt(t.value),o=ue.config.voltageRailCount||4,r=Dn(s,a,o),i=Math.floor(60/s),l=Math.floor(60/s)*60*24,c="1min";a>1&&(c+=", 5min"),a>3&&(c+=", 30min"),a>7&&(c+=", 2hour");let d=o>=13?"Pi 5 (PMIC)":"Pi 4/earlier",u='<div class="storageEstimateTitle"><i class="fas fa-hdd"></i> Storage Estimate</div>';u+='<div class="storageEstimateGrid">',u+=`<div class="storageEstimateItem">
    <span class="storageEstimatePorts">${a} day${a>1?"s":""} data</span>
    <span class="storageEstimateSize">${Y(r)}</span>
  </div>`,u+=`<div class="storageEstimateItem">
    <span class="storageEstimatePorts">${i} samples/min</span>
    <span class="storageEstimateSize">${l.toLocaleString()} readings/day</span>
  </div>`,u+="</div>",u+=`<div class="storageEstimateNote" style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem;">${d} (${o} rails) | Rollup tiers: ${c}</div>`,n.innerHTML=u}function ko(){let e=document.getElementById("voltageMonitorEnabled"),t=document.getElementById("voltageOptionsContainer");e&&t&&(t.style.display=e.checked?"":"none",e.checked&&Ot())}function Mo(e){e.closest(".settingsPanel").classList.toggle("collapsed")}function Lo(e){e.key==="Enter"&&(e.preventDefault(),An())}function An(){let e=document.getElementById("newHostInput"),t=e.value.trim();if(!t)return;if(Array.from(document.querySelectorAll('input[name="testHosts[]"]')).map(o=>o.value).includes(t)){alert("This host is already in the list");return}let s=document.getElementById("testHostsContainer"),a=document.createElement("span");a.className="tag",a.innerHTML=`
    ${m(t)}
    <i class="fas fa-times tagRemove" onclick="page.watcherRemoveTag(this)"></i>
    <input type="hidden" name="testHosts[]" value="${m(t)}">
  `,s.insertBefore(a,e),e.value=""}function Bo(e){e.closest(".tag").remove()}async function To(){let e=document.getElementById("clearResetStateBtn"),t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Clearing...';try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/connectivity/state/clear",{method:"POST",headers:{"Content-Type":"application/json"}})).json();s.success?window.location.reload():(alert("Failed to clear reset state: "+(s.error||"Unknown error")),e.disabled=!1,e.innerHTML=t)}catch(n){alert("Error clearing reset state: "+n.message),e.disabled=!1,e.innerHTML=t}}async function lt(){let e=document.getElementById("dataStatsContainer");try{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/data/stats")).json();if(!n.success){e.innerHTML='<div class="dataStatsError">Failed to load data statistics</div>';return}let s='<div class="dataAccordion">',a=0,o=0;for(let[r,i]of Object.entries(n.categories)){if(i.playerOnly&&!ue.isPlayerMode)continue;a+=i.totalSize,o+=i.fileCount;let l=i.fileCount>0,c=i.showFiles!==!1,d=l&&c,u=d?"expandable":"",f=i.warning?"expanded":"";if(s+=`<div class="dataAccordionItem ${f}" data-category="${m(r)}">
        <div class="dataAccordionHeader ${u}" onclick="${d?"page.toggleDataAccordion(this)":""}">
          <div class="dataAccordionTitle">
            ${d?'<i class="fas fa-chevron-right dataAccordionChevron"></i>':'<i class="fas fa-database dataAccordionIcon"></i>'}
            <strong>${m(i.name)}</strong>
            <span class="dataAccordionBadge">${i.fileCount} file${i.fileCount!==1?"s":""}</span>
            <span class="dataAccordionSize">${Y(i.totalSize)}</span>
          </div>
          <div class="dataAccordionActions">
            <button type="button" class="buttons btn-sm btn-outline-danger"
              onclick="event.stopPropagation(); page.clearDataCategory('${m(r)}', '${m(i.name)}')"
              ${l?"":"disabled"}>
              <i class="fas fa-trash"></i> Clear All
            </button>
          </div>
        </div>`,d||i.warning){if(s+='<div class="dataAccordionBody">',s+=`<div class="dataAccordionDesc">${m(i.description)}</div>`,i.warning&&(s+=`<div class="dataWarningInline"><i class="fas fa-info-circle"></i> ${m(i.warning)}</div>`),c&&l){let h=[...i.files].sort((p,y)=>y.modified-p.modified);s+='<div class="dataFileList">';for(let p of h){let y=new Date(p.modified*1e3).toLocaleString(),w=p.name.endsWith(".log")||p.name.endsWith(".json");s+=`<div class="dataFileItem">
              <div class="dataFileInfo">
                <i class="fas fa-file dataFileIcon"></i>
                <span class="dataFileName">${m(p.name)}</span>
                <span class="dataFileMeta">${Y(p.size)} &bull; ${y}</span>
              </div>
              <div class="dataFileActions">
                ${w?`<button type="button" class="buttons btn-xs btn-outline-secondary"
                  onclick="page.viewDataFile('${m(r)}', '${m(p.name)}')"
                  title="View file contents">
                  <i class="fas fa-eye"></i>
                </button>`:""}
                <button type="button" class="buttons btn-xs btn-outline-danger"
                  onclick="page.clearDataFile('${m(r)}', '${m(p.name)}')"
                  title="Delete file">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>`}s+="</div>"}else c&&!l&&(s+='<div class="dataEmptyMessage"><i class="fas fa-check-circle"></i> No data files</div>');s+="</div>"}s+="</div>"}s+=`</div>
      <div class="dataTotalRow">
        <strong>Total:</strong> ${o} files &bull; ${Y(a)}
      </div>`,e.innerHTML=s}catch(t){e.innerHTML='<div class="dataStatsError">Error loading data statistics: '+m(t.message)+"</div>"}}function Po(e){e.closest(".dataAccordionItem").classList.toggle("expanded")}async function Fo(e,t){var n;if(confirm(`Are you sure you want to clear all ${t} data?

This action cannot be undone.`))try{let a=await(await fetch(`/api/plugin/fpp-plugin-watcher/data/${encodeURIComponent(e)}`,{method:"DELETE"})).json();a.success?lt():alert("Failed to clear data: "+(((n=a.errors)==null?void 0:n.join(", "))||"Unknown error"))}catch(s){alert("Error clearing data: "+s.message)}}async function Ro(e,t){if(confirm(`Delete "${t}"?

This action cannot be undone.`))try{let s=await(await fetch(`/api/plugin/fpp-plugin-watcher/data/${encodeURIComponent(e)}/${encodeURIComponent(t)}`,{method:"DELETE"})).json();s.success?lt():alert("Failed to delete file: "+(s.error||"Unknown error"))}catch(n){alert("Error deleting file: "+n.message)}}async function _o(e,t){let n=document.getElementById("terminalModal"),s=document.getElementById("terminalModalTitle"),a=document.getElementById("terminalContent");n.dataset.category=e,n.dataset.filename=t,s.textContent=t,a.textContent="Loading...",n.style.display="flex",await Un()}async function Un(){let e=document.getElementById("terminalModal"),t=document.getElementById("terminalContent"),n=e.dataset.category,s=e.dataset.filename;try{let o=await(await fetch(`/api/plugin/fpp-plugin-watcher/data/${encodeURIComponent(n)}/${encodeURIComponent(s)}/tail?lines=100`)).json();o.success?(t.textContent=o.content||"(empty file)",t.scrollTop=t.scrollHeight):t.textContent="Error: "+(o.error||"Failed to load file")}catch(a){t.textContent="Error: "+a.message}}function On(){document.getElementById("terminalModal").style.display="none"}async function Ho(){let e=document.getElementById("collectdViewerModal"),t=document.getElementById("collectdViewerContent");t.textContent="Loading...",e.style.display="flex";try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/config/collectd")).json();s.success?t.textContent=s.content||"(empty file)":t.textContent="Error: "+(s.error||"Failed to load configuration")}catch(n){t.textContent="Error: "+n.message}}function Vn(){document.getElementById("collectdViewerModal").style.display="none"}async function Do(){let e=document.getElementById("watcherEditorModal"),t=document.getElementById("watcherEditorContent"),n=document.getElementById("watcherEditorStatus");t.value="Loading...",n.textContent="",n.className="configEditorStatus",e.style.display="flex";try{let a=await(await fetch("/api/plugin/fpp-plugin-watcher/config/watcher")).json();a.success?(t.value=a.content,ue.watcherEditorOriginalContent=a.content):(t.value="Error: "+(a.error||"Failed to load configuration"),n.textContent="Load failed",n.className="configEditorStatus error")}catch(s){t.value="Error: "+s.message,n.textContent="Load failed",n.className="configEditorStatus error"}}async function Ao(){let e=document.getElementById("watcherEditorContent"),t=document.getElementById("saveWatcherBtn"),n=document.getElementById("watcherEditorStatus"),s=e.value;if(s===ue.watcherEditorOriginalContent){n.textContent="No changes to save",n.className="configEditorStatus";return}let a=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...',n.textContent="",n.className="configEditorStatus";try{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/config/watcher",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:s})})).json();r.success?(ue.watcherEditorOriginalContent=s,n.textContent="Saved! Some changes may require FPP restart.",n.className="configEditorStatus"):(n.textContent="Error: "+(r.error||"Failed to save"),n.className="configEditorStatus error")}catch(o){n.textContent="Error: "+o.message,n.className="configEditorStatus error"}finally{t.disabled=!1,t.innerHTML=a}}function jn(){let e=document.getElementById("watcherEditorModal");document.getElementById("watcherEditorContent").value!==ue.watcherEditorOriginalContent&&!confirm("You have unsaved changes. Are you sure you want to close?")||(e.style.display="none")}function qn(e){return document.querySelectorAll('input[name="testHosts[]"]').length===0?(e.preventDefault(),alert("Please add at least one test host"),!1):!0}function Uo(){document.addEventListener("keydown",function(e){if(e.key==="Escape"){let t=document.getElementById("terminalModal"),n=document.getElementById("collectdViewerModal"),s=document.getElementById("watcherEditorModal");s&&s.style.display==="flex"?jn():n&&n.style.display==="flex"?Vn():t&&t.style.display==="flex"&&On()}})}function Oo(){let e=document.querySelector(".settingsPanel:has(#dataStatsContainer)");e&&new MutationObserver(function(n){n.forEach(function(s){s.type==="attributes"&&s.attributeName==="class"&&(e.classList.contains("collapsed")||lt())})}).observe(e,{attributes:!0})}function Vo(){Ut(),Ot();let e=document.getElementById("watcherSettingsForm");e&&e.addEventListener("submit",qn),Uo(),Oo()}var Nn={pageId:"configUI",init(e){ue.config=e,ue.isPlayerMode=e.isPlayerMode||!1,Vo()},destroy(){ue={isPlayerMode:!1,watcherEditorOriginalContent:"",config:{}}},calculateEfuseStorage:Hn,updateEfuseStorageEstimate:Ut,toggleEfuseOptions:$o,calculateVoltageStorage:Dn,updateVoltageStorageEstimate:Ot,toggleVoltageOptions:ko,watcherTogglePanel:Mo,watcherHandleTagKeypress:Lo,watcherAddTag:An,watcherRemoveTag:Bo,clearResetState:To,loadDataStats:lt,toggleDataAccordion:Po,clearDataCategory:Fo,clearDataFile:Ro,viewDataFile:_o,refreshTerminalContent:Un,closeTerminalModal:On,viewCollectdConfig:Ho,closeCollectdViewer:Vn,openWatcherEditor:Do,saveWatcherConfig:Ao,closeWatcherEditor:jn,validateForm:qn};var U={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,config:{}},Jn=()=>{var e;return((e=document.getElementById("timeRange"))==null?void 0:e.value)||"12"},Wn=()=>{var e;return((e=document.getElementById("voltageTimeRange"))==null?void 0:e.value)||"12"},dt=()=>{var e;return((e=U.config)==null?void 0:e.defaultAdapter)||"default"},jo=()=>{var e;return((e=document.getElementById("interfaceSelect"))==null?void 0:e.value)||dt()},zn=()=>{var e;return((e=document.getElementById("wirelessInterfaceSelect"))==null?void 0:e.value)||"wlan0"};async function qo(){try{U.useFahrenheit=await Be();let e=await T("/api/system/status");No(e),Wo(e)}catch(e){console.error("Error loading system status:",e)}}function No(e){var s;let t=document.getElementById("temperatureStatusBar");if(!t)return;let n=((s=e==null?void 0:e.sensors)==null?void 0:s.filter(a=>a.valueType==="Temperature"))||[];if(!n.length){t.style.display="none";return}t.innerHTML=n.map((a,o)=>{let r=parseFloat(a.value)||0,i=Ye(r),l=Math.min(r,100),c=a.label.replace(":","").trim(),d=ke(r,U.useFahrenheit);return`<div${o<n.length-1?' style="margin-bottom: 1.5rem;"':""}>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-thermometer-half" style="color: ${i.color};"></i><strong>${m(c)}</strong>
                </div>
                <span style="font-size: 1.5rem; font-weight: bold; color: ${i.color};">${d}</span>
            </div>
            <div class="progressBar" style="background-color: #e9ecef; height: 24px; border-radius: 4px; overflow: hidden;">
                <div style="width: ${l}%; height: 100%; background: ${i.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; font-weight: 500;">${d}</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: #6c757d;">
                <span>${ke(0,U.useFahrenheit)}</span><span>Status: ${i.icon} ${i.text}</span><span>${ke(100,U.useFahrenheit)}</span>
            </div>
        </div>`}).join(""),t.style.display="block"}function Wo(e){var l,c,d;let t=document.getElementById("diskStatusBar");if(!t)return;let n=(d=(c=(l=e==null?void 0:e.advancedView)==null?void 0:l.Utilization)==null?void 0:c.Disk)==null?void 0:d.Root;if(!n){t.style.display="none";return}let{Free:s=0,Total:a=1}=n,o=a-s,r=o/a*100,i=r>90?"#f5576c":r>75?"#ffc107":"#38ef7d";t.innerHTML=`<div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <strong>Root Filesystem</strong><span style="font-weight: 500;">${Y(o)} / ${Y(a)}</span>
        </div>
        <div class="progressBar" style="background-color: #e9ecef; height: 24px; border-radius: 4px; overflow: hidden;">
            <div style="width: ${r}%; height: 100%; background: ${i}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; font-weight: 500;">${r.toFixed(1)}% Used</div>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6c757d;">
            <i class="fas fa-check-circle" style="color: #28a745;"></i> Available: ${Y(s)}
        </div>
    </div>`,t.style.display="block"}var Gn=[{key:"memory",canvasId:"memoryChart",loadingId:"memoryLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/memory/free?hours=${e}`,prepare:e=>{var l;if(!(e!=null&&e.success)||!((l=e.data)!=null&&l.length))return null;let t=e.data.filter(c=>c.free_mb!==null).map(c=>c.free_mb),n=e.data.filter(c=>c.buffer_cache_mb!==null).map(c=>c.buffer_cache_mb);if(!t.length)return null;let s=document.getElementById("currentMemory"),a=document.getElementById("avgMemory"),o=document.getElementById("currentBufferCache"),r=document.getElementById("avgBufferCache");s&&(s.textContent=t.at(-1).toFixed(1)+" MB"),a&&(a.textContent=(t.reduce((c,d)=>c+d)/t.length).toFixed(1)+" MB"),n.length&&o&&(o.textContent=n.at(-1).toFixed(1)+" MB",r&&(r.textContent=(n.reduce((c,d)=>c+d)/n.length).toFixed(1)+" MB"));let i=[M("Free Memory",H(e,"free_mb"),"purple")];return n.length&&i.push(M("Buffer Cache",H(e,"buffer_cache_mb"),"teal",{fill:!1})),{datasets:i,opts:{yLabel:"Memory (MB)",yTickFormatter:c=>c.toFixed(0)+" MB",tooltipLabel:c=>c.dataset.label+": "+c.parsed.y.toFixed(1)+" MB"}}}},{key:"cpu",canvasId:"cpuChart",loadingId:"cpuLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/cpu/average?hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[M("CPU Usage (%)",H(e,"cpu_usage"),"red")],opts:{yLabel:"CPU Usage (%)",beginAtZero:!0,yMax:100,yTickFormatter:n=>n.toFixed(0)+"%",tooltipLabel:n=>"CPU Usage: "+n.parsed.y.toFixed(2)+"%"}}}},{key:"load",canvasId:"loadChart",loadingId:"loadLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/load/average?hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[M("1 min",H(e,"shortterm"),"coral",{fill:!1}),M("5 min",H(e,"midterm"),"orange",{fill:!1}),M("15 min",H(e,"longterm"),"teal",{fill:!1})],opts:{yLabel:"Load Average",beginAtZero:!0,yTickFormatter:n=>n.toFixed(2),tooltipLabel:n=>n.dataset.label+" Load: "+n.parsed.y.toFixed(2)}}}},{key:"disk",canvasId:"diskChart",loadingId:"diskLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/disk/free?hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[M("Free Space (GB)",H(e,"free_gb"),"green")],opts:{yLabel:"Free Space (GB)",yTickFormatter:n=>n.toFixed(1)+" GB",tooltipLabel:n=>"Free Space: "+n.parsed.y.toFixed(2)+" GB"}}}},{key:"network",canvasId:"networkChart",loadingId:"networkLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/interface/bandwidth?interface=${jo()}&hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[M("Download (RX)",H(e,"rx_kbps"),"blue"),M("Upload (TX)",H(e,"tx_kbps"),"pink")],opts:{yLabel:"Bandwidth (Kbps)",beginAtZero:!0,yTickFormatter:n=>n.toFixed(0)+" Kbps",tooltipLabel:n=>n.dataset.label+": "+n.parsed.y.toFixed(2)+" Kbps"}}}},{key:"thermal",canvasId:"thermalChart",cardId:"thermalCard",loadingId:"thermalLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/thermal?hours=${e}`,prepare:e=>{var o,r;if(!(e!=null&&e.success)||!((o=e.data)!=null&&o.length)||!((r=e.zones)!=null&&r.length))return{hidden:!0};let t=["coral","blue","yellow","teal","indigo","orange","green","pink"],n=ee(U.useFahrenheit),s=(i,l)=>H(i,l).map(c=>({x:c.x,y:U.useFahrenheit?de(c.y):c.y})),a=i=>{var l;return Me(((l=e.zone_names)==null?void 0:l[i])||i)};return{datasets:e.zones.map((i,l)=>M(a(i),s(e,i),t[l%t.length],{fill:!1})),opts:{yLabel:`Temperature (${n})`,yTickFormatter:i=>i.toFixed(0)+n,tooltipLabel:i=>i.dataset.label+": "+i.parsed.y.toFixed(1)+n}}}},{key:"voltage",canvasId:"voltageChart",cardId:"voltageCard",loadingId:"voltageLoading",statsBarId:"voltageStatsBar",getHours:Wn,url:()=>`/api/plugin/fpp-plugin-watcher/voltage/history?hours=${Wn()}`,prepare:e=>{var S;if(!(e!=null&&e.success)||!((S=e.data)!=null&&S.length))return z("voltageCard"),z("voltageStatsBar"),{hidden:!0};G("voltageCard");let t=document.getElementById("voltageStatsBar");t&&(t.style.display="flex");let n=e.rails||[],s=e.labels||{},a={EXT5V_V:"green",VDD_CORE_V:"coral",HDMI_V:"orange","3V7_WL_SW_V":"pink","3V3_SYS_V":"blue","3V3_DAC_V":"indigo","3V3_ADC_V":"cyan","1V8_SYS_V":"purple","1V1_SYS_V":"magenta",DDR_VDD2_V:"teal",DDR_VDDQ_V:"lime","0V8_SW_V":"yellow","0V8_AON_V":"brown",core:"coral",sdram_c:"blue",sdram_i:"purple",sdram_p:"teal"},r=n.includes("EXT5V_V")?["EXT5V_V","VDD_CORE_V","3V3_SYS_V","1V8_SYS_V"]:["core","sdram_c","sdram_i","sdram_p"],i=(x,v)=>{let b=document.getElementById(x);b&&(b.textContent=v)},l=e.data.at(-1);r.forEach((x,v)=>{let b=document.getElementById(`voltageStat${v}Label`);if(b&&(b.textContent=s[x]||x),l){let E=l.voltages||{};if(E[x]!==void 0){let B=typeof E[x]=="object"?E[x].avg:E[x];i(`voltageStat${v}`,B.toFixed(3)+" V")}}});let c=document.getElementById("voltageStatusBar");if(c){let x=e.data.map(v=>{var E;let b=(E=v.voltages)==null?void 0:E.EXT5V_V;return b===void 0?null:typeof b=="object"?b.avg:b}).filter(v=>v!=null);if(x.length>=10){let v=x.reduce((B,$)=>B+$)/x.length,b=Math.min(...x),E=(v-b)/v*100;E>3?(c.style.display="block",c.innerHTML=`<div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
              <span><strong>Power Supply Issue:</strong> ${E.toFixed(1)}% voltage drop on 5V input (${b.toFixed(2)}V min vs ${v.toFixed(2)}V avg). Check your power supply.</span>
            </div>`):c.style.display="none"}else c.style.display="none"}let d=[],u=1/0,f=-1/0;for(let x of n){let v=e.data.map($=>{var I;let D=(I=$.voltages)==null?void 0:I[x];if(D===void 0)return null;let L=typeof D=="object"?D.avg:D;return{x:$.timestamp*1e3,y:L}}).filter($=>$!==null);if(v.length===0)continue;let b=v.map($=>$.y);u=Math.min(u,...b),f=Math.max(f,...b);let E=a[x]||"yellow",B=s[x]||x;d.push(M(B,v,E,{fill:!1}))}if(d.length===0)return{hidden:!0};let h=f-u,p=Math.max(h*.1,.1),y=Math.floor((u-p)*10)/10,w=Math.ceil((f+p)*10)/10;return{datasets:d,opts:{yLabel:"Voltage (V)",yMin:Math.max(0,y),yMax:w,yTickFormatter:x=>x.toFixed(1)+" V",tooltipLabel:x=>x.dataset.label+": "+x.parsed.y.toFixed(3)+" V"}}}},{key:"wireless",canvasId:"wirelessChart",cardId:"wirelessCard",loadingId:"wirelessLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/wireless?interface=${zn()}&hours=${e}`,prepare:e=>{var o,r,i;if(!(e!=null&&e.success)||!((o=e.data)!=null&&o.length)||!((r=e.interfaces)!=null&&r.length))return{hidden:!0};let t=zn(),n=e.interfaces.includes(t)?t:e.interfaces[0],s={signal_quality:"teal",signal_power:"coral",signal_noise:"orange"},a=[];return(i=(e.available_metrics||{})[n])==null||i.forEach(l=>{let c=`${n}_${l}`,d=l.replace("signal_","").replace("_"," ").replace(/^./,u=>u.toUpperCase());a.push(M(`${n} - ${d}`,H(e,c),s[l]||"teal",{fill:!1}))}),a.length?{datasets:a,opts:{yLabel:"Signal Metrics",yTickFormatter:l=>l.toFixed(0),tooltipLabel:l=>l.dataset.label+": "+l.parsed.y.toFixed(1)}}:{hidden:!0}}},{key:"apache",canvasId:"apacheChart",cardId:"apacheCard",loadingId:"apacheLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/apache?hours=${e}`,prepare:e=>{var s;if(!(e!=null&&e.success)||!((s=e.data)!=null&&s.length))return{hidden:!0};let t=e.data.some(a=>a.requests_per_sec!==null),n=e.data.some(a=>a.connections!==null);return!t&&!n?{hidden:!0}:{datasets:[M("Requests/sec",H(e,"requests_per_sec"),"blue",{fill:!1}),M("Connections",H(e,"connections"),"coral",{fill:!1,yAxisID:"y1"}),M("Idle Workers",H(e,"idle_workers"),"teal",{fill:!1,yAxisID:"y1"})],opts:{yLabel:"Requests/sec",beginAtZero:!0,yTickFormatter:a=>a.toFixed(1),tooltipLabel:a=>a.dataset.label+": "+a.parsed.y.toFixed(2),extraScales:{y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"Connections / Workers"},grid:{drawOnChartArea:!1},beginAtZero:!0}}}}}},{key:"apacheWorkers",canvasId:"apacheWorkersChart",cardId:"apacheWorkersCard",loadingId:"apacheWorkersLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/apache?hours=${e}`,prepare:e=>{var s;return!(e!=null&&e.success)||!((s=e.data)!=null&&s.length)?{hidden:!0}:e.data.some(a=>a.sb_sending!==null||a.sb_waiting!==null)?{datasets:[{key:"sb_sending",label:"Sending",color:"coral"},{key:"sb_reading",label:"Reading",color:"orange"},{key:"sb_keepalive",label:"Keepalive",color:"yellow"},{key:"sb_waiting",label:"Waiting",color:"teal"},{key:"sb_open",label:"Open Slots",color:"blue"}].map(a=>M(a.label,H(e,a.key),a.color,{fill:!0})),opts:{yLabel:"Workers",beginAtZero:!0,yTickFormatter:a=>a.toFixed(0),tooltipLabel:a=>a.dataset.label+": "+a.parsed.y.toFixed(0)},chartType:"line",stacked:!0}:{hidden:!0}}}];async function Kn(e,t){let n=!U.charts[e.key];n&&Ne(e.loadingId,!0);let s=e.getHours?parseFloat(e.getHours()):t;try{let a=e.prepare(await T(e.url(s)));if(!a||a.hidden){if(e.cardId){let o=document.getElementById(e.cardId);o&&(o.style.display="none")}}else{if(e.cardId){let r=document.getElementById(e.cardId);r&&(r.style.display="block")}let o=K(s,a.opts);a.stacked&&(o.scales.y.stacked=!0,o.scales.x.stacked=!0),F(U.charts,e.key,e.canvasId,a.chartType||"line",a.datasets,o)}}catch(a){if(console.error(`Error updating ${e.key}:`,a),e.cardId){let o=document.getElementById(e.cardId);o&&(o.style.display="none")}}n&&Ne(e.loadingId,!1)}function zo(e){let t=Gn.find(n=>n.key===e);t&&Kn(t,Jn())}async function Zn(){let e=Jn();await Promise.all(Gn.map(t=>Kn(t,e)))}async function Jo(){try{let{success:e,interfaces:t=[]}=await T("/api/plugin/fpp-plugin-watcher/metrics/interface/list");if(!e||!t.length)return;let n=document.getElementById("interfaceSelect");if(!n)return;let s=n.options.length===1?dt():n.value;n.innerHTML=t.map(a=>`<option value="${m(a)}">${m(a)}</option>`).join(""),n.value=t.includes(s)?s:t.includes(dt())?dt():t[0]}catch(e){console.error("Error loading interfaces:",e)}}async function Go(){try{let{success:e,interfaces:t=[]}=await T("/api/plugin/fpp-plugin-watcher/metrics/wireless/interfaces");if(!e||!t.length)return;let n=document.getElementById("wirelessInterfaceSelect");if(!n)return;let s=n.value;n.innerHTML=t.map(a=>`<option value="${m(a)}">${m(a)}</option>`).join(""),n.value=t.includes(s)?s:t[0]}catch(e){console.error("Error loading wireless interfaces:",e)}}async function ct(){if(U.isRefreshing)return;U.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{Jo(),Go(),await qo(),await Zn(),te()}catch(t){console.error("Error loading metrics:",t)}e&&(e.style.animation=""),U.isRefreshing=!1}var Qn={pageId:"localMetricsUI",init(e={}){U.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ct):ct(),U.refreshInterval=setInterval(()=>{U.isRefreshing||ct()},3e4)},destroy(){U.refreshInterval&&clearInterval(U.refreshInterval),Object.values(U.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),U={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,config:{}}},refresh:ct,refreshMetric:zo,updateAllCharts:Zn};var Z={charts:{},isRefreshing:!1,refreshInterval:null,config:{}};async function Ko(){try{let e=await T("/api/plugin/fpp-plugin-watcher/connectivity/state"),t=document.getElementById("networkResetBanner"),n=document.getElementById("resetDetails");if(!t||!n)return;if(e.success&&e.hasResetAdapter){let s=e.resetTime||"Unknown time",a=e.adapter||"Unknown adapter",o=e.reason||"Max failures reached";n.innerHTML=`The network adapter <strong>${m(a)}</strong> was reset on <strong>${m(s)}</strong>.<br>Reason: ${m(o)}`,t.style.display="block"}else t.style.display="none"}catch(e){console.error("Error checking network reset state:",e)}}async function Zo(){let e=event.target.closest("button");if(!e)return;let t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Clearing...';try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/connectivity/state/clear",{method:"POST"})).json();if(s.success){let a=document.getElementById("networkResetBanner");a&&(a.style.display="none"),Ge()}else alert("Failed to clear reset state: "+(s.error||"Unknown error")),e.disabled=!1,e.innerHTML=t}catch(n){console.error("Error clearing reset state:",n),alert("Failed to clear reset state: "+n.message),e.disabled=!1,e.innerHTML=t}}async function Xn(){var f,h;let e=parseInt(((f=document.getElementById("timeRange"))==null?void 0:f.value)||"12"),t=await T(`/api/plugin/fpp-plugin-watcher/metrics/ping/rollup?hours=${e}`),n=document.getElementById("noDataMessage"),s=document.getElementById("statsBarSection"),a=document.getElementById("rollupChartsSection");if(!t.success||!((h=t.data)!=null&&h.length))return s&&(s.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="block"),!1;n&&(n.style.display="none"),s&&(s.style.display="block"),a&&(a.style.display="block"),t.tier_info&&["latencyTierBadge","rangeTierBadge","sampleTierBadge"].forEach(p=>{let y=document.getElementById(p);y&&(y.textContent=t.tier_info.label)});let o=t.data.map(p=>p.avg_latency).filter(p=>p!==null),r=t.data.map(p=>p.min_latency).filter(p=>p!==null),i=t.data.map(p=>p.max_latency).filter(p=>p!==null),l=(p,y)=>{let w=document.getElementById(p);w&&(w.textContent=y)};l("currentLatency",be(o.at(-1))),l("avgLatency",be(o.reduce((p,y)=>p+y,0)/o.length)),l("minLatency",be(Math.min(...r))),l("maxLatency",be(Math.max(...i))),l("dataPoints",t.data.length.toLocaleString());let c=K(e,{yLabel:"Latency (ms)",beginAtZero:!0,yTickFormatter:p=>p.toFixed(1)+" ms",tooltipLabel:p=>"Latency: "+p.parsed.y.toFixed(2)+" ms"}),d=K(e,{yLabel:"Number of Samples",beginAtZero:!0,yTickFormatter:p=>p.toFixed(0),tooltipLabel:p=>"Samples: "+p.parsed.y});F(Z.charts,"latency","latencyChart","line",[M("Average Latency (ms)",H(t,"avg_latency"),"purple")],c),F(Z.charts,"range","rangeChart","line",[M("Min Latency",H(t,"min_latency"),"green",{fill:!1}),M("Avg Latency",H(t,"avg_latency"),"purple",{fill:!1}),M("Max Latency",H(t,"max_latency"),"red",{fill:!1})],c);let u=M("Sample Count",H(t,"sample_count"),"blue");return u.borderWidth=1,F(Z.charts,"sample","sampleChart","bar",[u],d),!0}async function Yn(){var o,r;let e=parseInt(((o=document.getElementById("rawTimeRange"))==null?void 0:o.value)||"12"),t=await T(`/api/plugin/fpp-plugin-watcher/metrics/ping/raw?hours=${e}`);if(!t.success||!((r=t.data)!=null&&r.length))return;let n={};t.data.forEach(i=>{(n[i.host]=n[i.host]||[]).push({x:i.timestamp*1e3,y:i.latency})});let s=Object.keys(n).map((i,l)=>{let c=Le(l);return M(i,n[i],c,{pointRadius:2})}),a=K(e,{yLabel:"Latency (ms)",beginAtZero:!0,tooltipLabel:i=>i.dataset.label+": "+i.parsed.y.toFixed(2)+" ms"});F(Z.charts,"rawPing","rawPingLatencyChart","line",s,a)}async function Ge(){if(Z.isRefreshing)return;Z.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{await Ko(),await Promise.all([Xn(),Yn()]),z("loadingIndicator"),G("metricsContent"),te()}catch(t){console.error("Error loading metrics:",t)}finally{Z.isRefreshing=!1,e&&(e.style.animation="")}}var es={pageId:"connectivityUI",init(e={}){Z.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ge):Ge(),Z.refreshInterval=setInterval(()=>{Z.isRefreshing||Ge()},3e4)},destroy(){Z.refreshInterval&&clearInterval(Z.refreshInterval),Object.values(Z.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),Z={charts:{},isRefreshing:!1,refreshInterval:null,config:{}}},refresh:Ge,updateAllCharts:Xn,updateRawPingLatencyChart:Yn,clearNetworkResetState:Zo};var P={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,systemMetrics:{},config:{}},Qo=()=>{var e;return((e=document.getElementById("timeRange"))==null?void 0:e.value)||"12"},ns=e=>P.useFahrenheit?de(e):e,Xo={cpu:{getValue:e=>{var t;return(t=e.cpu)==null?void 0:t.current},getClass:e=>e>80?"danger":e>60?"warning":"",format:e=>e.toFixed(1)+"%",chartKey:"cpu_usage"},memory:{getValue:e=>{var t;return(t=e.memory)==null?void 0:t.current},getClass:e=>e<100?"danger":e<250?"warning":"",format:e=>e.toFixed(0)+" MB",chartKey:"free_mb"},bufferCache:{getValue:e=>{var t;return(t=e.bufferCache)==null?void 0:t.current},getClass:()=>"",format:e=>e.toFixed(0)+" MB",chartKey:"buffer_cache_mb"},disk:{getValue:e=>{var t;return(t=e.disk)==null?void 0:t.current},getClass:e=>e<1?"danger":e<2?"warning":"",format:e=>e.toFixed(1)+" GB",chartKey:"free_gb"},load:{getValue:e=>{var t;return(t=e.load)==null?void 0:t.shortterm},getClass:()=>"",format:e=>e.toFixed(2),chartKey:null},temp:{getValue:e=>{var t;return(t=e.temperature)==null?void 0:t.current},getClass:e=>e>80?"danger":e>70?"warning":"",format:e=>ns(e).toFixed(1)+ee(P.useFahrenheit),chartKey:"temperature"},wireless:{getValue:e=>{var t;return(t=e.wireless)==null?void 0:t.signal},getClass:e=>e<-80?"danger":e<-70?"warning":"",format:e=>e.toFixed(0)+" dBm",chartKey:"signal_dbm"},ping:{getValue:e=>{var t;return(t=e.ping)==null?void 0:t.current},getClass:e=>e>100?"danger":e>50?"warning":"",format:e=>e.toFixed(1)+" ms",chartKey:"avg_latency"},efuse:{getValue:e=>{var t;return(t=e.efuse)==null?void 0:t.current},getClass:()=>"",format:e=>(e/1e3).toFixed(2)+" A",chartKey:"total_ma"}};function ts(e,t){let n=Xo[t],s=n.getValue(e);return s==null?{value:"--",class:""}:{value:n.format(s),class:n.getClass(s)}}function ut(e,t){var s;if(!(e!=null&&e.success)||!((s=e.data)!=null&&s.length))return null;let n=e.data.filter(a=>a[t]!==null);return n.length?{current:n.at(-1)[t],average:n.reduce((a,o)=>a+o[t],0)/n.length,data:e.data}:null}async function Yo(e){var l,c,d,u,f,h,p,y,w,S,x;let{address:t,hostname:n,model:s,type:a,version:o}=e,r=Qo(),i={hostname:n,address:t,model:s||a||"Unknown",version:o||"",watcherVersion:null,online:!1,noWatcher:!1,error:null,cpu:null,memory:null,bufferCache:null,disk:null,load:null,temperature:null,wireless:null,ping:null,efuse:null};try{let[v,b,E]=await Promise.all([T(`/api/plugin/fpp-plugin-watcher/remote/metrics/all?host=${encodeURIComponent(t)}&hours=${r}`,12e3),T(`/api/plugin/fpp-plugin-watcher/remote/version?host=${encodeURIComponent(t)}`,5e3).catch(()=>null),T(`/api/plugin/fpp-plugin-watcher/remote/efuse/heatmap?host=${encodeURIComponent(t)}&hours=${r}`,8e3).catch(()=>null)]);if(!v.success)return i.error="API returned unsuccessful response",i;if(i.online=!0,b!=null&&b.version&&(i.watcherVersion=b.version),i.cpu=ut(v.cpu,"cpu_usage"),i.memory=ut(v.memory,"free_mb"),i.bufferCache=ut(v.memory,"buffer_cache_mb"),i.disk=ut(v.disk,"free_gb"),(l=v.load)!=null&&l.success&&((c=v.load.data)!=null&&c.length)){let L=v.load.data.filter(I=>I.shortterm!==null);if(L.length){let I=L.at(-1);i.load={shortterm:I.shortterm,midterm:I.midterm,longterm:I.longterm}}}let B=v.thermal;if(B!=null&&B.success&&((d=B.data)!=null&&d.length)&&((u=B.zones)!=null&&u.length)){let L=B.zones.filter(I=>I.startsWith("thermal_zone"));for(let I of L.length?L:B.zones){let W=B.data.filter(A=>A[I]!==null);if(W.length){let A=((f=B.zone_names)==null?void 0:f[I])||I;i.temperature={current:W.at(-1)[I],average:W.reduce((Q,Ve)=>Q+Ve[I],0)/W.length,data:B.data.map(Q=>({timestamp:Q.timestamp,temperature:Q[I]})),zone:I,friendlyName:A};break}}}let $=v.wireless;if($!=null&&$.success&&((h=$.data)!=null&&h.length)&&((p=$.interfaces)!=null&&p.length)){let L=$.interfaces[0],I=`${L}_signal_power`,W=$.data.filter(A=>A[I]!==null);if(W.length){let A=W.at(-1);i.wireless={signal:A[I],noise:A[`${L}_signal_noise`],quality:A[`${L}_signal_quality`],data:$.data.map(Q=>({timestamp:Q.timestamp,signal_dbm:Q[I]})),interface:L}}}let D=v.ping;if(D!=null&&D.success&&((y=D.data)!=null&&y.length)){let L=D.data.filter(I=>I.avg_latency!==null);L.length&&(i.ping={current:L.at(-1).avg_latency,average:L.reduce((I,W)=>I+W.avg_latency,0)/L.length,min:Math.min(...L.map(I=>I.min_latency)),max:Math.max(...L.map(I=>I.max_latency)),data:D.data,tier:((w=D.tier_info)==null?void 0:w.label)||"5-min averages"})}if(E!=null&&E.success&&((S=E.totalHistory)!=null&&S.length)){let L=E.totalHistory.filter(I=>I.value!==null&&I.value>0);if(L.length){let I=L.at(-1),W=L.map(A=>A.value);i.efuse={current:I.value,average:W.reduce((A,Q)=>A+Q,0)/W.length,peak:Math.max(...W),portCount:E.portCount||0,hardware:E.hardware,data:E.totalHistory.map(A=>({timestamp:A.timestamp,total_ma:A.value,min:A.min,max:A.max})),tier:((x=E.tier_info)==null?void 0:x.label)||"1-minute averages"}}}}catch(v){try{let b=await T(`/api/plugin/fpp-plugin-watcher/remote/fppd/status?host=${encodeURIComponent(t)}`,8e3);b!=null&&b.success&&b.data&&(i.online=!0,i.noWatcher=!0)}catch(b){i.error=v.message||"Failed to connect"}}return i}function er(e,t){return`<div class="systemCard" data-system="${t}">
        <div class="systemHeader">
            <div><div class="systemName">${m(e.hostname)}</div>
            <div class="systemInfo"><a href="http://${m(e.address)}" target="_blank" style="color:#007bff">${m(e.address)}</a> | ${m(e.model||e.type||"Unknown")} | FPP ${m(e.version||"")}</div></div>
            <div class="systemStatus" style="background:#e9ecef;color:#6c757d">Loading...</div>
        </div>
        <div class="noDataMessage"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Fetching metrics...</p></div>
    </div>`}function tr(e,t){if(!e.online)return`<div class="systemCard" data-system="${t}">
            <div class="systemHeader"><div><div class="systemName">${m(e.hostname)}</div>
            <div class="systemInfo"><a href="http://${m(e.address)}" target="_blank" style="color:#007bff">${m(e.address)}</a> | ${m(e.model)} | FPP ${m(e.version)}</div></div>
            <div class="systemStatus offline">Offline</div></div>
            <div class="noDataMessage"><i class="fas fa-exclamation-triangle"></i><p>Unable to fetch metrics: ${m(e.error||"Connection failed")}</p><p style="font-size:0.875rem">Ensure the Watcher plugin is installed and collectd is enabled.</p></div>
        </div>`;if(e.noWatcher)return`<div class="systemCard" data-system="${t}">
            <div class="systemHeader"><div><div class="systemName">${m(e.hostname)}</div>
            <div class="systemInfo"><a href="http://${m(e.address)}" target="_blank" style="color:#007bff">${m(e.address)}</a> | ${m(e.model)} | FPP ${m(e.version)}</div></div>
            <div class="systemStatus online">Online</div></div>
            <div class="noDataMessage"><i class="fas fa-info-circle"></i><p>Watcher plugin not installed or metrics not available</p><p style="font-size:0.875rem">Install the Watcher plugin on this system to view metrics.</p></div>
        </div>`;let n=e.watcherVersion?` | Watcher ${m(e.watcherVersion)}`:"",s={cpu:"CPU Usage",memory:"Free Memory",bufferCache:"Buffer Cache",disk:"Free Disk",load:"Load (1min)"},a=["cpu","memory","bufferCache","disk","load"].filter(i=>i!=="bufferCache"||e.bufferCache).map(i=>{let l=ts(e,i);return`<div class="metricItem" data-metric="${i}"${i==="bufferCache"?' title="Memory used by Linux to cache frequently accessed files. This memory is automatically released when needed - high usage is good!"':""}><div class="metricLabel">${s[i]}${i==="bufferCache"?' <i class="fas fa-info-circle" style="font-size:0.65rem;color:#6c757d;cursor:help;"></i>':""}</div><div class="metricValue ${l.class}">${l.value}</div></div>`}).join(""),o=[["temp","Temperature",e.temperature],["wireless","WiFi Signal",e.wireless],["ping","Ping Latency",e.ping],["efuse","Total Current",e.efuse]].filter(([,,i])=>i).map(([i,l])=>{let c=ts(e,i);return`<div class="metricItem" data-metric="${i}"><div class="metricLabel">${l}</div><div class="metricValue ${c.class}">${c.value}</div></div>`}).join(""),r=[`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-microchip"></i> CPU Usage</div><canvas id="cpuChart-${t}" height="150"></canvas></div>`,`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-memory"></i> Free Memory</div><canvas id="memoryChart-${t}" height="150"></canvas></div>`,e.temperature?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-thermometer-half"></i> Temperature</div><canvas id="tempChart-${t}" height="150"></canvas></div>`:"",e.wireless?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-wifi"></i> WiFi Signal</div><canvas id="wirelessChart-${t}" height="150"></canvas></div>`:"",e.ping?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-network-wired"></i> Ping Latency</div><canvas id="pingChart-${t}" height="150"></canvas></div>`:"",e.efuse?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-bolt"></i> Total Current</div><canvas id="efuseChart-${t}" height="150"></canvas></div>`:""].join("");return`<div class="systemCard" data-system="${t}">
        <div class="systemHeader"><div><div class="systemName">${m(e.hostname)}</div>
        <div class="systemInfo"><a href="http://${m(e.address)}" target="_blank" style="color:#007bff">${m(e.address)}</a> | ${m(e.model)} | FPP ${m(e.version)}${n}</div></div>
        <div class="systemStatus online">Online</div></div>
        <div class="metricsGrid">${a}${o}</div>
        <div class="chartsContainer">${r}</div>
    </div>`}function nr(e,t,n,s,a){let o=a==="temperature",r=t.map(f=>({x:f.timestamp*1e3,y:o?ns(f[a]):f[a]})).filter(f=>f.y!==null),i=j[s]||j.purple,c={cpu_usage:f=>f.toFixed(1)+"%",free_mb:f=>f.toFixed(0)+" MB",temperature:f=>f.toFixed(1)+ee(P.useFahrenheit),signal_dbm:f=>f.toFixed(0)+" dBm",avg_latency:f=>f.toFixed(1)+" ms",total_ma:f=>(f/1e3).toFixed(2)+" A"}[a]||(f=>f.toFixed(2)),d=[M(n,r,i)],u={responsive:!0,maintainAspectRatio:!0,animation:!1,interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{title:f=>new Date(f[0].parsed.x).toLocaleString(),label:f=>n+": "+c(f.parsed.y)}}},scales:{x:{type:"time",display:!0,grid:{display:!1},ticks:{maxTicksLimit:6,font:{size:10},color:"#6c757d"},time:{displayFormats:{hour:"h:mm a",day:"MMM d"}}},y:{beginAtZero:a==="cpu_usage",display:!0,grid:{display:!1}}}};F(P.charts,e,e,"line",d,u)}function sr(){let e=Object.values(P.systemMetrics),t=e.filter(s=>s.online),n=(s,a)=>{let o=document.getElementById(s);o&&(o.textContent=a)};if(n("totalSystems",e.length),n("onlineSystems",`${t.length} online`),t.length){let s=c=>c.length?c.reduce((d,u)=>d+u)/c.length:null,a=s(t.filter(c=>c.cpu).map(c=>c.cpu.current)),o=s(t.filter(c=>c.memory).map(c=>c.memory.current)),r=s(t.filter(c=>c.disk).map(c=>c.disk.current));a!==null&&n("avgCpu",a.toFixed(1)+"%"),o!==null&&n("avgMemory",o.toFixed(0)+" MB"),r!==null&&n("avgDisk",r.toFixed(1)+" GB");let i=t.filter(c=>c.efuse),l=document.getElementById("efuseSummaryCard");if(l)if(i.length>0){let c=i.reduce((d,u)=>d+(u.efuse.current||0),0);l.style.display="",n("totalEfuse",(c/1e3).toFixed(2)+" A"),n("efuseSystems",`${i.length} system${i.length>1?"s":""} with eFuse`)}else l.style.display="none"}}function ft(){Object.keys(P.charts).forEach(e=>{P.charts[e]&&(P.charts[e].destroy(),delete P.charts[e])})}async function ar(e,t,n){let s=[],a=new Set;for(let[o,r]of t.entries()){let i=Promise.resolve().then(()=>n(r,o));s.push(i),a.add(i),i.finally(()=>a.delete(i)),a.size>=e&&await Promise.race(a)}return Promise.all(s)}async function pt(){if(P.isRefreshing)return;P.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite"),P.useFahrenheit=await Be();let t=document.getElementById("systemsContainer"),n=window.remoteSystems||[];if(!n.length){ft(),t&&(t.innerHTML='<div class="noDataMessage"><p>No remote systems found in multi-sync configuration.</p></div>'),z("loadingIndicator"),G("metricsContent"),P.isRefreshing=!1;return}!Object.keys(P.systemMetrics).length&&t&&(ft(),P.systemMetrics={},t.innerHTML=n.map((a,o)=>er(a,o)).join("")),z("loadingIndicator"),G("metricsContent"),await ar(6,n,async(a,o)=>{try{let r=await Yo(a);P.systemMetrics[o]=r;let i=t==null?void 0:t.querySelector(`[data-system="${o}"]`);i&&(["cpu","memory","temp","wireless","ping","efuse"].forEach(l=>{let c=`${l}Chart-${o}`;P.charts[c]&&(P.charts[c].destroy(),delete P.charts[c])}),i.outerHTML=tr(r,o),r.online&&[["cpu","red","cpu_usage"],["memory","purple","free_mb"],["temp","orange","temperature"],["wireless","teal","signal_dbm"],["ping","indigo","avg_latency"],["efuse","yellow","total_ma"]].forEach(([l,c,d])=>{var h,p,y,w,S,x,v;let u=l==="cpu"?(h=r.cpu)==null?void 0:h.data:l==="memory"?(p=r.memory)==null?void 0:p.data:l==="temp"?(y=r.temperature)==null?void 0:y.data:l==="wireless"?(w=r.wireless)==null?void 0:w.data:l==="ping"?(S=r.ping)==null?void 0:S.data:(x=r.efuse)==null?void 0:x.data,f=l==="cpu"?"CPU %":l==="memory"?"Memory MB":l==="temp"?Me(((v=r.temperature)==null?void 0:v.friendlyName)||"Temp")+" "+ee(P.useFahrenheit):l==="wireless"?"Signal dBm":l==="ping"?"Latency ms":"Amps";u&&nr(`${l==="temp"?"temp":l}Chart-${o}`,u,f,c,d)})),sr()}catch(r){console.error(`Failed to fetch metrics for ${a.hostname}:`,r)}}),te(),e&&(e.style.animation=""),P.isRefreshing=!1}var ss={pageId:"remoteMetricsUI",init(e={}){P.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pt):pt(),P.refreshInterval=setInterval(()=>{P.isRefreshing||pt()},6e4),window.addEventListener("beforeunload",ft)},destroy(){P.refreshInterval&&clearInterval(P.refreshInterval),ft(),P={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,systemMetrics:{},config:{}}},refresh:pt};var X={charts:{},isRefreshing:!1,refreshInterval:null,config:{}};function as(e){let t={};return e.forEach(n=>{let s=n.hostname||"unknown";(t[s]=t[s]||{entries:[],address:n.address||""}).entries.push(n)}),t}function Vt(e,t,n=0){return Object.keys(e).sort().map((s,a)=>{let o=Le(a);return M(s,e[s].entries.map(t),o,{fill:!1,pointRadius:n})})}async function os(){var o,r;let e=parseInt(((o=document.getElementById("rawTimeRange"))==null?void 0:o.value)||"12"),t=await T(`/api/plugin/fpp-plugin-watcher/metrics/multisync/ping/raw?hours=${e}`);if(!t.success||!((r=t.data)!=null&&r.length)){G("noDataMessage");return}z("noDataMessage");let n=as(t.data),s=Vt(n,i=>({x:i.timestamp*1e3,y:i.latency}),2),a=K(e,{yLabel:"Latency (ms)",beginAtZero:!0,tooltipLabel:i=>i.dataset.label+": "+i.parsed.y.toFixed(2)+" ms"});F(X.charts,"rawPing","rawPingLatencyChart","line",s,a)}async function rs(){var f,h;let e=parseInt(((f=document.getElementById("timeRange"))==null?void 0:f.value)||"12"),t=await T(`/api/plugin/fpp-plugin-watcher/metrics/multisync/ping/rollup?hours=${e}`),n=["statsBarSection","rollupChartsSection","perHostStatsSection"];if(!t.success||!((h=t.data)!=null&&h.length)){n.forEach(p=>{let y=document.getElementById(p);y&&(y.style.display="none")});return}if(n.forEach(p=>{let y=document.getElementById(p);y&&(y.style.display="block")}),t.tier_info){let p=document.getElementById("latencyTierBadge"),y=document.getElementById("successTierBadge");p&&(p.textContent=t.tier_info.label),y&&(y.textContent=t.tier_info.label)}let s=as(t.data),a=Object.keys(s).sort(),o=a.map(p=>{let y=s[p].entries,w=y.map(b=>b.avg_latency).filter(b=>b!==null),S=y.reduce((b,E)=>b+(E.success_count||0),0),x=y.reduce((b,E)=>b+(E.failure_count||0),0),v=S+x;return{hostname:p,address:s[p].address,avgLatency:w.length?w.reduce((b,E)=>b+E)/w.length:null,minLatency:w.length?Math.min(...w):null,maxLatency:w.length?Math.max(...w):null,successRate:v?S/v*100:0}}),r=document.getElementById("perHostStats");r&&(r.innerHTML=o.map(p=>{let y=p.avgLatency===null?"":p.avgLatency>100?"danger":p.avgLatency>50?"warning":"success",w=p.successRate>=99?"success":p.successRate>=90?"warning":"danger";return`<div class="hostStatCard" style="border-left-color:${{danger:"#dc3545",warning:"#ffc107",success:"#28a745"}[y]||"#6c757d"}">
            <div class="hostname">${m(p.hostname)}</div>
            <div class="address">${m(p.address)}</div>
            <div class="stats-row">
                <div class="stat"><div class="stat-label">Avg Latency</div><div class="stat-value ${y}">${p.avgLatency!==null?p.avgLatency.toFixed(1)+" ms":"--"}</div></div>
                <div class="stat"><div class="stat-label">Min/Max</div><div class="stat-value">${p.minLatency!==null?p.minLatency.toFixed(1):"--"} / ${p.maxLatency!==null?p.maxLatency.toFixed(1):"--"}</div></div>
                <div class="stat"><div class="stat-label">Success Rate</div><div class="stat-value ${w}">${p.successRate.toFixed(1)}%</div></div>
            </div></div>`}).join(""));let i=o.filter(p=>p.avgLatency!==null).map(p=>p.avgLatency),l=(p,y)=>{let w=document.getElementById(p);w&&(w.textContent=y)};l("hostsCount",a.length.toString()),l("overallAvgLatency",i.length?(i.reduce((p,y)=>p+y)/i.length).toFixed(2)+" ms":"-- ms"),l("bestLatency",i.length?Math.min(...i).toFixed(2)+" ms":"-- ms"),l("worstLatency",i.length?Math.max(...i).toFixed(2)+" ms":"-- ms"),l("dataPoints",t.data.length.toLocaleString());let c=K(e,{yLabel:"Latency (ms)",beginAtZero:!0,yTickFormatter:p=>p.toFixed(1)+" ms",tooltipLabel:p=>p.dataset.label+": "+p.parsed.y.toFixed(2)+" ms"});F(X.charts,"latency","latencyChart","line",Vt(s,p=>({x:p.timestamp*1e3,y:p.avg_latency})),c);let d=K(e,{yLabel:"Success Rate (%)",yMax:100,yTickFormatter:p=>p+"%",tooltipLabel:p=>p.dataset.label+": "+p.parsed.y.toFixed(1)+"%"}),u=Vt(s,p=>{let y=(p.success_count||0)+(p.failure_count||0);return{x:p.timestamp*1e3,y:y?p.success_count/y*100:100}});F(X.charts,"success","successChart","line",u,d)}async function mt(){if(X.isRefreshing)return;X.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{await Promise.all([os(),rs()]),z("loadingIndicator"),G("metricsContent"),te()}catch(t){console.error("Error loading metrics:",t)}finally{X.isRefreshing=!1,e&&(e.style.animation="")}}var is={pageId:"remotePingUI",init(e={}){X.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",mt):mt(),X.refreshInterval=setInterval(()=>{X.isRefreshing||mt()},6e4)},destroy(){X.refreshInterval&&clearInterval(X.refreshInterval),Object.values(X.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),X={charts:{},isRefreshing:!1,refreshInterval:null,config:{}}},refresh:mt,updateAllCharts:rs,updateRawPingLatencyChart:os};var N={charts:{},isRefreshing:!1,refreshInterval:null,allEvents:[],displayedEvents:50,config:{}};function or(e){return{ss:"seq-start",se:"seq-stop",ps:"pl-start",pe:"pl-stop",st:"status",ms:"media-start",me:"media-stop",wn:"warning"}[e]||""}async function rr(){var s;let t=`/api/plugin/fpp-plugin-watcher/mqtt/stats?hours=${((s=document.getElementById("timeRange"))==null?void 0:s.value)||"24"}`,n=await T(t);if(n!=null&&n.success&&n.stats){let a=n.stats,o=(r,i)=>{let l=document.getElementById(r);l&&(l.textContent=i)};o("totalEvents",a.totalEvents||0),o("sequencesPlayed",Object.keys(a.sequencesPlayed||{}).length),o("playlistsStarted",Object.keys(a.playlistsStarted||{}).length),o("totalRuntime",We(a.totalRuntime||0)),lr(a.hourlyDistribution||[]),cr(a.sequencesPlayed||{})}}async function ir(){var s;let t=`/api/plugin/fpp-plugin-watcher/mqtt/events?hours=${((s=document.getElementById("timeRange"))==null?void 0:s.value)||"24"}`,n=await T(t);if(n!=null&&n.success){N.allEvents=n.data||[],N.displayedEvents=50,ls();let a=document.getElementById("eventCount");a&&(a.textContent=N.allEvents.length+" events")}}function lr(e){var o;let t=e.map(r=>({x:new Date(r.timestamp*1e3),y:r.count})),n=parseInt(((o=document.getElementById("timeRange"))==null?void 0:o.value)||"24"),s=[M("Events",t,"blue",{pointRadius:2})],a=K(n,{yLabel:"Events",beginAtZero:!0,showLegend:!1});F(N.charts,"timeline","timelineChart","line",s,a)}function cr(e){let t=document.getElementById("topSequences");if(!t)return;let n=Object.entries(e).slice(0,10);if(n.length===0){t.innerHTML='<p class="noData">No sequence data available</p>';return}t.innerHTML=n.map(([s,a],o)=>`
        <div class="topItem">
            <span class="rank">${o+1}</span>
            <span class="name">${m(s)}</span>
            <span class="count">${a} plays</span>
        </div>
    `).join("")}function ls(){let e=document.getElementById("eventsTableBody");if(!e)return;let t=N.allEvents.slice(0,N.displayedEvents);if(t.length===0){e.innerHTML='<tr><td colspan="5" class="noData">No events found</td></tr>',z("showMoreContainer");return}e.innerHTML=t.map(n=>{let s=or(n.eventType),a=n.duration?We(n.duration):"";return`
            <tr>
                <td>${m(n.datetime)}</td>
                <td>${m(n.hostname)}</td>
                <td><span class="eventBadge ${s}">${m(n.eventLabel)}</span></td>
                <td>${m(n.data||"-")}</td>
                <td>${a}</td>
            </tr>
        `}).join(""),N.allEvents.length>N.displayedEvents?G("showMoreContainer"):z("showMoreContainer")}function dr(){N.displayedEvents+=50,ls()}async function gt(){if(N.isRefreshing)return;N.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{await Promise.all([rr(),ir()]),z("loadingIndicator"),G("metricsContent");let t=document.getElementById("lastUpdate");t&&(t.textContent="Updated: "+new Date().toLocaleTimeString())}catch(t){console.error("Error loading data:",t)}finally{N.isRefreshing=!1,e&&(e.style.animation="")}}var cs={pageId:"eventsUI",init(e={}){N.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",gt):gt(),N.refreshInterval=setInterval(gt,3e4)},destroy(){N.refreshInterval&&clearInterval(N.refreshInterval),Object.values(N.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),N={charts:{},isRefreshing:!1,refreshInterval:null,allEvents:[],displayedEvents:50,config:{}}},refresh:gt,showMoreEvents:dr};var ie={bulkStatus:{interval:1e4,lastFetch:0},bulkUpdates:{interval:6e4,lastFetch:0},localStatus:{interval:1e4,lastFetch:0},localSysStatus:{interval:3e4,lastFetch:0},localConnectivity:{interval:3e4,lastFetch:0},localVersion:{interval:6e4,lastFetch:0},localUpdates:{interval:6e4,lastFetch:0},discrepancies:{interval:6e4,lastFetch:0},fppRelease:{interval:6e4,lastFetch:0}},Ce=new Map,Ke=new Map,_={status:null,testMode:null,sysStatus:null,connectivity:null,version:null,updates:[]},le=new Map,we=new Map,he=new Map,ne=new Map,pe=new Map,Ze=!1,Qe=null,ht=null,se=null;function jt(e){Ze=e}function qt(e){Qe=e}function Nt(e){ht=e}function ds(e){se=e}function ae(e){let t=Date.now(),n=ie[e];return n?t-n.lastFetch>=n.interval:!0}function oe(e){ie[e]&&(ie[e].lastFetch=Date.now())}function Pe(e){ie[e]&&(ie[e].lastFetch=0)}var re={remoteAddresses:[],remoteHostnames:{},localHostname:"localhost"};function us(e){re.remoteAddresses=(e==null?void 0:e.remoteAddresses)||[],re.remoteHostnames=(e==null?void 0:e.remoteHostnames)||{},re.localHostname=(e==null?void 0:e.localHostname)||"localhost"}function ps(){Object.keys(ie).forEach(e=>{ie[e].lastFetch=0}),Ce.clear(),Ke.clear(),_.status=null,_.testMode=null,_.sysStatus=null,_.connectivity=null,_.version=null,_.updates=[],le.clear(),we.clear(),he.clear(),ne.clear(),pe.clear(),Ze=!1,Qe=null,ht=null,se=null}function k(e){return e.replace(/\./g,"-")}function fs(e){return e==="localhost"?re.localHostname:re.remoteHostnames[e]||e}function yt(e){if(!e)return[0,0];let n=e.replace(/^v/,"").match(/^(\d+)\.(\d+)/);return n?[parseInt(n[1]),parseInt(n[2])]:[0,0]}function ur(e,t){let[n,s]=yt(e),[a,o]=yt(t);return n<a?-1:n>a?1:s<o?-1:s>o?1:0}function ms(e){if(!se||!se.latestVersion)return null;if(ur(e,se.latestVersion)<0){let[n]=yt(e),[s]=yt(se.latestVersion),a=s>n;return{available:!0,currentVersion:e?e.replace(/^v/,""):"unknown",latestVersion:se.latestVersion,isMajorUpgrade:a}}return null}function Wt(e){var a;let t={fppLocalVersion:null,fppRemoteVersion:null,diskUtilization:null,cpuUtilization:null,memoryUtilization:null,ipAddress:null};if(!(e!=null&&e.advancedView))return t;t.fppLocalVersion=e.advancedView.LocalGitVersion||null,t.fppRemoteVersion=e.advancedView.RemoteGitVersion||null;let n=e.advancedView.IPs;n&&typeof n=="object"&&(t.ipAddress=n.eth0||n.wlan0||Object.values(n)[0]||null);let s=e.advancedView.Utilization;if(s){let o=(a=s.Disk)==null?void 0:a.Root;(o==null?void 0:o.Total)>0&&(t.diskUtilization=Math.round((o.Total-o.Free)/o.Total*100)),typeof s.CPU=="number"&&(t.cpuUtilization=Math.round(s.CPU)),typeof s.Memory=="number"&&(t.memoryUtilization=Math.round(s.Memory))}return t}async function gs(){try{let e=await fetch("/api/plugin/fpp-plugin-watcher/fpp/release");if(!e.ok)return null;let t=await e.json();if(t.success)return ds(t),t}catch(e){console.log("Failed to fetch latest FPP release:",e)}return null}async function hs(){if(ae("bulkStatus"))try{let e=await fetch("/api/plugin/fpp-plugin-watcher/remote/bulk/status");if(!e.ok)return;let t=await e.json();if(t.success&&t.hosts)for(let[n,s]of Object.entries(t.hosts))Ce.set(n,s);oe("bulkStatus")}catch(e){console.log("Failed to fetch bulk status:",e)}}async function ys(){if(ae("bulkUpdates"))try{let e=await fetch("/api/plugin/fpp-plugin-watcher/remote/bulk/updates");if(!e.ok)return;let t=await e.json();if(t.success&&t.hosts)for(let[n,s]of Object.entries(t.hosts))Ke.set(n,s);oe("bulkUpdates")}catch(e){console.log("Failed to fetch bulk updates:",e)}}async function zt(){try{if(ae("localStatus")){let[e,t]=await Promise.all([fetch("/api/fppd/status"),fetch("/api/testmode")]);if(e.ok){let n=await e.json();_.status={platform:n.platform||"--",branch:n.branch||"--",mode_name:n.mode_name||"--",status_name:n.status_name||"idle",rebootFlag:n.rebootFlag||0,restartFlag:n.restartFlag||0,warnings:n.warnings||[]}}if(t.ok){let n=await t.json();_.testMode={enabled:n.enabled?1:0}}else _.testMode={enabled:0};oe("localStatus")}if(ae("localSysStatus")){let e=await fetch("/api/system/status");if(e.ok){let t=await e.json();_.sysStatus=Wt(t)}oe("localSysStatus")}if(ae("localConnectivity")){let e=await fetch("/api/plugin/fpp-plugin-watcher/connectivity/state");if(e.ok){let t=await e.json();_.connectivity=t.success&&t.hasResetAdapter?t:null}oe("localConnectivity")}if(ae("localVersion")){let e=await fetch("/api/plugin/fpp-plugin-watcher/version");if(e.ok){let t=await e.json();_.version=t.version||null}oe("localVersion")}if(ae("localUpdates")){let e=await fetch("/api/plugin/fpp-plugin-watcher/plugins/updates");if(e.ok){let t=await e.json();_.updates=t.success&&t.updatesAvailable?t.updatesAvailable:[]}oe("localUpdates")}}catch(e){console.log("Failed to fetch local status:",e)}}function vs(e){let t=Ce.get(e),n=Ke.get(e);if(!t||!t.success)return{success:!1,address:e,error:(t==null?void 0:t.error)||"No data available"};let s=t.sysStatus?Wt(t.sysStatus):{fppLocalVersion:null,fppRemoteVersion:null,diskUtilization:null,cpuUtilization:null,memoryUtilization:null,ipAddress:null},a=t.connectivity&&t.connectivity.hasResetAdapter?t.connectivity:null;return{success:!0,address:e,status:t.status,testMode:t.testMode,watcherVersion:(n==null?void 0:n.version)||null,pluginUpdates:(n==null?void 0:n.updates)||[],connectivityState:a,...s}}function Jt(){return _.status?{success:!0,address:"localhost",status:_.status,testMode:_.testMode,watcherVersion:_.version,pluginUpdates:_.updates,connectivityState:_.connectivity,..._.sysStatus||{}}:{success:!1,address:"localhost",error:"No data available"}}async function Fe(e){let t=e==="localhost";try{if(t)return ie.localStatus.lastFetch=0,ie.localSysStatus.lastFetch=0,ie.localConnectivity.lastFetch=0,await zt(),Jt();{let[n,s,a]=await Promise.all([fetch(`/api/plugin/fpp-plugin-watcher/remote/status?host=${encodeURIComponent(e)}`),fetch(`/api/plugin/fpp-plugin-watcher/remote/sysStatus?host=${encodeURIComponent(e)}`).catch(()=>null),fetch(`/api/plugin/fpp-plugin-watcher/remote/connectivity/state?host=${encodeURIComponent(e)}`).catch(()=>null)]);if(!n.ok)return{success:!1,address:e,error:"Failed to fetch status"};let o=await n.json();if(!o.success)return{success:!1,address:e,error:o.error||"Failed"};let r={fppLocalVersion:null,fppRemoteVersion:null,diskUtilization:null,cpuUtilization:null,memoryUtilization:null,ipAddress:null};if(s!=null&&s.ok){let c=await s.json();r=Wt(c.data||c)}let i=null;if(a!=null&&a.ok){let c=await a.json();i=c.success&&c.hasResetAdapter?c:null}let l=Ke.get(e);return Ce.set(e,{success:!0,status:o.status,testMode:o.testMode,sysStatus:r,connectivity:i}),{success:!0,address:e,status:o.status,testMode:o.testMode,watcherVersion:(l==null?void 0:l.version)||null,pluginUpdates:(l==null?void 0:l.updates)||[],connectivityState:i,...r}}}catch(n){return{success:!1,address:e,error:n.message}}}function Re(e,t,n,s=1){let a=document.getElementById(e),o=document.getElementById(t);if(!a||!o)return;let r=n.size;a.classList.toggle("visible",r>=s),o.textContent=r}function bs(e,t,n=null){let s="";return e.forEach((a,o)=>{let r=n?n(a):"";s+=`
      <div class="host-item" id="${t}-${k(o)}">
        <div class="host-name">${a.hostname} (${o})${r}</div>
        <div class="host-status pending" id="${t}-status-${k(o)}">
          <i class="fas fa-clock"></i> Pending
        </div>
      </div>`}),s}function fe(e,t){let n=document.getElementById(`card-${e}`),s=document.getElementById(`status-${e}`),a=document.getElementById(`platform-${e}`),o=document.getElementById(`version-${e}`),r=document.getElementById(`mode-${e}`),i=document.getElementById(`watcher-${e}`),l=document.getElementById(`testmode-${e}`),c=document.getElementById(`restart-btn-${e}`),d=document.getElementById(`reboot-btn-${e}`),u=document.getElementById(`updates-container-${e}`),f=document.getElementById(`upgrades-list-${e}`),h=document.getElementById(`fpp-major-row-${e}`),p=document.getElementById(`fpp-major-version-${e}`),y=document.getElementById(`fpp-crossversion-row-${e}`),w=document.getElementById(`fpp-crossversion-version-${e}`),S=document.getElementById(`fpp-branch-row-${e}`),x=document.getElementById(`fpp-branch-version-${e}`);if(!n)return;if(n.classList.remove("offline","status-ok","status-warning","status-restart","status-update","status-testing"),!t.success){pr(n,s,a,o,r,i,l,c,d,u,h,y,S,e);return}let{status:v,testMode:b,pluginUpdates:E=[],fppLocalVersion:B,fppRemoteVersion:$,connectivityState:D,diskUtilization:L,cpuUtilization:I,memoryUtilization:W,ipAddress:A}=t,Q=(b==null?void 0:b.enabled)===1,Ve=v.rebootFlag===1,Bt=v.restartFlag===1;if(e==="localhost"&&A){let qe=document.getElementById("localhost-address");qe&&(qe.innerHTML=`<a href="http://${A}/" target="_blank">${A} (This System)</a>`)}let je=B&&$&&$!=="Unknown"&&$!==""&&B!==$,$e=ms(v.branch),on=je||$e&&$e.available,Xe=D&&D.hasResetAdapter,Pa=E.length>0,rn=L!==null&&L>=90,ln=I!==null&&I>=80,cn=W!==null&&W>=90;Q?n.classList.add("status-testing"):Ve||Bt?n.classList.add("status-restart"):on||Pa?n.classList.add("status-update"):Xe||rn||ln||cn?n.classList.add("status-warning"):n.classList.add("status-ok");let Fa=fr(v,Q,Ve,Bt,Xe,ln,cn,rn,I,W,L,$e,je);if(s.innerHTML='<div class="status-indicators">'+Fa.join("")+"</div>",a.textContent=v.platform||"--",o.innerHTML=mr(v.branch,$e,je),r.textContent=v.mode_name||"--",i.textContent=t.watcherVersion||"Not installed",l.disabled=!1,l.checked=Q,c.disabled=!1,d.disabled=!1,e==="localhost"){let qe=document.getElementById("multisync-test-row-localhost"),dn=document.getElementById("testmode-multisync-localhost"),un=v.mode_name&&v.mode_name.toLowerCase()==="player";qe&&(qe.style.display=un?"flex":"none"),dn&&(dn.disabled=!un)}gr(e,E,Ve,Bt,$e,je,B,$,v.branch,Xe,D),hr(e,$e,je,v.branch,B,$,h,p,y,w,S,x),yr(e,Xe,D),vr(e,E,f),on||E.length>0?u.classList.add("visible"):u.classList.remove("visible")}function pr(e,t,n,s,a,o,r,i,l,c,d,u,f,h){e.classList.add("offline"),t.innerHTML='<div class="status-indicators"><span class="status-indicator status-indicator--offline"><span class="dot"></span>Offline</span></div>',n.textContent="--",s.textContent="--",a.textContent="--",o.textContent="--",r.disabled=!0,r.checked=!1,i.disabled=!0,l.disabled=!0,c.classList.remove("visible"),d==null||d.classList.remove("visible"),u==null||u.classList.remove("visible"),f==null||f.classList.remove("visible");let p=document.getElementById(`connectivity-alert-${h}`);p==null||p.classList.remove("visible"),pe.delete(h),Re("connectivityFailBtn","connectivityFailCount",pe)}function fr(e,t,n,s,a,o,r,i,l,c,d,u,f){let h=['<span class="status-indicator status-indicator--online"><span class="dot"></span>Online</span>'],p=e.status_name||"idle";if(p==="playing"?h.push('<span class="status-indicator status-indicator--playing"><span class="dot"></span>Playing</span>'):!t&&p==="idle"&&h.push('<span class="status-indicator status-indicator--idle"><span class="dot"></span>Idle</span>'),a&&h.push('<span class="status-indicator status-indicator--connectivity"><span class="dot"></span>Conn. Failed</span>'),o&&h.push(`<span class="status-indicator status-indicator--high-cpu"><span class="dot"></span>High CPU (${l}%)</span>`),r&&h.push(`<span class="status-indicator status-indicator--low-memory"><span class="dot"></span>Low Memory (${c}%)</span>`),i&&h.push(`<span class="status-indicator status-indicator--low-storage"><span class="dot"></span>Low Storage (${d}%)</span>`),t&&h.push('<span class="status-indicator status-indicator--testing"><span class="dot"></span>Test Mode</span>'),u&&u.available&&(u.isMajorUpgrade?h.push(`<span class="status-indicator status-indicator--major-upgrade" title="Major version upgrade requires OS Upgrade"><span class="dot"></span>FPP v${u.latestVersion}</span>`):h.push(`<span class="status-indicator status-indicator--update"><span class="dot"></span>FPP v${u.latestVersion}</span>`)),f){let y=e.branch?e.branch.replace(/^v/,""):"";h.push(`<span class="status-indicator status-indicator--update"><span class="dot"></span>${y} Update</span>`)}return n?h.push('<span class="status-indicator status-indicator--reboot"><span class="dot"></span>Reboot Req</span>'):s&&h.push('<span class="status-indicator status-indicator--restart"><span class="dot"></span>Restart Req</span>'),h}function mr(e,t,n){let s=e||"--",a=[];return t&&t.available&&(t.isMajorUpgrade?a.push(`<span class="version-major" title="Major version upgrade requires OS Upgrade">v${t.latestVersion} Upgrade</span>`):a.push(`<span class="version-update">v${t.latestVersion}</span>`)),n&&a.push('<span class="version-update">branch update</span>'),a.length>0&&(s+=` (${a.join(", ")})`),s}function gr(e,t,n,s,a,o,r,i,l,c,d){let u=fs(e),f=t.find(w=>w.repoName==="fpp-plugin-watcher");f?le.set(e,{hostname:u,installedVersion:f.installedVersion,latestVersion:f.latestVersion}):le.delete(e),Re("upgradeAllBtn","upgradeAllCount",le);let h=t.filter(w=>w.repoName!=="fpp-plugin-watcher");h.length>0?we.set(e,{hostname:u,plugins:h}):we.delete(e),Re("upgradeOtherPluginsBtn","upgradeOtherPluginsCount",we),n?he.set(e,{hostname:u,type:"reboot"}):s?he.set(e,{hostname:u,type:"restart"}):he.delete(e),Re("restartAllBtn","restartAllCount",he);let p=a&&a.available&&a.isMajorUpgrade,y=a&&a.available&&!p;if(y||o?ne.set(e,{hostname:u,branch:l,crossVersion:y?{localVersion:a.currentVersion,remoteVersion:a.latestVersion}:null,branchUpdate:o?{localVersion:r,remoteVersion:i}:null}):ne.delete(e),Re("fppUpgradeAllBtn","fppUpgradeAllCount",ne),c){let w=d.resetTime||"Unknown time",S=d.adapter||"Unknown";pe.set(e,{hostname:u,resetTime:w,adapter:S})}else pe.delete(e);Re("connectivityFailBtn","connectivityFailCount",pe)}function hr(e,t,n,s,a,o,r,i,l,c,d,u){let f=t&&t.available&&t.isMajorUpgrade,h=t&&t.available&&!f;if(f&&r?(r.classList.add("visible"),i&&(i.textContent=`v${t.currentVersion} \u2192 v${t.latestVersion}`)):r&&r.classList.remove("visible"),h&&l){l.classList.add("visible"),c&&(c.textContent=`v${t.currentVersion} \u2192 v${t.latestVersion}`);let p=document.getElementById(`fpp-crossversion-btn-${e}`);p&&(n?(p.disabled=!0,p.title="Complete branch update first",l.classList.add("blocked-by-branch")):(p.disabled=!1,p.title="",l.classList.remove("blocked-by-branch")))}else l&&(l.classList.remove("visible"),l.classList.remove("blocked-by-branch"));if(n&&d){let p=s?s.replace(/^v/,""):"";d.classList.add("visible"),u&&(u.textContent=`${p}: ${a.substring(0,7)} \u2192 ${o.substring(0,7)}`)}else d&&d.classList.remove("visible")}function yr(e,t,n){let s=document.getElementById(`connectivity-alert-${e}`),a=document.getElementById(`connectivity-details-${e}`);if(s)if(t){let o=n.resetTime||"Unknown time",r=n.adapter||"Unknown";a&&(a.textContent=`Adapter ${r} reset at ${o}`),s.classList.add("visible")}else s.classList.remove("visible")}function vr(e,t,n){if(n)if(t.length>0){let s="";t.forEach(a=>{let o=a.latestVersion?`v${a.installedVersion} \u2192 v${a.latestVersion}`:`v${a.installedVersion}`,r=a.repoName==="fpp-plugin-watcher"?`page.upgradeWatcherSingle('${e}')`:`page.upgradePlugin('${e}', '${a.repoName}')`;s+=`
        <div class="upgrade-item" id="upgrade-item-${e}-${a.repoName}">
          <div class="update-info">
            <span class="update-name">${a.name}</span>
            <span class="update-version">${o}</span>
          </div>
          <button class="banner-btn" onclick="${r}" id="upgrade-btn-${e}-${a.repoName}">
            <i class="fas fa-download"></i> Upgrade
          </button>
        </div>`}),n.innerHTML=s}else n.innerHTML=""}async function Cs(e,t){let n=e==="localhost",s=document.getElementById(`testmode-${e}`);if(s){s.disabled=!0;try{let a="1-8388608";if(t)try{let i=n?"/api/system/info":`/api/plugin/fpp-plugin-watcher/remote/sysInfo?host=${encodeURIComponent(e)}`,l=await fetch(i);if(l.ok){let c=await l.json(),d=n?c:c.data||c;if(d.channelRanges){let u=d.channelRanges.split("-");u.length===2&&(a=`${parseInt(u[0])+1}-${parseInt(u[1])+1}`)}}}catch(i){}let o=t?"Test Start":"Test Stop",r=t?["1000","RGB Cycle",a,"R-G-B"]:[];if(n){if(!(await fetch("/api/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:o,args:r})})).ok)throw new Error("Failed to toggle test mode")}else{let l=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e,command:o,multisyncCommand:!1,multisyncHosts:"",args:r})})).json();if(!l.success)throw new Error(l.error||"Failed to toggle test mode")}setTimeout(async()=>{let i=await Fe(e);fe(e,i)},500)}catch(a){s.checked=!t,alert(`Failed to toggle test mode: ${a.message}`)}finally{s.disabled=!1}}}async function ws(e){let t=document.getElementById("testmode-multisync-localhost"),n=document.getElementById("testmode-localhost");if(t){t.disabled=!0;try{let s="1-8388608";if(e)try{let i=await fetch("/api/system/info");if(i.ok){let l=await i.json();if(l.channelRanges){let c=l.channelRanges.split("-");c.length===2&&(s=`${parseInt(c[0])+1}-${parseInt(c[1])+1}`)}}}catch(i){}if(!(await fetch("/api/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e?"Test Start":"Test Stop",multisyncCommand:!0,multisyncHosts:"",args:e?["1000","RGB Cycle",s,"R-G-B"]:[]})})).ok)throw new Error("Failed to toggle multisync test mode");n&&(n.checked=e)}catch(s){t.checked=!e,alert(`Failed to toggle multisync test mode: ${s.message}`)}finally{t.disabled=!1}}}async function Gt(e){let t=e==="localhost",n=document.getElementById(`restart-btn-${e}`);if(!n)return;let s=n.innerHTML;n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Restarting...',n.disabled=!0;try{if(t){if(!(await fetch("/api/fppd/restart",{method:"GET"})).ok)throw new Error("Failed to restart FPPD")}else{let o=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})})).json();if(!o.success)throw new Error(o.error||"Failed to restart FPPD")}n.innerHTML='<i class="fas fa-check"></i> Restarted!',setTimeout(async()=>{n.innerHTML=s,n.disabled=!1;let a=await Fe(e);fe(e,a)},3e3)}catch(a){n.innerHTML=s,n.disabled=!1,alert(`Failed to restart FPPD: ${a.message}`)}}function Kt(e,t){qt({address:e,hostname:t});let n=document.getElementById("confirmMessage"),s=document.getElementById("confirmDialog");n&&(n.textContent=`Are you sure you want to reboot "${t}" (${e})? This will take the system offline temporarily.`),s&&(s.style.display="flex")}function vt(){let e=document.getElementById("confirmDialog");e&&(e.style.display="none"),qt(null)}async function xs(){if(!Qe)return;let{address:e}=Qe,t=e==="localhost";vt();let n=document.getElementById(`reboot-btn-${e}`),s=(n==null?void 0:n.innerHTML)||'<i class="fas fa-power-off"></i> Reboot';n&&(n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Rebooting...',n.disabled=!0);try{t?await fetch("/api/system/reboot",{method:"GET"}):await fetch("/api/plugin/fpp-plugin-watcher/remote/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})});let a=document.getElementById(`card-${e}`),o=document.getElementById(`status-${e}`);if(a&&a.classList.add("offline"),o&&(o.innerHTML='<span class="status-indicator status-indicator--offline"><span class="dot"></span> Rebooting...</span>'),!t){let r=0,i=setInterval(async()=>{if(++r>60){clearInterval(i),n&&(n.innerHTML=s,n.disabled=!1);return}let l=await Fe(e);l.success&&(clearInterval(i),fe(e,l),n&&(n.innerHTML=s,n.disabled=!1))},2e3)}}catch(a){let o=document.getElementById(`card-${e}`),r=document.getElementById(`status-${e}`);o&&o.classList.add("offline"),r&&(r.innerHTML='<span class="status-indicator status-indicator--offline"><span class="dot"></span> Rebooting...</span>'),!t&&n&&(n.innerHTML=s,n.disabled=!1)}}async function Zt(e){let t=e==="localhost",n=document.getElementById(`connectivity-clear-btn-${e}`);if(!n)return;let s=n.innerHTML;n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{let a=t?"/api/plugin/fpp-plugin-watcher/connectivity/state/clear":"/api/plugin/fpp-plugin-watcher/remote/connectivity/state/clear",o=t?{method:"POST"}:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})},i=await(await fetch(a,o)).json();if(!i.success)throw new Error(i.error||"Failed to clear reset state");setTimeout(async()=>{let l=await Fe(e);fe(e,l)},1e3)}catch(a){n.innerHTML=s,n.disabled=!1,alert(`Failed to clear reset state: ${a.message}`)}}async function Es(e,t){let n=document.getElementById(`upgrade-btn-${e}-${t}`),s=document.getElementById(`upgrade-item-${e}-${t}`);if(!n)return;let a=n.innerHTML;if(confirm(`Upgrade ${t} on ${e}?`)){n.innerHTML='<i class="fas fa-spinner fa-spin"></i>',n.disabled=!0;try{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e,plugin:t})})).json();if(!r.success)throw new Error(r.error||"Upgrade failed");n.innerHTML='<i class="fas fa-check"></i> Done',s&&setTimeout(()=>{s.style.opacity="0.5"},500),setTimeout(async()=>{let i=await Fe(e);fe(e,i)},3e3)}catch(o){n.innerHTML=a,n.disabled=!1,alert(`Upgrade failed: ${o.message}`)}}}function Is(){Gt("localhost")}function Ss(){Kt("localhost",re.localHostname)}function $s(){Zt("localhost")}var ks={connectivity:{title:'<i class="fas fa-network-wired" style="color: #ffc107;"></i> Clearing Connectivity Failures',getHosts:()=>pe,extraInfo:e=>`<span style="font-size: 0.8em; color: #666;"> - ${e.adapter} at ${e.resetTime}</span>`,operation:async([e])=>{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/connectivity/state/clear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})})).json();if(!n.success)throw new Error(n.error)},refreshDelay:1e3},restart:{title:'<i class="fas fa-sync" style="color: #fd7e14;"></i> Restarting Systems',getHosts:()=>he,extraInfo:e=>`<span class="restart-type ${e.type}">${e.type==="reboot"?"Reboot":"FPPD Restart"}</span>`,operation:async([e,t])=>{let n=t.type==="reboot"?"/api/plugin/fpp-plugin-watcher/remote/reboot":"/api/plugin/fpp-plugin-watcher/remote/restart",a=await(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})})).json();if(!a.success)throw new Error(a.error)},refreshDelay:3e3},otherPlugins:{title:'<i class="fas fa-puzzle-piece" style="color: #17a2b8;"></i> Upgrading Plugins',getHosts:()=>we,extraInfo:e=>`<span style="font-size: 0.8em; color: #666;"> - ${e.plugins.map(t=>t.name).join(", ")}</span>`,parallel:!0,operation:async([e,t],n)=>{let s=t.plugins;for(let a=0;a<s.length;a++){let o=s[a];n("spinner fa-spin",`Upgrading ${o.name} (${a+1}/${s.length})...`);let i=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e,plugin:o.repoName})})).json();if(!i.success)throw new Error(`Failed to upgrade ${o.name}: ${i.error}`)}},refreshDelay:3e3}};async function br(e,t,n,s,a=!1){let o=0,r=0,i=e.length;if(a)s.textContent=`Processing ${i} hosts in parallel...`,e.forEach(c=>{let d=Array.isArray(c)?c[0]:c,u=document.getElementById(`${n}-status-${k(d)}`);u&&(u.className="host-status in-progress",u.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...')}),(await Promise.allSettled(e.map(async c=>{let d=Array.isArray(c)?c[0]:c,u=document.getElementById(`${n}-status-${k(d)}`),f=(h,p,y="in-progress")=>{u&&(u.className=`host-status ${y}`,u.innerHTML=`<i class="fas fa-${h}"></i> ${p}`)};try{return await t(c,f),u&&(u.className="host-status success",u.innerHTML='<i class="fas fa-check"></i> Done'),{success:!0}}catch(h){return console.error(`Error processing ${d}:`,h),u&&(u.className="host-status error",u.innerHTML='<i class="fas fa-times"></i> Failed'),{success:!1}}}))).forEach(c=>{var d;return(d=c.value)!=null&&d.success?o++:r++});else{s.textContent=`Processing 0 of ${i} hosts...`;for(let l of e){let c=Array.isArray(l)?l[0]:l,d=document.getElementById(`${n}-status-${k(c)}`);d&&(d.className="host-status in-progress",d.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...');let u=(f,h,p="in-progress")=>{d&&(d.className=`host-status ${p}`,d.innerHTML=`<i class="fas fa-${f}"></i> ${h}`)};try{await t(l,u),d&&(d.className="host-status success",d.innerHTML='<i class="fas fa-check"></i> Done'),o++}catch(f){console.error(`Error processing ${c}:`,f),d&&(d.className="host-status error",d.innerHTML='<i class="fas fa-times"></i> Failed'),r++}s.textContent=`Processed ${o+r} of ${i} hosts...`}}return{completed:o,failed:r,total:i}}async function Ms(e,t,n){if(e==="fpp"){t();return}if(e==="upgrade"){n();return}let s=ks[e];if(!s)return;let a=s.getHosts();if(a.size<1)return;Nt(e);let o=document.getElementById("bulkModal"),r=document.getElementById("bulkModalTitle"),i=document.getElementById("bulkModalHostList"),l=document.getElementById("bulkModalProgress"),c=document.getElementById("bulkModalCloseBtn");if(!o||!r||!i||!l||!c)return;r.innerHTML=s.title,i.innerHTML=bs(a,"bulk",s.extraInfo),o.style.display="flex",c.disabled=!0;let d=Array.from(a.entries()),{completed:u,failed:f}=await br(d,s.operation,"bulk",l,s.parallel||!1);l.textContent=f===0?`Successfully processed ${u} hosts!`:`Completed: ${u} succeeded, ${f} failed`,c.disabled=!1}function Ls(e){var s;let t=document.getElementById("bulkModal");t&&(t.style.display="none");let n=((s=ks[ht])==null?void 0:s.refreshDelay)||0;setTimeout(e,n),Nt(null)}var O=new Map,Ee=!1,ce="crossVersion";function Cr(e){let t=new Map;return ne.forEach((n,s)=>{if(e==="crossVersion"&&n.crossVersion){let a=!!n.branchUpdate;t.set(s,{hostname:n.hostname,localVersion:n.crossVersion.localVersion,remoteVersion:n.crossVersion.remoteVersion,isCrossVersion:!0,blockedByBranch:a})}else if(e==="branchUpdate"&&n.branchUpdate){let a=n.branch?n.branch.replace(/^v/,""):"";t.set(s,{hostname:n.hostname,localVersion:n.branchUpdate.localVersion.substring(0,7),remoteVersion:n.branchUpdate.remoteVersion.substring(0,7),branch:a,isCrossVersion:!1,blockedByBranch:!1})}}),t}function wr(){let e=0,t=0;return ne.forEach(n=>{n.crossVersion&&e++,n.branchUpdate&&t++}),{crossVersionCount:e,branchUpdateCount:t}}function Bs(e){Ee||(ce=e,Ts())}function Ts(){let e=document.getElementById("fppAccordion");if(!e)return;let t=Cr(ce);O.clear();let n="";t.size===0?n='<div style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-info-circle"></i> No hosts available for this upgrade type</div>':t.forEach((s,a)=>{let o=k(a),r=s.blockedByBranch;O.set(a,{status:r?"blocked":"pending",abortController:null,expanded:!1,selected:!r,upgradeInfo:s,blockedByBranch:r});let i=s.branch?`${s.branch}: ${s.localVersion} \u2192 ${s.remoteVersion}`:`v${s.localVersion} \u2192 v${s.remoteVersion}`,l=r?"fpp-accordion-item blocked excluded":"fpp-accordion-item",c=r?"disabled":"checked",d=r?"blocked":"pending",u=r?"fa-ban":"fa-clock",f=r?"Branch Update Required":"Pending";n+=`
        <div class="${l}" id="fpp-item-${o}" data-address="${a}">
          <div class="fpp-accordion-header" onclick="page.toggleFPPAccordion('${a}')">
            <input type="checkbox" class="fpp-accordion-checkbox" id="fpp-check-${o}" ${c} onclick="event.stopPropagation(); page.toggleFPPSelection('${a}')"${r?' title="Complete branch update first"':""}>
            <div class="fpp-accordion-toggle"><i class="fas fa-chevron-right"></i></div>
            <div class="fpp-accordion-info">
              <span class="fpp-accordion-hostname">${s.hostname}</span>
              <span class="fpp-accordion-address">${a}</span>
              <span class="fpp-accordion-version">${i}</span>
            </div>
            <div class="fpp-accordion-status ${d}" id="fpp-status-${o}" onclick="event.stopPropagation()">
              <i class="fas ${u}"></i> ${f}
            </div>
          </div>
          ${r?'<div class="fpp-accordion-blocked-note"><i class="fas fa-info-circle"></i> Complete the branch update before upgrading to a new version</div>':""}
          <div class="fpp-accordion-body">
            <div class="fpp-accordion-log" id="fpp-log-${o}"></div>
          </div>
        </div>`}),e.innerHTML=n,Ie()}function _e(){if(ne.size<1)return;let e=document.getElementById("fppUpgradeModal"),t=document.getElementById("fppUpgradeStartBtn"),n=document.getElementById("fppUpgradeCloseBtn");if(!e||!t||!n)return;Ee=!1;let{crossVersionCount:s,branchUpdateCount:a}=wr(),o=document.getElementById("fppCrossVersionCount"),r=document.getElementById("fppBranchUpdateCount");o&&(o.textContent=s,o.setAttribute("data-count",s)),r&&(r.textContent=a,r.setAttribute("data-count",a));let i=document.getElementById("fppCrossVersionDesc");i&&se&&se.latestVersion&&(i.textContent=`Upgrade to v${se.latestVersion}`);let l=document.querySelector('input[name="fppUpgradeType"][value="crossVersion"]'),c=document.querySelector('input[name="fppUpgradeType"][value="branchUpdate"]');l&&(l.disabled=s===0),c&&(c.disabled=a===0),ce==="crossVersion"&&s>0||ce==="branchUpdate"&&a>0||(s>0?ce="crossVersion":a>0&&(ce="branchUpdate"));let u=document.querySelector(`input[name="fppUpgradeType"][value="${ce}"]`);u&&(u.checked=!0),Ts(),t.disabled=!1,t.style.display="",t.innerHTML='<i class="fas fa-play"></i> Start Selected',n.disabled=!1,n.classList.remove("btn-success"),n.classList.add("btn-muted"),n.innerHTML="Close",e.style.display="flex"}function Ps(e){O.forEach(n=>{n.abortController&&n.abortController.abort()}),O.clear(),Ee=!1;let t=document.getElementById("fppUpgradeModal");t&&(t.style.display="none"),Pe("bulkUpdates"),Pe("localVersion"),e()}function Fs(e){let t=k(e),n=document.getElementById(`fpp-item-${t}`),s=O.get(e);!n||!s||(s.expanded=!s.expanded,n.classList.toggle("expanded",s.expanded))}function bt(e){let t=O.get(e);if(t){t.expanded=!0;let n=document.getElementById(`fpp-item-${k(e)}`);n==null||n.classList.add("expanded")}}function Rs(){O.forEach((e,t)=>{var n;e.expanded=!0,(n=document.getElementById(`fpp-item-${k(t)}`))==null||n.classList.add("expanded")})}function _s(){O.forEach((e,t)=>{var n;e.expanded=!1,(n=document.getElementById(`fpp-item-${k(t)}`))==null||n.classList.remove("expanded")})}function Hs(e){let t=k(e),n=document.getElementById(`fpp-check-${t}`),s=document.getElementById(`fpp-item-${t}`),a=O.get(e);if(!(!a||!n||!s)){if(a.blockedByBranch){n.checked=!1;return}a.selected=n.checked,s.classList.toggle("excluded",!a.selected),Ie()}}function Ds(){O.forEach((e,t)=>{if(e.status==="pending"&&!e.blockedByBranch){e.selected=!0;let n=k(t),s=document.getElementById(`fpp-check-${n}`),a=document.getElementById(`fpp-item-${n}`);s&&(s.checked=!0),a==null||a.classList.remove("excluded")}}),Ie()}function As(){O.forEach((e,t)=>{if(e.status==="pending"){e.selected=!1;let n=k(t),s=document.getElementById(`fpp-check-${n}`),a=document.getElementById(`fpp-item-${n}`);s&&(s.checked=!1),a==null||a.classList.add("excluded")}}),Ie()}function xe(e,t,n,s){let a=k(e),o=document.getElementById(`fpp-status-${a}`),r=O.get(e);o&&r&&(r.status=t,o.className=`fpp-accordion-status ${t}`,o.innerHTML=`<i class="fas fa-${n}"></i> ${s}`)}function Ie(){let e=document.getElementById("fppUpgradeCount"),t=document.getElementById("fppUpgradeStartBtn"),n=0,s=0,a=0,o=0,r=0,i=0;O.forEach(d=>{d.status==="blocked"?i++:d.status==="pending"?(n++,d.selected&&r++):d.status==="upgrading"?s++:d.status==="success"?a++:d.status==="error"&&o++});let l=O.size,c=l-i;e&&(s>0?e.textContent=`${s} upgrading, ${a+o} of ${c} complete`:a+o>0?e.textContent=`${a} succeeded, ${o} failed of ${c}`:i>0&&c===0?e.textContent=`${i} blocked (branch update required)`:i>0?e.textContent=`${r} of ${c} selected (${i} blocked)`:e.textContent=`${r} of ${l} selected`),t&&!Ee&&(t.disabled=r===0)}async function xr(e){let t=k(e),n=document.getElementById(`fpp-log-${t}`),s=document.getElementById(`fpp-item-${t}`),a=O.get(e);if(!n||!a)return;let o=a.upgradeInfo,r=ce==="crossVersion";a.abortController=new AbortController,xe(e,"upgrading","spinner fa-spin","Upgrading..."),Ie(),n.textContent="";let i={host:e};r&&o&&(i.version="v"+o.remoteVersion);try{let l=await fetch("/api/plugin/fpp-plugin-watcher/remote/fpp/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:a.abortController.signal});if(!l.ok)throw new Error(`HTTP error: ${l.status}`);let c=l.body.getReader(),d=new TextDecoder,u="";for(;;){let{done:h,value:p}=await c.read();if(h)break;let y=d.decode(p,{stream:!0});u+=y,n.textContent+=y,n.scrollTop=n.scrollHeight}if(u.includes("=== ERROR:")){xe(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded");return}if(n.textContent+=`

=== Upgrade complete ===`,r){n.textContent+=`

=== Initiating reboot for cross-version upgrade ===`,xe(e,"success","sync fa-spin","Rebooting...");try{e==="localhost"||e==="127.0.0.1"?await fetch("/api/system/reboot",{method:"GET"}):await fetch("/api/plugin/fpp-plugin-watcher/remote/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})}),n.textContent+=`
Reboot command sent. System will restart shortly.`}catch(h){n.textContent+=`
Reboot initiated (connection closed as expected).`}xe(e,"success","check","Rebooting")}else xe(e,"success","check","Complete")}catch(l){l.name==="AbortError"?(n.textContent+=`

=== Upgrade cancelled ===`,xe(e,"error","ban","Cancelled")):(n.textContent+=`

=== ERROR: ${l.message} ===`,xe(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded"))}finally{a.abortController=null,Ie()}}async function Us(){if(Ee)return;let e=[];if(O.forEach((o,r)=>{o.status==="pending"&&o.selected&&e.push(r)}),e.length===0)return;Ee=!0;let t=document.getElementById("fppUpgradeStartBtn"),n=document.getElementById("fppUpgradeCloseBtn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Upgrading...'),n&&(n.disabled=!0),O.forEach((o,r)=>{let i=document.getElementById(`fpp-check-${k(r)}`);i&&(i.disabled=!0)}),e[0]&&bt(e[0]);let s=e.map(o=>xr(o));await Promise.allSettled(s),Ee=!1,n&&(n.disabled=!1);let a=!1;O.forEach(o=>{o.status==="pending"&&(a=!0)}),a&&t?(t.disabled=!1,t.innerHTML='<i class="fas fa-play"></i> Start Selected',O.forEach((o,r)=>{if(o.status==="pending"){let i=document.getElementById(`fpp-check-${k(r)}`);i&&(i.disabled=!1)}})):t&&n&&(t.style.display="none",n.classList.remove("btn-muted"),n.classList.add("btn-success"),n.innerHTML='<i class="fas fa-check"></i> Done'),Ie()}function Os(e){if(!ne.has(e)){alert("No FPP update available.");return}_e(),setTimeout(()=>bt(e),100)}function Vs(e){let t=ne.get(e);if(!t||!t.crossVersion){alert("No cross-version upgrade available for this host.");return}ce="crossVersion",_e(),setTimeout(()=>bt(e),100)}function js(e){let t=ne.get(e);if(!t||!t.branchUpdate){alert("No branch update available for this host.");return}ce="branchUpdate",_e(),setTimeout(()=>bt(e),100)}var V=new Map,De=!1;function Er(){let e=document.getElementById("watcherAccordion");if(!e)return;V.clear();let t="";le.size===0?t='<div style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-info-circle"></i> No hosts need Watcher updates</div>':le.forEach((n,s)=>{let a=k(s);V.set(s,{status:"pending",abortController:null,expanded:!1,selected:!0});let o=`${n.installedVersion||"?"} \u2192 ${n.latestVersion||"?"}`;t+=`
        <div class="fpp-accordion-item" id="watcher-item-${a}" data-address="${s}">
          <div class="fpp-accordion-header" onclick="page.toggleWatcherAccordion('${s}')">
            <input type="checkbox" class="fpp-accordion-checkbox" id="watcher-check-${a}" checked onclick="event.stopPropagation(); page.toggleWatcherSelection('${s}')">
            <div class="fpp-accordion-toggle"><i class="fas fa-chevron-right"></i></div>
            <div class="fpp-accordion-info">
              <span class="fpp-accordion-hostname">${n.hostname}</span>
              <span class="fpp-accordion-address">${s}</span>
              <span class="fpp-accordion-version">${o}</span>
            </div>
            <div class="fpp-accordion-status pending" id="watcher-status-${a}" onclick="event.stopPropagation()">
              <i class="fas fa-clock"></i> Pending
            </div>
          </div>
          <div class="fpp-accordion-body">
            <div class="fpp-accordion-log" id="watcher-log-${a}"></div>
          </div>
        </div>`}),e.innerHTML=t,Se()}function Ct(){if(le.size<1)return;let e=document.getElementById("watcherUpgradeModal"),t=document.getElementById("watcherUpgradeStartBtn"),n=document.getElementById("watcherUpgradeCloseBtn");!e||!t||!n||(De=!1,Er(),t.disabled=!1,t.style.display="",t.innerHTML='<i class="fas fa-play"></i> Start Selected',n.disabled=!1,n.classList.remove("btn-success"),n.classList.add("btn-muted"),n.innerHTML="Close",e.style.display="flex")}function qs(e){V.forEach(n=>{n.abortController&&n.abortController.abort()}),V.clear(),De=!1;let t=document.getElementById("watcherUpgradeModal");t&&(t.style.display="none"),Pe("bulkUpdates"),Pe("localVersion"),e()}function Ns(e){let t=k(e),n=document.getElementById(`watcher-item-${t}`),s=V.get(e);!n||!s||(s.expanded=!s.expanded,n.classList.toggle("expanded",s.expanded))}function Ir(e){let t=k(e),n=document.getElementById(`watcher-item-${t}`),s=V.get(e);n&&s&&(s.expanded=!0,n.classList.add("expanded"))}function Ws(){V.forEach((e,t)=>{var n;e.expanded=!0,(n=document.getElementById(`watcher-item-${k(t)}`))==null||n.classList.add("expanded")})}function zs(){V.forEach((e,t)=>{var n;e.expanded=!1,(n=document.getElementById(`watcher-item-${k(t)}`))==null||n.classList.remove("expanded")})}function Js(e){let t=k(e),n=document.getElementById(`watcher-check-${t}`),s=document.getElementById(`watcher-item-${t}`),a=V.get(e);!a||!n||!s||(a.selected=n.checked,s.classList.toggle("excluded",!a.selected),Se())}function Gs(){V.forEach((e,t)=>{if(e.status==="pending"){e.selected=!0;let n=k(t),s=document.getElementById(`watcher-check-${n}`),a=document.getElementById(`watcher-item-${n}`);s&&(s.checked=!0),a==null||a.classList.remove("excluded")}}),Se()}function Ks(){V.forEach((e,t)=>{if(e.status==="pending"){e.selected=!1;let n=k(t),s=document.getElementById(`watcher-check-${n}`),a=document.getElementById(`watcher-item-${n}`);s&&(s.checked=!1),a==null||a.classList.add("excluded")}}),Se()}function He(e,t,n,s){let a=k(e),o=document.getElementById(`watcher-status-${a}`),r=V.get(e);o&&r&&(r.status=t,o.className=`fpp-accordion-status ${t}`,o.innerHTML=`<i class="fas fa-${n}"></i> ${s}`)}function Se(){let e=document.getElementById("watcherUpgradeCount"),t=document.getElementById("watcherUpgradeStartBtn"),n=0,s=0,a=0,o=0,r=0;V.forEach(l=>{l.status==="pending"?(n++,l.selected&&r++):l.status==="upgrading"?s++:l.status==="success"?a++:l.status==="error"&&o++});let i=V.size;e&&(s>0?e.textContent=`${s} upgrading, ${a+o} of ${i} complete`:a+o>0?e.textContent=`${a} succeeded, ${o} failed of ${i}`:e.textContent=`${r} of ${i} selected`),t&&!De&&(t.disabled=r===0)}async function Sr(e){let t=k(e),n=document.getElementById(`watcher-log-${t}`),s=document.getElementById(`watcher-item-${t}`),a=V.get(e);if(!(!n||!a)){a.abortController=new AbortController,He(e,"upgrading","spinner fa-spin","Upgrading..."),Se(),n.textContent="";try{let o=await fetch("/api/plugin/fpp-plugin-watcher/remote/watcher/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e}),signal:a.abortController.signal});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);let r=o.body.getReader(),i=new TextDecoder,l="";for(;;){let{done:d,value:u}=await r.read();if(d)break;let f=i.decode(u,{stream:!0});l+=f,n.textContent+=f,n.scrollTop=n.scrollHeight}if(l.includes("=== ERROR:")){He(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded");return}n.textContent+=`

=== Upgrade complete, restarting FPPD... ===`,He(e,"success","sync fa-spin","Restarting...");try{await fetch("/api/plugin/fpp-plugin-watcher/remote/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})}),n.textContent+=`
FPPD restart initiated.`}catch(d){n.textContent+=`
FPPD restart may have failed: `+d.message}He(e,"success","check","Complete")}catch(o){o.name==="AbortError"?(n.textContent+=`

=== Upgrade cancelled ===`,He(e,"error","ban","Cancelled")):(n.textContent+=`

=== ERROR: ${o.message} ===`,He(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded"))}finally{a.abortController=null,Se()}}}async function Zs(){if(De)return;let e=[];if(V.forEach((o,r)=>{o.status==="pending"&&o.selected&&e.push(r)}),e.length===0)return;De=!0;let t=document.getElementById("watcherUpgradeStartBtn"),n=document.getElementById("watcherUpgradeCloseBtn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Upgrading...'),n&&(n.disabled=!0),V.forEach((o,r)=>{let i=document.getElementById(`watcher-check-${k(r)}`);i&&(i.disabled=!0)});let s=e.map(o=>Sr(o));await Promise.allSettled(s),De=!1,n&&(n.disabled=!1);let a=!1;V.forEach(o=>{o.status==="pending"&&(a=!0)}),a&&t?(t.disabled=!1,t.innerHTML='<i class="fas fa-play"></i> Start Selected',V.forEach((o,r)=>{if(o.status==="pending"){let i=document.getElementById(`watcher-check-${k(r)}`);i&&(i.disabled=!1)}})):t&&n&&(t.style.display="none",n.classList.remove("btn-muted"),n.classList.add("btn-success"),n.innerHTML='<i class="fas fa-check"></i> Done'),Se()}function Qs(e){if(!le.has(e)){alert("No Watcher update available.");return}Ct(),setTimeout(()=>Ir(e),100)}var wt=!1,Ae=null;async function Xs(){if(!ae("discrepancies"))return Ae;try{let e=await fetch("/api/plugin/fpp-plugin-watcher/outputs/discrepancies");if(!e.ok)return Ae;let t=await e.json();return t.success?(Ae=t,oe("discrepancies"),t):Ae}catch(e){return console.log("Failed to fetch issues:",e),Ae}}function $r(){let e=[],t=re.localHostname;return _.status&&Array.isArray(_.status.warnings)&&_.status.warnings.forEach(n=>{e.push({type:"fpp_warning",severity:"warning",address:"localhost",hostname:t,message:n})}),Ce.forEach((n,s)=>{n.sysStatus&&Array.isArray(n.sysStatus.warnings)&&n.sysStatus.warnings.forEach(a=>{e.push({type:"fpp_warning",severity:"warning",address:s,hostname:n.hostname||s,message:a})})}),e}function Ys(e){let t=document.getElementById("issuesBanner"),n=document.getElementById("issuesCount"),s=document.getElementById("issuesList");if(!t||!n||!s)return;let a=e&&e.discrepancies?[...e.discrepancies]:[],o=$r(),r=[...a,...o];if(r.length===0){t.classList.remove("visible");return}n.textContent=r.length;let i="";r.forEach(l=>{let c,d=[];switch(l.type){case"channel_mismatch":c="fa-not-equal",d.push(`<span><strong>Player:</strong> ${m(l.playerRange)}</span>`),d.push(`<span><strong>Remote:</strong> ${m(l.remoteRange)}</span>`);break;case"output_to_remote":c="fa-exclamation-triangle",l.description&&d.push(`<span><strong>Name:</strong> ${m(l.description)}</span>`),d.push(`<span><strong>Channels:</strong> ${l.startChannel}-${l.startChannel+l.channelCount-1}</span>`);break;case"inactive_output":c="fa-info-circle",l.description&&d.push(`<span><strong>Name:</strong> ${m(l.description)}</span>`),d.push(`<span><strong>Channels:</strong> ${l.startChannel}-${l.startChannel+l.channelCount-1}</span>`);break;case"missing_sequences":if(c="fa-file-audio",l.sequences&&l.sequences.length>0){let u=l.sequences.slice(0,5).map(h=>m(h)).join(", "),f=l.sequences.length>5?` (+${l.sequences.length-5} more)`:"";d.push(`<span><strong>Missing:</strong> ${u}${f}</span>`)}break;case"output_host_not_in_sync":c="fa-unlink",l.description&&d.push(`<span><strong>Output:</strong> ${m(l.description)}</span>`),l.startChannel&&l.channelCount&&d.push(`<span><strong>Channels:</strong> ${l.startChannel}-${l.startChannel+l.channelCount-1}</span>`);break;case"fpp_warning":c="fa-exclamation-circle";break;default:c="fa-question-circle"}i+=`
      <div class="issues-item severity-${l.severity}">
        <div class="issues-item__icon"><i class="fas ${c}"></i></div>
        <div class="issues-item__content">
          <div class="issues-item__message">
            ${m(l.message)}
          </div>
          <div class="issues-item__details">
            ${d.join("")}
          </div>
        </div>
        <span class="issues-item__address">${m(l.hostname||l.address)}</span>
      </div>`}),s.innerHTML=i,t.classList.add("visible")}function ea(){let e=document.getElementById("issuesBody"),t=document.getElementById("issuesToggle");!e||!t||(wt=!wt,wt?(e.style.display="block",t.innerHTML='<i class="fas fa-chevron-up"></i> Hide'):(e.style.display="none",t.innerHTML='<i class="fas fa-chevron-down"></i> Details'))}function ta(){wt=!1,Ae=null}var xt=null;async function ye(){if(Ze)return;jt(!0);let e=document.getElementById("refreshBtn");e&&(e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Refreshing...',e.disabled=!0);let t=document.getElementById("loadingIndicator"),n=document.getElementById("controlContent");t&&(t.style.display="none"),n&&(n.style.display="block");try{ae("fppRelease")&&(await gs(),oe("fppRelease")),await Promise.all([zt(),hs(),ys(),Xs().then(a=>Ys(a))]),fe("localhost",Jt());for(let a of re.remoteAddresses)fe(a,vs(a));let s=document.getElementById("lastUpdateTime");s&&(s.textContent=new Date().toLocaleTimeString())}finally{e&&(e.innerHTML='<i class="fas fa-sync-alt"></i> Refresh All',e.disabled=!1),jt(!1)}}function kr(){let e=document.getElementById("confirmRebootBtn");e&&e.addEventListener("click",xs),document.addEventListener("keydown",t=>{t.key==="Escape"&&(vt(),na(),sa(),aa())})}function Mr(e){Ms(e,_e,Ct)}function na(){Ls(ye)}function sa(){Ps(ye)}function aa(){qs(ye)}async function Lr(e){await ws(e),setTimeout(ye,1e3)}var oa={pageId:"remoteControlUI",init(e){us(e),kr(),ye(),xt=setInterval(()=>{Ze||ye()},1e4)},destroy(){xt&&(clearInterval(xt),xt=null),ps(),ta()},refresh:ye,refreshAllStatus:ye,toggleTestMode:Cs,toggleMultiSyncTestMode:Lr,restartFppd:Gt,confirmReboot:Kt,closeConfirmDialog:vt,restartLocalFppd:Is,confirmLocalReboot:Ss,clearResetState:Zt,clearLocalResetState:$s,upgradePlugin:Es,showBulkModal:Mr,closeBulkModal:na,showFPPUpgradeModal:_e,closeFPPUpgradeModal:sa,toggleFPPAccordion:Fs,toggleFPPSelection:Hs,fppSelectAll:Ds,fppSelectNone:As,fppExpandAll:Rs,fppCollapseAll:_s,switchFPPUpgradeType:Bs,startAllFPPUpgrades:Us,upgradeFPPSingle:Os,upgradeFPPCrossVersion:Vs,upgradeFPPBranch:js,showWatcherUpgradeModal:Ct,closeWatcherUpgradeModal:aa,toggleWatcherAccordion:Ns,toggleWatcherSelection:Js,watcherSelectAll:Gs,watcherSelectNone:Ks,watcherExpandAll:Ws,watcherCollapseAll:zs,startAllWatcherUpgrades:Zs,upgradeWatcherSingle:Qs,toggleIssuesDetails:ea};var g={config:{isPlayerMode:!1,isRemoteMode:!1,remoteSystems:[],localHostname:"",multiSyncPingEnabled:!1},fastRefreshInterval:null,slowRefreshInterval:null,charts:{},localStatus:null,localFppStatus:null,fppSystems:[],systemsData:[],sequenceMeta:null,lastSequenceName:null,clockDriftData:{},currentSort:{column:"hostname",direction:"asc"},slowDataLoaded:!1,lastPacketCount:0,lastPacketTime:null,packetRate:0,consecutiveFailures:{},lastKnownGoodState:{}};function ra(e){g.config={isPlayerMode:e.isPlayerMode||!1,isRemoteMode:e.isRemoteMode||!1,remoteSystems:e.remoteSystems||[],localHostname:e.localHostname||"",multiSyncPingEnabled:e.multiSyncPingEnabled||!1}}function ia(){g.fastRefreshInterval&&(clearInterval(g.fastRefreshInterval),g.fastRefreshInterval=null),g.slowRefreshInterval&&(clearInterval(g.slowRefreshInterval),g.slowRefreshInterval=null),Object.values(g.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),g.charts={},g.localStatus=null,g.localFppStatus=null,g.fppSystems=[],g.systemsData=[],g.sequenceMeta=null,g.lastSequenceName=null,g.clockDriftData={},g.currentSort={column:"hostname",direction:"asc"},g.slowDataLoaded=!1,g.lastPacketCount=0,g.lastPacketTime=null,g.packetRate=0,g.consecutiveFailures={},g.lastKnownGoodState={}}function ve(){return g.config.isPlayerMode}function Ue(){return g.config.isRemoteMode}function Et(){return g.config.localHostname}function la(){return g.config.multiSyncPingEnabled}function It(e){let t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}function St(e){if(e===void 0||e<0)return"--";if(e<1e3)return e+"ms";if(e<1e4)return(e/1e3).toFixed(1)+"s";let t=Math.floor(e/1e3);return t<60?t+"s":t<3600?Math.floor(t/60)+"m":t<86400?Math.floor(t/3600)+"h":Math.floor(t/86400)+"d"}function $t(e,t){let n=document.getElementById(e);n&&(n.className="msm-quality-value",t&&n.classList.add("msm-quality-"+t))}function ca(){let e=document.getElementById("lastUpdate");e&&(e.textContent="Updated: "+new Date().toLocaleTimeString())}function Qt(e){let t=document.getElementById("pluginErrorMessage"),n=document.getElementById("pluginError");t&&(t.textContent=e),n&&(n.style.display="flex")}function da(){let e=document.getElementById("pluginError");e&&(e.style.display="none")}function ua(){let e=document.getElementById("helpTooltip");e&&e.classList.toggle("show")}function Xt(e){let t=document.getElementById("helpTooltip"),n=document.querySelector(".msm-help-btn");t&&t.classList.contains("show")&&!t.contains(e.target)&&(!n||!n.contains(e.target))&&t.classList.remove("show")}function pa(e){return e<100?"msm-drift-good":e<1e3?"msm-drift-fair":"msm-drift-poor"}function kt(e){return e<20?"good":e<50?"warning":"critical"}function fa(e){return e>10?"critical":e>5?"warning":"good"}async function ma(e){var S,x,v;let t=document.getElementById("systemHostname");t&&(t.textContent=Et());let n=e.currentMasterSequence||"",s=n.replace(/\.fseq$/i,"")||"None",a=document.getElementById("systemSequence");a&&(a.textContent=s);let o=document.getElementById("systemStatus");if(o&&(o.textContent=e.sequencePlaying?"Playing":"Idle"),n&&n!==g.lastSequenceName){g.lastSequenceName=n;try{let b=await fetch(`/api/sequence/${encodeURIComponent(n)}/meta`);b.ok?g.sequenceMeta=await b.json():g.sequenceMeta=null}catch(b){g.sequenceMeta=null}}else n||(g.sequenceMeta=null,g.lastSequenceName=null);let r=ve()?e.sequencePlaying:e.secondsSinceLastSync!==void 0&&e.secondsSinceLastSync>=0&&e.secondsSinceLastSync<5,i=e.localCurrentFrame!==void 0&&e.localCurrentFrame>=0?e.localCurrentFrame:e.lastMasterFrame||0,l=((S=g.sequenceMeta)==null?void 0:S.NumFrames)||0,c=document.getElementById("systemFrame");c&&(r&&l>0?c.textContent=`${i.toLocaleString()} / ${l.toLocaleString()}`:r&&i>0?c.textContent=i.toLocaleString():c.textContent="--");let d=Ue()&&((x=g.localFppStatus)==null?void 0:x.seconds_played)!==void 0?g.localFppStatus.seconds_played:e.lastMasterSeconds||0,u=((v=g.sequenceMeta)==null?void 0:v.StepTime)||25,f=l>0?l*u/1e3:0,h=document.getElementById("systemTime");h&&(r&&f>0?h.textContent=`${It(d)} / ${It(f)}`:r&&d>0?h.textContent=It(d):h.textContent="--");let p=document.getElementById("systemStepTime");if(p)if(g.sequenceMeta){let b=Math.round(1e3/g.sequenceMeta.StepTime);p.textContent=`${g.sequenceMeta.StepTime}ms (${b}fps)`}else p.textContent="--";if(ve()){let b=document.getElementById("systemChannels");b&&(b.textContent=g.sequenceMeta?g.sequenceMeta.ChannelCount.toLocaleString():"--");let E=document.getElementById("systemPacketsSent");E&&(E.textContent=(e.totalPacketsSent||0).toLocaleString())}let y=document.getElementById("systemPacketsReceived");if(y&&(y.textContent=(e.totalPacketsReceived||0).toLocaleString()),Ue()){let b=document.getElementById("systemAvgDrift");b&&(b.textContent=r&&e.avgFrameDrift!==void 0?e.avgFrameDrift.toFixed(1)+" frames":"--");let E=document.getElementById("systemMaxDrift");if(E){let D=r&&e.maxFrameDrift!==void 0?Math.abs(e.maxFrameDrift):null;E.textContent=D!==null?D.toFixed(1)+" frames":"--"}let B=document.getElementById("systemSyncInterval");B&&(r&&e.avgSyncIntervalMs!==void 0&&e.syncIntervalSamples>0?B.textContent=e.avgSyncIntervalMs.toFixed(0)+"ms":B.textContent="--");let $=document.getElementById("systemSyncJitter");if($)if(r&&e.syncIntervalJitterMs!==void 0&&e.syncIntervalSamples>0){let D=e.syncIntervalJitterMs;$.textContent=D.toFixed(1)+"ms",$.classList.remove("status-good","status-warning","status-critical");let L=kt(D);L==="good"?$.classList.add("status-good"):L==="warning"?$.classList.add("status-warning"):$.classList.add("status-critical")}else $.textContent="--",$.classList.remove("status-good","status-warning","status-critical")}let w=document.getElementById("systemLastSync");w&&(w.textContent=St(e.millisecondsSinceLastSync))}function ga(e){let t=e.packetsSent||{},n=e.packetsReceived||{},s=e.lifecycle||{},a={lcSeqOpen:s.seqOpen||0,lcSeqStart:s.seqStart||0,lcSeqStop:s.seqStop||0,lcMediaOpen:s.mediaOpen||0,lcMediaStart:s.mediaStart||0,lcMediaStop:s.mediaStop||0};for(let[f,h]of Object.entries(a)){let p=document.getElementById(f);p&&(p.textContent=h.toLocaleString())}let o=Ue(),r=o?n.sync||0:(t.sync||0)+(n.sync||0),i=o?n.mediaSync||0:(t.mediaSync||0)+(n.mediaSync||0),l=o?n.blank||0:(t.blank||0)+(n.blank||0),c=o?n.command||0:(t.command||0)+(n.command||0),d=o?n.plugin||0:(t.plugin||0)+(n.plugin||0),u={lcSyncPackets:r,lcMediaPackets:i,lcBlankPackets:l,lcCmdPackets:c,lcPluginPackets:d};for(let[f,h]of Object.entries(u)){let p=document.getElementById(f);p&&(p.textContent=h.toLocaleString())}}function ya(e){let t=e.packetsReceived||{},s={summaryTotalReceived:e.totalPacketsReceived||0,summarySyncReceived:t.sync||0,summaryMediaReceived:t.mediaSync||0,summaryCmdReceived:t.command||0};for(let[a,o]of Object.entries(s)){let r=document.getElementById(a);r&&(r.textContent=o.toLocaleString())}}function va(){let e=document.getElementById("syncSourceHostname"),t=document.getElementById("syncSourceIP"),n=document.getElementById("syncSourceStatus");if(!e)return;let s=g.fppSystems.find(a=>a.fppModeString==="player"||a.fppMode===2);if(s){e.textContent=s.hostname||"Unknown",t.textContent=s.address||"--";let a=s.lastSeen?new Date(s.lastSeen*1e3):null,r=a?Math.floor((new Date-a)/1e3):null;r!==null&&r<60?(n.textContent="Online",n.className="msm-sync-source-value status-good"):r!==null?(n.textContent=`Last seen ${r}s ago`,n.className="msm-sync-source-value status-warning"):(n.textContent="Unknown",n.className="msm-sync-source-value")}else e.textContent="No player found",t.textContent="--",n.textContent="Not detected",n.className="msm-sync-source-value status-warning"}function ba(e,t){var p,y;let n=document.getElementById("syncHealthBadge");if(!n)return;let s=n.querySelector("i"),a=n.querySelector("span"),o=(p=e.secondsSinceLastSync)!=null?p:-1,r=Math.abs((y=e.avgFrameDrift)!=null?y:0),i=t&&t.length>0,l=t&&t.some(w=>w.severity>=3),c=e.sequencePlaying===!0,d="good",u="Healthy",f=c&&o>30,h=c&&o>10;l||f||r>10?(d="critical",u="Critical"):i||h||r>5?(d="warning",u="Warning"):(o<0||e.totalPacketsReceived===0)&&(d="unknown",u="No Data"),n.className=`msm-sync-health msm-sync-health-${d}`,a&&(a.textContent=u)}function Ca(e){let t=document.getElementById("systemPacketRate");if(!t)return;let n=e.totalPacketsReceived||0,s=Date.now();if(g.lastPacketTime!==null&&g.lastPacketCount>0){let a=(s-g.lastPacketTime)/1e3;if(a>0){let o=n-g.lastPacketCount;g.packetRate=o/a}}g.lastPacketCount=n,g.lastPacketTime=s,g.packetRate>0?t.textContent=`${g.packetRate.toFixed(1)}/sec`:t.textContent="--"}async function wa(e){let t=document.getElementById("compLocalSeq"),n=document.getElementById("compSyncSeq"),s=document.getElementById("compLocalStatus"),a=document.getElementById("compSyncStatus"),o=document.getElementById("comparisonStatus");if(!t)return;try{let h=await fetch("/api/fppd/status");h.ok&&(g.localFppStatus=await h.json())}catch(h){console.error("Error fetching local FPP status:",h)}let r=(e.currentMasterSequence||"").replace(/\.fseq$/i,"")||"(none)",i=e.sequencePlaying?"Playing":"Idle";n.textContent=r,a.textContent=i;let l="(none)",c="Idle",d=0;g.localFppStatus&&(l=(g.localFppStatus.current_sequence||"").replace(/\.fseq$/i,"")||"(none)",c=g.localFppStatus.status_name==="playing"?"Playing":"Idle"),t.textContent=l,s.textContent=c;let u=l===r||l==="(none)"&&r==="(none)",f=c===i;ha("compLocalSeq","compSyncSeq",u),ha("compLocalStatus","compSyncStatus",f),u||d++,f||d++,d===0?(o.textContent="Match",o.className="msm-comparison-status status-good"):(o.textContent=`${d} Mismatch${d>1?"es":""}`,o.className="msm-comparison-status status-critical")}function ha(e,t,n){let s=document.getElementById(e),a=document.getElementById(t);if(!(!s||!a))if(n){s.classList.remove("mismatch"),a.classList.remove("mismatch");let o=s.closest(".msm-comparison-row");if(o){let r=o.querySelector(".msm-comparison-vs");r&&(r.textContent="=",r.classList.remove("mismatch"))}}else{s.classList.add("mismatch"),a.classList.add("mismatch");let o=s.closest(".msm-comparison-row");if(o){let r=o.querySelector(".msm-comparison-vs");r&&(r.textContent="\u2260",r.classList.add("mismatch"))}}}function xa(e){return e.map(t=>{let n=t.address;return t.online?(g.consecutiveFailures[n]=0,g.lastKnownGoodState[n]=JSON.parse(JSON.stringify(t)),t):(g.consecutiveFailures[n]=(g.consecutiveFailures[n]||0)+1,g.consecutiveFailures[n]<3&&g.lastKnownGoodState[n]?{...g.lastKnownGoodState[n],_staleSinceFailure:g.consecutiveFailures[n]}:t)})}function Ea(e){let t=document.getElementById("remotesGrid");if(t){if(!e||e.length===0){t.innerHTML=`
      <div class="msm-empty" style="grid-column: 1/-1;">
        <i class="fas fa-satellite-dish"></i>
        <p>No remote systems found in multi-sync configuration</p>
      </div>
    `;return}t.innerHTML=e.map(n=>Tr(n)).join("")}}function Tr(e){let t="msm-remote-card",n="";e.online?e.pluginInstalled?n='<span class="msm-remote-badge online">Online</span>':(t+=" no-plugin",n='<span class="msm-remote-badge no-plugin">No Plugin</span>'):(t+=" offline",n='<span class="msm-remote-badge offline">Offline</span>'),e.maxSeverity>=3?t+=" critical":e.maxSeverity>=2&&(t+=" has-issues");let s=Pr(e),a=Fr(e);return`
    <div class="${t}">
      <div class="msm-remote-header">
        <div>
          <div class="msm-remote-hostname">${m(e.hostname)}</div>
          <div class="msm-remote-address"><a href="http://${m(e.address)}/" target="_blank" class="msm-host-link">${m(e.address)}</a></div>
        </div>
        ${n}
      </div>
      <div class="msm-remote-body">${s}</div>
      ${a}
    </div>
  `}function Pr(e){if(!e.online)return'<div class="msm-remote-message"><i class="fas fa-plug"></i> Unreachable</div>';if(!e.pluginInstalled)return'<div class="msm-remote-message"><i class="fas fa-info-circle"></i> Watcher plugin not installed</div>';let t=e.metrics||{},n=e.fppStatus||{},s=n.sequence||t.currentMasterSequence||"--",a=n.status||(t.sequencePlaying?"playing":"idle"),o=a==="playing"?"Playing":"Idle",r=t.localCurrentFrame!==void 0&&t.localCurrentFrame>=0?t.localCurrentFrame:t.lastMasterFrame,i=a==="playing"&&r!==void 0?r.toLocaleString():"--",l=t.totalPacketsReceived!==void 0?t.totalPacketsReceived.toLocaleString():"--",c=t.millisecondsSinceLastSync!==void 0?St(t.millisecondsSinceLastSync):"--",d=t.sequencePlaying,u=a==="playing",f=u&&t.avgFrameDrift!==void 0?Math.abs(t.avgFrameDrift):null,h=f!==null?f.toFixed(1):"--",p=u&&t.maxFrameDrift!==void 0?Math.abs(t.maxFrameDrift):null,y=u&&t.avgSyncIntervalMs!==void 0&&t.syncIntervalSamples>0?t.avgSyncIntervalMs.toFixed(0)+"ms":"--",w=u&&t.syncIntervalJitterMs!==void 0&&t.syncIntervalSamples>0?t.syncIntervalJitterMs.toFixed(1)+"ms":"--",S=u&&t.avgSyncIntervalMs!==void 0&&t.avgSyncIntervalMs>0&&t.syncIntervalSamples>0?(1e3/t.avgSyncIntervalMs).toFixed(1)+"/s":"--",x="";u&&t.syncIntervalJitterMs!==void 0&&t.syncIntervalSamples>0&&(x=kt(t.syncIntervalJitterMs));let v="";f!==null&&(v=fa(f));let b=u?"good":"";return d&&!u&&(b="critical"),`
    <div class="msm-remote-metrics">
      <div><span class="msm-remote-metric-label">Received Sequence</span><br><span class="msm-remote-metric-value">${m(s)||"(none)"}</span></div>
      <div><span class="msm-remote-metric-label">Status</span><br><span class="msm-remote-metric-value ${b}">${o}</span></div>
      <div><span class="msm-remote-metric-label">Packets Recv</span><br><span class="msm-remote-metric-value">${l}</span></div>
      <div><span class="msm-remote-metric-label">Frame</span><br><span class="msm-remote-metric-value msm-mono">${i}</span></div>
      <div><span class="msm-remote-metric-label">Seq Sync Rate</span><br><span class="msm-remote-metric-value">${S}</span></div>
      <div><span class="msm-remote-metric-label">Seq Sync Interval</span><br><span class="msm-remote-metric-value">${y}</span></div>
      <div><span class="msm-remote-metric-label">Seq Sync Jitter</span><br><span class="msm-remote-metric-value ${x}">${w}</span></div>
      <div><span class="msm-remote-metric-label">Last Sync</span><br><span class="msm-remote-metric-value">${c}</span></div>
      <div><span class="msm-remote-metric-label">Avg Frame Drift</span><br><span class="msm-remote-metric-value ${v}">${h}f</span></div>
      <div><span class="msm-remote-metric-label">Max Frame Drift</span><br><span class="msm-remote-metric-value ${v}">${p!==null?p+"f":"--"}</span></div>
    </div>
  `}function Fr(e){if(!e.issues||e.issues.length===0)return"";let t=e.issues.filter(a=>a.type!=="no_plugin");if(t.length===0)return"";let n=e.maxSeverity>=3?"critical":"",s=t.map(a=>a.description).join("; ");return`<div class="msm-remote-issues ${n}"><i class="fas fa-exclamation-triangle"></i> ${m(s)}</div>`}function Ia(e,t){if(!document.getElementById("systemsPacketBody"))return;g.systemsData=[];let s=g.fppSystems.find(i=>i.local===1)||{},a=(t==null?void 0:t.packetsSent)||{},o=(t==null?void 0:t.packetsReceived)||{},r=Et();g.systemsData.push({isLocal:!0,status:"local",hostname:r,address:s.address||"127.0.0.1",type:s.type||"FPP",mode:ve()?"Player":Ue()?"Remote":s.fppModeString||"--",syncSent:a.sync||0,syncRecv:o.sync||0,mediaSent:a.mediaSync||0,mediaRecv:o.mediaSync||0,blankSent:a.blank||0,blankRecv:o.blank||0,pluginSent:a.plugin||0,pluginRecv:o.plugin||0,hasMetrics:!0}),e&&e.length>0&&e.forEach(i=>{let l=g.fppSystems.find(f=>f.address===i.address)||{},c=i.metrics||{},d=c.packetsSent||{},u=c.packetsReceived||{};g.systemsData.push({isLocal:!1,status:i.online?i.pluginInstalled?"online":"no-plugin":"offline",hostname:i.hostname||l.hostname||i.address,address:i.address,type:l.type||"--",mode:l.fppModeString||"--",syncSent:d.sync||0,syncRecv:u.sync||0,mediaSent:d.mediaSync||0,mediaRecv:u.mediaSync||0,blankSent:d.blank||0,blankRecv:u.blank||0,pluginSent:d.plugin||0,pluginRecv:u.plugin||0,hasMetrics:i.online&&i.pluginInstalled})}),g.fppSystems.forEach(i=>{i.local!==1&&(g.systemsData.some(l=>l.address===i.address)||g.systemsData.push({isLocal:!1,status:"unknown",hostname:i.hostname,address:i.address,type:i.type||"--",mode:i.fppModeString||"--",drift:null,driftFrames:null,syncSent:0,syncRecv:0,mediaSent:0,mediaRecv:0,blankSent:0,blankRecv:0,pluginSent:0,pluginRecv:0,hasMetrics:!1}))}),Mt(),Hr()}function Mt(){let e=document.getElementById("systemsPacketBody");if(!e||g.systemsData.length===0)return;let t=g.currentSort.column,n=g.currentSort.direction==="asc"?1:-1;g.systemsData.sort((s,a)=>{var i,l,c,d,u,f;if(s.isLocal&&!a.isLocal)return-1;if(!s.isLocal&&a.isLocal)return 1;let o=s[t],r=a[t];if(t==="status"){let h={local:0,online:1,"no-plugin":2,offline:3,unknown:4};o=(i=h[o])!=null?i:5,r=(l=h[r])!=null?l:5}if(t==="drift"){let h=(d=(c=g.clockDriftData[s.address])==null?void 0:c.drift_ms)!=null?d:null,p=(f=(u=g.clockDriftData[a.address])==null?void 0:u.drift_ms)!=null?f:null;return h===null&&p===null?0:h===null?1:p===null?-1:n*(Math.abs(h)-Math.abs(p))}return typeof o=="string"?n*o.localeCompare(r):n*((o!=null?o:0)-(r!=null?r:0))}),e.innerHTML=g.systemsData.map(s=>Rr(s)).join("")}function Rr(e){let t=e.isLocal?"msm-status-local":e.status==="online"?"msm-status-online":e.status==="offline"?"msm-status-offline":e.status==="no-plugin"?"msm-status-noplugin":"msm-status-unknown",n=e.isLocal?"Local":e.status==="online"?"Online":e.status==="offline"?"Offline":e.status==="no-plugin"?"No Plugin":"--",s=e.syncSent+e.syncRecv+e.mediaSent+e.mediaRecv+e.blankSent+e.blankRecv+e.pluginSent+e.pluginRecv,a=!e.hasMetrics&&!e.isLocal?"msm-row-dim":"",o=_r(e),r;return e.isLocal?r=`<i class="fas fa-home msm-home-icon"></i>${m(e.hostname)}`:r=`<a href="http://${m(e.address)}/" target="_blank" class="msm-host-link" title="${m(e.address)}">${m(e.hostname)}</a>`,`<tr class="${a}">
    <td><span class="msm-status-badge ${t}">${n}</span></td>
    <td>${r}</td>
    <td>${m(e.type)}</td>
    <td>${m(e.mode)}</td>
    <td class="msm-td-num">${o}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.syncSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.syncRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.mediaSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.mediaRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.blankSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.blankRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.pluginSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.pluginRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-total">${e.hasMetrics?s.toLocaleString():"--"}</td>
  </tr>`}function _r(e){if(e.isLocal)return'<span class="msm-drift-ref">ref</span>';let t=g.clockDriftData[e.address];if(t&&t.drift_ms!==null){let n=t.drift_ms,s=Math.abs(n),a=n>=0?"+":"",o=pa(s),r=t.rtt_ms?`RTT: ${t.rtt_ms}ms`:"";return`<span class="${o}" title="${r}">${a}${n}ms</span>`}return e.hasMetrics?'<span class="msm-drift-pending">...</span>':"--"}function Hr(){let e=document.getElementById("systemsPacketTable");e&&e.querySelectorAll("th[data-sort]").forEach(t=>{let n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.onclick=()=>{let s=n.dataset.sort;g.currentSort.column===s?g.currentSort.direction=g.currentSort.direction==="asc"?"desc":"asc":(g.currentSort.column=s,g.currentSort.direction="asc"),e.querySelectorAll("th").forEach(a=>{a.classList.remove("msm-th-sorted-asc","msm-th-sorted-desc")}),n.classList.add(g.currentSort.direction==="asc"?"msm-th-sorted-asc":"msm-th-sorted-desc"),Mt()}})}function Sa(e){if(typeof Chart=="undefined"){console.error("Chart.js is not loaded");return}let t=e.labels.map(a=>new Date(a)),n=[{label:"Latency (ms)",data:t.map((a,o)=>({x:a,y:e.latency[o]})),borderColor:"#17a2b8",backgroundColor:"rgba(23, 162, 184, 0.1)",fill:!0,tension:.3},{label:"Jitter (ms)",data:t.map((a,o)=>({x:a,y:e.jitter[o]})),borderColor:"#ffc107",backgroundColor:"rgba(255, 193, 7, 0.1)",fill:!1,tension:.3}],s={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"}},scales:{x:{type:"time",time:{displayFormats:{minute:"HH:mm",hour:"HH:mm"}},ticks:{maxTicksLimit:8}},y:{beginAtZero:!0,title:{display:!0,text:"Milliseconds"}}}};F(g.charts,"latencyJitter","latencyJitterChart","line",n,s)}function $a(e){if(typeof Chart=="undefined"){console.error("Chart.js is not loaded");return}let t=e.labels.map(l=>new Date(l)),n=e.packetLoss,s=n.filter(l=>l!=null),a=s.length>0?Math.max(...s):0,o=a<=5?5:Math.ceil(a/5)*5,r=[{label:"Packet Loss (%)",data:t.map((l,c)=>({x:l,y:n[c]})),borderColor:"#dc3545",backgroundColor:"rgba(220, 53, 69, 0.1)",fill:!0,tension:.3}],i={responsive:!0,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{type:"time",time:{displayFormats:{minute:"HH:mm",hour:"HH:mm"}},ticks:{maxTicksLimit:8}},y:{beginAtZero:!0,max:o,title:{display:!0,text:"Packet Loss %"}}}};F(g.charts,"packetLoss","packetLossChart","line",r,i)}function ka(e){let t=e.summary||{},n=document.getElementById("overallQuality");if(n){let c=t.overallQuality||"unknown";n.textContent=c.charAt(0).toUpperCase()+c.slice(1),n.className="msm-quality-indicator msm-quality-"+c}let s=t.avgLatency,a=document.getElementById("qualityLatency");a&&(a.textContent=s!==null?s+"ms":"--");let o=t.avgJitter,r=document.getElementById("qualityJitter");r&&(r.textContent=o!==null?o+"ms":"--");let i=t.avgPacketLoss,l=document.getElementById("qualityPacketLoss");if(l&&(l.textContent=i!==null?i+"%":"--"),e.hosts&&e.hosts.length>0){let c=e.hosts[0];$t("qualityLatency",c.latency_quality),$t("qualityJitter",c.jitter_quality),$t("qualityPacketLoss",c.packet_loss_quality)}}function Yt(){let e=`
    <div class="msm-ping-disabled">
      <i class="fas fa-info-circle"></i>
      <div>
        <strong>Remote Ping is disabled</strong>
        <p>Enable "Remote Ping" in <a href="plugin.php?plugin=fpp-plugin-watcher&page=configUI.php">Plugin Settings</a> to collect network quality metrics.</p>
      </div>
    </div>
  `,t=document.getElementById("latencyJitterChart");if(t){let a=t.parentElement;a&&(a.innerHTML=e)}let n=document.getElementById("packetLossChart");if(n){let a=n.parentElement;a&&(a.innerHTML=e)}let s=document.getElementById("overallQuality");s&&(s.textContent="Disabled",s.className="msm-quality-indicator msm-quality-unknown"),["qualityLatency","qualityJitter","qualityPacketLoss"].forEach(a=>{let o=document.getElementById(a);o&&(o.textContent="--",o.className=o.className.replace(/msm-quality-\w+/g,"").trim())})}function en(){return la()}function Ma(e,t,n,s){let a={statRemotes:e,statOnline:t,statWithPlugin:n};for(let[r,i]of Object.entries(a)){let l=document.getElementById(r);l&&(l.textContent=i)}let o=document.getElementById("statIssues");o&&(o.textContent=s,o.className="msm-stat-value",s>0&&o.classList.add("warning"))}function tn(e){let t=document.getElementById("issuesPanel"),n=document.getElementById("issuesHeader"),s=document.getElementById("issuesList"),a=document.getElementById("issueCount");if(!t||!s)return;if(!e||e.length===0){t.classList.add("hidden");return}t.classList.remove("hidden"),a&&(a.textContent=e.length);let o=e.some(r=>r.severity>=3);n&&n.classList.toggle("critical",o),s.innerHTML=e.map(r=>Dr(r)).join("")}function Dr(e){let t=e.severity===3?"critical":e.severity===2?"warning":"info",n=e.severity===3?"times-circle":e.severity===2?"exclamation-triangle":"info-circle",s="";return e.expected&&e.actual?s=`Expected: ${e.expected}, Actual: ${e.actual}`:e.maxDrift!==void 0?s=`Max: ${e.maxDrift} frames, Avg: ${e.avgDrift} frames`:e.secondsSinceSync!==void 0&&(s=`Last sync: ${e.secondsSinceSync}s ago`),`
    <div class="msm-issue-item">
      <div class="msm-issue-icon ${t}"><i class="fas fa-${n}"></i></div>
      <div class="msm-issue-content">
        <div class="msm-issue-host">${m(e.host||"Local")}</div>
        <div class="msm-issue-description">${m(e.description)}</div>
        ${s?`<div class="msm-issue-details">${m(s)}</div>`:""}
      </div>
    </div>
  `}async function nn(){try{let e=document.querySelector(".msm-refresh-btn i");e&&e.classList.add("fa-spin");let[t,n]=await Promise.all([fetch("/api/plugin-apis/fpp-plugin-watcher/multisync/status"),fetch("/api/fppd/status")]);if(!t.ok){Qt("C++ plugin not responding. Restart FPP to load the plugin.");return}let s=await t.json();g.localStatus=s,n.ok&&(g.localFppStatus=await n.json()),da(),await ma(s),ga(s);let a=await fetch("/api/plugin-apis/fpp-plugin-watcher/multisync/issues"),o=[];a.ok&&(o=(await a.json()).issues||[]),ve()?(await Ar(o),await Or()):(tn(o),ya(s),va(),ba(s,o),Ca(s),await wa(s)),ca()}catch(e){console.error("Error loading fast data:",e),Qt("Error connecting to multi-sync plugin: "+e.message)}finally{let e=document.querySelector(".msm-refresh-btn i");e&&e.classList.remove("fa-spin")}}async function sn(){try{if(ve()){let[e]=await Promise.all([fetch("/api/fppd/multiSyncSystems"),Ur(),an()]);if(e.ok){let t=await e.json();g.fppSystems=t.systems||[]}}else{let e=await fetch("/api/fppd/multiSyncSystems");if(e.ok){let t=await e.json();g.fppSystems=t.systems||[]}}g.slowDataLoaded=!0}catch(e){console.error("Error loading slow data:",e)}}async function Lt(){g.slowDataLoaded||await sn(),await nn()}async function Ar(e){try{let t=await fetch("/api/plugin/fpp-plugin-watcher/multisync/comparison");if(!t.ok)return;let n=await t.json();if(!n.success)return;let s=xa(n.remotes),a=n.issues.filter(l=>{if(l.type==="offline"){let c=s.find(d=>d.hostname===l.host||d.address===l.host);return c&&!c.online}return!0}),o=[...e,...a],r=s.filter(l=>l.online).length,i=s.filter(l=>l.pluginInstalled).length;Ma(s.length,r,i,o.length),tn(o),Ea(s),Ia(s,g.localStatus)}catch(t){console.error("Error loading comparison:",t)}}async function Ur(){try{let e=await fetch("/api/plugin/fpp-plugin-watcher/multisync/clock-drift");if(!e.ok)return;let t=await e.json();if(!t.success)return;g.clockDriftData={},(t.hosts||[]).forEach(n=>{g.clockDriftData[n.address]={drift_ms:n.drift_ms,rtt_ms:n.rtt_ms,hasPlugin:n.hasPlugin}}),g.systemsData.length>0&&Mt()}catch(e){console.error("Error loading clock drift:",e)}}async function Or(){if(!en()){Yt();return}try{let e=await fetch("/api/plugin/fpp-plugin-watcher/metrics/network-quality/current");if(!e.ok)return;let t=await e.json();if(!t.success)return;ka(t)}catch(e){console.error("Error loading network quality:",e)}}async function an(){if(!en()){Yt();return}let e=document.getElementById("qualityTimeRange"),t=(e==null?void 0:e.value)||6;try{let n=await fetch(`/api/plugin/fpp-plugin-watcher/metrics/network-quality/history?hours=${t}`);if(!n.ok)return;let s=await n.json();if(!s.success||!s.chartData)return;Sa(s.chartData),$a(s.chartData)}catch(n){console.error("Error loading quality charts:",n)}}async function La(){let e=g.systemsData.filter(s=>!s.isLocal&&s.hasMetrics),t=e.length,n=t>0?`Reset multi-sync metrics on this system and ${t} remote${t>1?"s":""}?`:"Reset all multi-sync metrics?";if(confirm(n))try{let s=[fetch("/api/plugin-apis/fpp-plugin-watcher/multisync/reset",{method:"POST"})];e.forEach(a=>{s.push(fetch(`http://${a.address}/api/plugin-apis/fpp-plugin-watcher/multisync/reset`,{method:"POST",mode:"cors"}).catch(o=>console.warn(`Failed to reset ${a.hostname}:`,o)))}),await Promise.all(s),await Lt()}catch(s){console.error("Error resetting:",s)}}var Ba={pageId:"multiSyncMetricsUI",init(e){ra(e),document.addEventListener("click",Xt),Lt(),g.fastRefreshInterval=setInterval(nn,2e3),g.slowRefreshInterval=setInterval(sn,3e4)},destroy(){document.removeEventListener("click",Xt),ia()},refresh:Lt,resetMetrics:La,toggleHelpTooltip:ua,loadQualityCharts:an};var Oe={efuseMonitorUI:Bn,falconMonitorUI:_n,configUI:Nn,localMetricsUI:Qn,connectivityUI:es,remoteMetricsUI:ss,remotePingUI:is,eventsUI:cs,remoteControlUI:oa,multiSyncMetricsUI:Ba};function Ta(){var s;let e=document.querySelector("[data-watcher-page]"),t=(s=e==null?void 0:e.dataset)==null?void 0:s.watcherPage,n=window.watcherConfig||{};t&&Oe[t]&&(Oe[t].init(n),window.page=Oe[t]),window.watcher={utils:et,charts:tt,api:nt,CHART_COLORS:j,pages:Oe}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ta):Ta();return Ua(qr);})();
