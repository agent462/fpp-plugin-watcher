var Watcher=(()=>{var Tt=Object.defineProperty;var Ma=Object.getOwnPropertyDescriptor;var Ba=Object.getOwnPropertyNames;var Ta=Object.prototype.hasOwnProperty;var Pa=(e,t)=>{for(var n in t)Tt(e,n,{get:t[n],enumerable:!0})},Fa=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Ba(t))!Ta.call(e,a)&&a!==n&&Tt(e,a,{get:()=>t[a],enumerable:!(s=Ma(t,a))||s.enumerable});return e};var Ra=e=>Fa(Tt({},"__esModule",{value:!0}),e);var _r={};Pa(_r,{CHART_COLORS:()=>j,api:()=>nt,charts:()=>tt,pages:()=>Oe,utils:()=>et});function f(e){if(e==null)return"";let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(e).replace(/[&<>"']/g,n=>t[n])}function Q(e){let t=document.getElementById(e);t&&(t.style.display="block")}function J(e){let t=document.getElementById(e);t&&(t.style.display="none")}function Ve(e,t){let n=document.getElementById(e);n&&(n.style.display=t?"flex":"none")}function oe(e){if(!e)return"0 Bytes";let t=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,n)).toFixed(2)+" "+t[n]}function be(e){return e!=null?e.toFixed(2)+" ms":"-- ms"}function pn(e,t=1){return e!=null?e.toFixed(t)+"%":"--%"}function We(e){if(!e||e<=0)return"--";let t=Math.floor(e/3600),n=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}h ${n}m ${s}s`:n>0?`${n}m ${s}s`:`${s}s`}function de(e){return e*9/5+32}function Y(e){return e?"\xB0F":"\xB0C"}function ke(e,t){return(t?de(e):e).toFixed(1)+Y(t)}function Ye(e){return e<40?{text:"Cool",color:"#38ef7d",icon:"\u2744\uFE0F"}:e<60?{text:"Normal",color:"#28a745",icon:"\u2705"}:e<80?{text:"Warm",color:"#ffc107",icon:"\u26A0\uFE0F"}:{text:"Hot",color:"#f5576c",icon:"\u{1F525}"}}function Le(e){if(!e)return e;let t={cpu:"CPU",gpu:"GPU",soc:"SoC",acpi:"ACPI",pch:"PCH"},n=e.replace(/[_-]/g," ").replace(/\b\w/g,s=>s.toUpperCase());return Object.entries(t).forEach(([s,a])=>{n=n.replace(new RegExp("\\b"+s+"\\b","gi"),a)}),n}function ee(e="lastUpdate"){let t=document.getElementById(e);t&&(t.textContent="Last updated: "+new Date().toLocaleTimeString())}var et={escapeHtml:f,showElement:Q,hideElement:J,setLoading:Ve,formatBytes:oe,formatLatency:be,formatPercent:pn,formatDuration:We,toFahrenheit:de,getTempUnit:Y,formatTemp:ke,getTempStatus:Ye,formatThermalZoneName:Le,updateLastUpdateTime:ee};var j={purple:{border:"rgb(102, 126, 234)",bg:"rgba(102, 126, 234, 0.1)"},red:{border:"rgb(245, 87, 108)",bg:"rgba(245, 87, 108, 0.1)"},green:{border:"rgb(56, 239, 125)",bg:"rgba(56, 239, 125, 0.1)"},blue:{border:"rgb(79, 172, 254)",bg:"rgba(79, 172, 254, 0.1)"},pink:{border:"rgb(240, 147, 251)",bg:"rgba(240, 147, 251, 0.1)"},orange:{border:"rgb(255, 159, 64)",bg:"rgba(255, 159, 64, 0.1)"},teal:{border:"rgb(75, 192, 192)",bg:"rgba(75, 192, 192, 0.1)"},coral:{border:"rgb(255, 99, 132)",bg:"rgba(255, 99, 132, 0.1)"},yellow:{border:"rgb(255, 193, 7)",bg:"rgba(255, 193, 7, 0.1)"},cyan:{border:"rgb(23, 162, 184)",bg:"rgba(23, 162, 184, 0.1)"},indigo:{border:"rgb(111, 66, 193)",bg:"rgba(111, 66, 193, 0.1)"}},fn=[j.purple,j.green,j.pink,j.blue,j.coral,j.yellow,j.cyan,j.indigo];function Me(e){return fn[e%fn.length]}function Pt(e){return e<=1?"minute":e<=24?"hour":e<=168?"day":"week"}function Ft(){return{minute:"HH:mm",hour:"MMM d, HH:mm",day:"MMM d",week:"MMM d, yyyy"}}function I(e,t,n,s={}){var o,r;let a=typeof n=="string"?j[n]||j.purple:n;return{label:e,data:t,borderColor:a.border,backgroundColor:a.bg,borderWidth:2,fill:(o=s.fill)!=null?o:!0,tension:0,spanGaps:!0,pointRadius:(r=s.pointRadius)!=null?r:0,pointHoverRadius:5,...s}}function H(e,t){return((e==null?void 0:e.data)||[]).map(n=>({x:n.timestamp*1e3,y:n[t]}))}function G(e,t={}){let{yLabel:n="Value",beginAtZero:s=!1,yMax:a,yTickFormatter:o=h=>h,tooltipLabel:r,showLegend:i=!0,animation:l=!1,decimationSamples:c=500,extraScales:d={}}=t,p=Pt(e),g=Ft();return{responsive:!0,maintainAspectRatio:!0,animation:l,interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{decimation:{enabled:!0,algorithm:"lttb",samples:c},legend:{display:i,position:"top"},tooltip:{callbacks:{title:h=>new Date(h[0].parsed.x).toLocaleString(),label:r||(h=>`${h.dataset.label}: ${h.parsed.y}`)}}},scales:{x:{type:"time",time:{unit:p,displayFormats:g,tooltipFormat:"MMM d, yyyy HH:mm:ss"},title:{display:!0,text:"Time",font:{size:14,weight:"bold"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.05)"}},y:{beginAtZero:s,...a!==void 0&&{max:a},title:{display:!0,text:n,font:{size:14,weight:"bold"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.05)"},ticks:{callback:o}},...d}}}function T(e,t,n,s,a,o){let r=document.getElementById(n);if(!r)return null;if(e[t]){let c=e[t];try{if(c.canvas&&c.canvas===r)return a.forEach((d,p)=>{c.data.datasets[p]?(c.data.datasets[p].data=d.data,c.data.datasets[p].label=d.label,d.borderColor&&(c.data.datasets[p].borderColor=d.borderColor),d.backgroundColor&&(c.data.datasets[p].backgroundColor=d.backgroundColor)):c.data.datasets.push(d)}),c.data.datasets.length=a.length,c.update("none"),c}catch(d){console.warn(`Chart ${t} has stale reference, recreating`)}try{e[t].destroy()}catch(d){}delete e[t]}let i=Chart.getChart(r);i&&i.destroy();let l=r.getContext("2d");return l?(e[t]=new Chart(l,{type:s,data:{datasets:a},options:o}),e[t]):null}var tt={CHART_COLORS:j,getChartColor:Me,getTimeUnit:Pt,getTimeFormats:Ft,createDataset:I,mapChartData:H,buildChartOptions:G,updateOrCreateChart:T};async function B(e,t=1e4){let n=new AbortController,s=setTimeout(()=>n.abort(),t);try{let a=await fetch(e,{signal:n.signal,cache:"no-store"});if(clearTimeout(s),!a.ok)throw new Error(`HTTP ${a.status}`);return await a.json()}catch(a){throw clearTimeout(s),a}}async function fe(e,t,n){let s=e==null?void 0:e.querySelector("i");s&&(s.className="fas fa-spinner fa-spin"),e&&(e.disabled=!0);try{return await n()}finally{s&&(s.className=t),e&&(e.disabled=!1)}}function mn(e,t=3e4){let n=!1,s=null,a={get isRefreshing(){return n},async refresh(o=!0){if(n)return;n=!0;let r=document.querySelector(".refreshButton i");r&&(r.style.animation="spin 1s linear infinite");try{await e(o)}finally{n=!1,r&&(r.style.animation="")}},startAutoRefresh(){s||(s=setInterval(()=>a.refresh(!1),t))},stopAutoRefresh(){s&&(clearInterval(s),s=null)}};return a}async function Be(){let e=localStorage.getItem("temperatureInF");if(e!==null)return e==="true";try{let{value:t}=await B("/api/settings/temperatureInF"),n=t==="1"||t===1;return localStorage.setItem("temperatureInF",n),n}catch(t){return!1}}var nt={fetchJson:B,withButtonLoading:fe,createRefreshController:mn,loadTemperaturePreference:Be};var st={0:"#1a1a2e",500:"#16213e",1e3:"#1e5128",2e3:"#4e9f3d",3e3:"#ffc107",4e3:"#fd7e14",5e3:"#dc3545",6e3:"#c82333"},Ha=6e3,Te=16,at=200,_a=500,Da=3e3,gn=["#4e9f3d","#3498db","#9b59b6","#e67e22","#1abc9c","#e74c3c","#34495e","#f1c40f","#16a085","#2ecc71","#8e44ad","#d35400","#00bcd4","#ff5722","#607d8b","#795548"],v={charts:{},currentPortData:{},selectedPort:null,selectedPortConfig:null,refreshInterval:null,chartSkeletonsCreated:!1,lastControlAction:0,confirmModalCallback:null,controlCapabilities:null,config:{}};function ze(e,t){if(!e||e.length<=t)return e;let n=[],s=(e.length-2)/(t-2);n.push(e[0]);for(let a=1;a<t-1;a++){let o=Math.floor((a-1)*s)+1,r=Math.min(Math.floor(a*s)+1,e.length-1),i=o,l=e[o].y;for(let c=o+1;c<r;c++)e[c].y>l&&(l=e[c].y,i=c);n.push(e[i])}return n.push(e[e.length-1]),n}function bn(e){return gn[e%gn.length]}function Cn(e){if(e<=0)return st[0];let t=Object.keys(st).map(Number).sort((n,s)=>n-s);for(let n=t.length-1;n>=0;n--)if(e>=t[n])return st[t[n]];return st[0]}function z(e,t=!0){return e==null?"--":e===0?t?"0 mA":"0":e>=1e3?(e/1e3).toFixed(2)+(t?" A":""):e+(t?" mA":"")}function rt(){let e=Date.now();return e-v.lastControlAction<_a?!1:(v.lastControlAction=e,!0)}function N(e,t="info",n=3e3){let s=document.getElementById("toastContainer");if(!s)return;let a=document.createElement("div");a.className=`toast toast-${t}`;let o={success:"fa-check-circle",error:"fa-exclamation-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"};a.innerHTML=`
    <i class="fas ${o[t]||o.info}"></i>
    <span>${f(e)}</span>
  `,s.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")}),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},n)}function wn(e,t,n,s){let a=document.getElementById("confirmModal");a&&(document.getElementById("confirmModalTitle").textContent=e,document.getElementById("confirmModalMessage").textContent=t,document.getElementById("confirmModalAction").textContent=n,v.confirmModalCallback=s,a.style.display="flex")}function xn(){let e=document.getElementById("confirmModal");e&&(e.style.display="none"),v.confirmModalCallback=null}function hn(){v.confirmModalCallback&&v.confirmModalCallback(),xn()}function En(e){let t=document.getElementById("efuseHistoryChartsContainer");if(!t||v.chartSkeletonsCreated)return;let n=Math.ceil(e/Te),s="";for(let a=0;a<n;a++){let o=a*Te+1,r=Math.min((a+1)*Te,e),i=`efuseHistoryChart_${a}`;s+=`
      <div class="efuseChartCard" id="chartCard_${a}">
        <div class="efuseChartTitle">
          <span><i class="fas fa-chart-area"></i> Current History - Ports ${o}-${r}</span>
        </div>
        <div class="chartLoading" id="chartLoading_${a}">
          <i class="fas fa-spinner fa-spin"></i> Loading chart data...
        </div>
        <canvas id="${i}" style="max-height: 400px;"></canvas>
      </div>
    `}t.innerHTML=s,v.chartSkeletonsCreated=!0;for(let a=0;a<n;a++)Ua(a)}function Ua(e){let t=`efuseHistoryChart_${e}`,n=`history_${e}`;if(v.charts[n])return;let s={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}}},y:{min:0,title:{display:!0,text:"mA"}}},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0}},tooltip:{callbacks:{label:function(a){return a.dataset.label+": "+z(a.raw.y)}}}}};T(v.charts,n,t,"line",[],s)}async function Ht(e,t=null){if(!rt()){N("Please wait before trying again","warning");return}try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/port/toggle",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({port:e,state:t})})).json();if(s.success){let a=s.newState==="on"?"enabled":"disabled";N(`${e} ${a}`,"success"),setTimeout(()=>me(),500)}else N(s.error||"Failed to toggle port","error")}catch(n){console.error("Error toggling port:",n),N("Network error","error")}}async function _t(e){if(!rt()){N("Please wait before trying again","warning");return}try{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/port/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({port:e})})).json();n.success?(N(`${e} fuse reset`,"success"),setTimeout(()=>me(),500)):N(n.error||"Failed to reset fuse","error")}catch(t){console.error("Error resetting fuse:",t),N("Network error","error")}}async function Aa(e){var t;if(!rt()){N("Please wait before trying again","warning");return}if(e==="off"){let n=((t=v.config)==null?void 0:t.ports)||16;wn("Disable All Ports?",`This will turn off all ${n} eFuse ports immediately. Your show will stop outputting to all connected pixels.`,"DISABLE ALL",()=>yn(e));return}yn(e)}async function yn(e){try{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/ports/master",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({state:e})})).json();n.success?(N(`All ports ${e==="on"?"enabled":"disabled"}`,"success"),setTimeout(()=>me(),500)):N(n.error||"Failed to set all ports","error")}catch(t){console.error("Error with master control:",t),N("Network error","error")}}async function Oa(){if(!rt()){N("Please wait before trying again","warning");return}try{let t=await(await fetch("/api/plugin/fpp-plugin-watcher/efuse/ports/reset-all",{method:"POST",headers:{"Content-Type":"application/json"}})).json();if(t.success){let n=t.resetCount||0;n>0?N(`Reset ${n} tripped fuse${n>1?"s":""}`,"success"):N("No fuses to reset","info"),setTimeout(()=>me(),500)}else N(t.error||"Failed to reset fuses","error")}catch(e){console.error("Error resetting fuses:",e),N("Network error","error")}}function qa(){if(!v.selectedPort)return;let e=v.currentPortData[v.selectedPort],t=(e==null?void 0:e.portEnabled)!==!1;Ht(v.selectedPort,t?"off":"on")}function ja(){v.selectedPort&&_t(v.selectedPort)}function Na(e,t,n){n?_t(e):Ht(e,t?"off":"on")}function Va(e){let t=document.getElementById("trippedBanner"),n=document.getElementById("resetTrippedBtn");if(!t)return;let s=Object.entries(e||{}).filter(([o,r])=>r.fuseTripped).map(([o])=>o),a=s.length;a>0?(t.style.display="flex",document.getElementById("trippedCount").textContent=a,document.getElementById("trippedPortList").textContent=s.join(", "),n&&(n.style.display="inline-flex",n.querySelector(".badge").textContent=a)):(t.style.display="none",n&&(n.style.display="none"))}function In(e){let t=document.getElementById("portOutputConfig");if(!t)return;let n=(e==null?void 0:e.portEnabled)!==!1,s=(e==null?void 0:e.fuseTripped)===!0,a="enabled",o="ENABLED";s?(a="tripped",o="TRIPPED"):n||(a="disabled",o="DISABLED");let c=`
    <div class="portControlRow">
      <div class="portStatusIndicator">
        <span class="statusDot ${a}"></span>
        <span>${o}</span>
      </div>
      <div class="portControlButtons">
        <button class="efuseControlBtn ${n?"danger":"primary"}" onclick="page.toggleSelectedPort()">
          <i class="fas fa-power-off"></i> ${n?"Disable":"Enable"}
        </button>
        <button class="efuseControlBtn warning" onclick="page.resetSelectedPort()" style="display: ${s?"inline-flex":"none"};">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
    </div>
  `;if(!e||!e.pixelCount){t.innerHTML=`
      <div class="outputConfigTitle">Output Configuration</div>
      <div class="noConfig">No output configuration found</div>
      ${c}
    `;return}let d=e.brightness!==null&&e.brightness!==void 0?e.brightness+"%":"--";t.innerHTML=`
    <div class="outputConfigTitle">Output Configuration</div>
    <div class="outputConfigGrid">
      <div class="configItem">
        <span class="configLabel">Type:</span>
        <span class="configValue">${f(e.protocol||"Unknown")}</span>
      </div>
      <div class="configItem">
        <span class="configLabel">Pixels:</span>
        <span class="configValue">${e.pixelCount||0}</span>
      </div>
      <div class="configItem">
        <span class="configLabel">Brightness:</span>
        <span class="configValue">${d}</span>
      </div>
      <div class="configItem">
        <span class="configLabel">Color Order:</span>
        <span class="configValue">${f(e.colorOrder||"RGB")}</span>
      </div>
      ${e.description?`
      <div class="configItem configDesc">
        <span class="configLabel">Description:</span>
        <span class="configValue">${f(e.description)}</span>
      </div>`:""}
    </div>
    <div class="expectedInfo">
      Expected: ~${z(e.expectedCurrentMa)} typical / ${z(e.maxCurrentMa)} max
    </div>
    ${c}
  `}function Sn(e){if(e){let t=v.selectedPortConfig?{...e,...v.selectedPortConfig}:e;In(t)}}function Wa(e){let t=document.getElementById("portDetailCurrent");t&&(t.textContent=z(e.currentMa));let n=document.getElementById("portDetailExpected");n&&(n.textContent=z(e.expectedCurrentMa))}function za(e){let t=e.totals||{},n=document.getElementById("totalCurrent");n&&(n.textContent=(t.totalAmps||0).toFixed(2)+" A");let s=document.getElementById("activePorts");s&&(s.textContent=(t.activePortCount||0)+" / "+(t.portCount||0))}function $n(e){let t=document.getElementById("efuseGrid");if(!t)return;let n=Object.entries(e||{}).sort((r,i)=>{let l=parseInt(r[0].replace(/\D/g,""))||0,c=parseInt(i[0].replace(/\D/g,""))||0;return l-c});if(n.length===0){t.innerHTML='<div class="empty-message"><i class="fas fa-plug"></i><h3>No Port Data</h3><p>No port data available</p></div>';return}let s=n.length,a=Math.min(8,s);t.style.gridTemplateColumns=`repeat(${a}, 1fr)`;let o="";for(let[r,i]of n){let l=i.currentMa||0,c=i.portEnabled!==!1,d=i.fuseTripped===!0,p=d?"#c82333":c?Cn(l):"#333",g=d?"tripped":i.status||"normal",h=Math.min(100,l/Ha*100),u=v.selectedPort===r?"selected":"",y=c?"":"disabled",b=d?"fa-exclamation-triangle":"fa-power-off",$=d?"tripped":c?"on":"off",M=d?"Reset fuse":c?"Disable port":"Enable port";o+=`
      <div class="efusePort ${g} ${u} ${y}"
           style="background: ${p};" title="Click to view ${f(r)} details">
        <button class="portPowerBtn ${$}" onclick="event.stopPropagation(); page.portPowerClick('${f(r)}', ${c}, ${d})" title="${M}">
          <i class="fas ${b}"></i>
        </button>
        <div class="portClickArea" onclick="page.showPortDetail('${f(r)}')">
          <div class="portName">${f(r.replace("Port","P"))}</div>
          <div class="portValue">${z(l,!1)}</div>
          <div class="portBar">
            <div class="portBarFill" style="width: ${h}%;"></div>
          </div>
        </div>
      </div>
    `}t.innerHTML=o}async function me(){try{let e=await B("/api/plugin/fpp-plugin-watcher/efuse/current");if(!e.success){console.error("Failed to load current data:",e.error);return}v.currentPortData=e.ports||{},ee("lastUpdate"),za(e),$n(e.ports),Va(e.ports),v.selectedPort&&v.currentPortData[v.selectedPort]&&(Wa(v.currentPortData[v.selectedPort]),Sn(v.currentPortData[v.selectedPort]))}catch(e){console.error("Error loading current data:",e)}}function Rt(e){let t=document.getElementById("efuseHistoryChartsContainer");t&&(t.innerHTML=`
    <div class="efuseChartCard">
      <div class="efuseChartTitle">
        <span><i class="fas fa-chart-area"></i> Current History</span>
      </div>
      <div class="empty-message">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Error Loading Data</h3>
        <p>${f(e)}</p>
      </div>
    </div>
  `)}function Ja(e){var h;let t=e.totalHistory||[],n=((h=document.getElementById("timeRange"))==null?void 0:h.value)||24,s=n==1?"1h":n+"h",a=document.getElementById("peakLabel");a&&(a.textContent=`Peak (${s})`);let o=document.getElementById("avgLabel");if(o&&(o.textContent=`Average (${s})`),t.length>0){let u=Math.max(...t.map(M=>M.max||M.value)),y=t.reduce((M,C)=>M+C.value,0)/t.length,b=document.getElementById("peakCurrent");b&&(b.textContent=z(u));let $=document.getElementById("avgCurrent");$&&($.textContent=z(Math.round(y)));return}let r=e.peaks||{},i=0,l=0,c=0;for(let u in r)r[u]>i&&(i=r[u]);let d=e.timeSeries||{};for(let u in d){let y=d[u];if(y.length>0){let b=y.reduce(($,M)=>$+(M.value||0),0);l+=b/y.length,c++}}let p=document.getElementById("peakCurrent");p&&(p.textContent=z(i));let g=document.getElementById("avgCurrent");g&&(g.textContent=c>0?z(Math.round(l/c)):"-- mA")}function Ga(e){let t=e.totalHistory||[],n=document.getElementById("totalHistoryCard");if(t.length===0){n&&(n.style.display="none");return}n&&(n.style.display="block");let s=t.map(p=>({x:new Date(p.timestamp*1e3),y:p.value/1e3})),a=t.map(p=>({x:new Date(p.timestamp*1e3),y:p.min/1e3})),o=t.map(p=>({x:new Date(p.timestamp*1e3),y:p.max/1e3})),r=ze(s,at),i=ze(a,at),c=[{label:"Max",data:ze(o,at),borderColor:"rgba(220, 53, 69, 0.8)",backgroundColor:"rgba(220, 53, 69, 0.1)",fill:"+1",borderWidth:1,pointRadius:0,tension:0},{label:"Average",data:r,borderColor:"#3498db",backgroundColor:"rgba(52, 152, 219, 0.1)",fill:!1,borderWidth:2,pointRadius:0,tension:0},{label:"Min",data:i,borderColor:"rgba(40, 167, 69, 0.8)",backgroundColor:"transparent",fill:!1,borderWidth:1,pointRadius:0,tension:0}],d={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}}},y:{min:0,title:{display:!0,text:"Amps"}}},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0}},tooltip:{callbacks:{label:function(p){return p.dataset.label+": "+p.raw.y.toFixed(2)+" A"}}}}};T(v.charts,"totalHistory","totalHistoryChart","line",c,d)}function Ka(e){var l;if(!document.getElementById("efuseHistoryChartsContainer"))return;let n=e.timeSeries||{},s=((l=v.config)==null?void 0:l.ports)||16;v.chartSkeletonsCreated||En(s);let a=Object.keys(n).filter(c=>n[c].length>0).sort((c,d)=>{let p=parseInt(c.replace(/\D/g,""))||0,g=parseInt(d.replace(/\D/g,""))||0;return p-g});if(a.length===0){let c=Math.ceil(s/Te);for(let d=0;d<c;d++){let p=document.getElementById(`chartLoading_${d}`);p&&(p.style.display="none");let g=`history_${d}`;v.charts[g]&&(v.charts[g].data.datasets=[],v.charts[g].update("none"))}return}let o=[];for(let c=0;c<a.length;c+=Te)o.push(a.slice(c,c+Te));let r=0;function i(){if(r>=o.length)return;let c=o[r],d=r,p=`history_${d}`,g=document.getElementById(`chartLoading_${d}`);g&&(g.style.display="none");let h=c.map((b,$)=>{let M=n[b],C=bn($),w=M.map(S=>{var _;return{x:new Date(S.timestamp*1e3),y:(_=S.value)!=null?_:0}});return w=ze(w,at),{label:b,data:w,borderColor:C,backgroundColor:C+"20",fill:!1,tension:0,pointRadius:0}}),u=`efuseHistoryChart_${d}`,y={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}},title:{display:!1}},y:{min:0,title:{display:!0,text:"mA"}}},plugins:{legend:{position:"top",labels:{boxWidth:12,usePointStyle:!0}},tooltip:{callbacks:{label:function(b){return b.dataset.label+": "+z(b.raw.y)}}}}};T(v.charts,p,u,"line",h,y),r++,r<o.length&&requestAnimationFrame(i)}requestAnimationFrame(i)}async function ot(){var t;let e=((t=document.getElementById("timeRange"))==null?void 0:t.value)||24;try{let n=await B(`/api/plugin/fpp-plugin-watcher/efuse/heatmap?hours=${e}`);if(!n.success){console.error("Failed to load heatmap data:",n.error),Rt("Failed to load data");return}try{Ka(n),Ga(n),Ja(n)}catch(s){console.error("Error updating chart:",s),Rt("Error rendering chart")}}catch(n){console.error("Error loading heatmap data:",n),Rt("Network error")}}function Za(e){let t=e.history||[],n=t.map(r=>{var i,l;return{x:new Date(r.timestamp*1e3),y:(l=(i=r.avg)!=null?i:r.value)!=null?l:0}}),s=t.map(r=>{var i,l;return{x:new Date(r.timestamp*1e3),y:(l=(i=r.max)!=null?i:r.value)!=null?l:0}}),a=[{label:"Average",data:n,borderColor:"#4e9f3d",backgroundColor:"rgba(78, 159, 61, 0.1)",fill:!0,tension:0,pointRadius:0},{label:"Max",data:s,borderColor:"#dc3545",borderDash:[5,5],fill:!1,tension:0,pointRadius:0}],o={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},scales:{x:{type:"time",time:{displayFormats:{hour:"HH:mm",minute:"HH:mm"}},title:{display:!1}},y:{min:0,title:{display:!0,text:"mA"}}},plugins:{legend:{position:"top"},tooltip:{callbacks:{label:function(r){return r.dataset.label+": "+z(r.raw.y)}}}}};T(v.charts,"portHistory","portHistoryChart","line",a,o)}async function Dt(e){var n;let t=((n=document.getElementById("timeRange"))==null?void 0:n.value)||24;try{let s=await B(`/api/plugin/fpp-plugin-watcher/efuse/history?port=${encodeURIComponent(e)}&hours=${t}`);if(!s.success){console.error("Failed to load port history:",s.error);return}let a=s.history||[];if(a.length>0){let o=0,r=0;a.forEach(i=>{let l=i.max||i.value||0;l>o&&(o=l),r+=i.avg||i.value||0}),document.getElementById("portDetailPeak").textContent=z(o),document.getElementById("portDetailAvg").textContent=z(Math.round(r/a.length))}if(Za(s),s.config){v.selectedPortConfig=s.config;let r={...v.currentPortData[e]||{},...s.config};In(r)}}catch(s){console.error("Error loading port history:",s)}}async function kn(e){v.selectedPort=e,$n(v.currentPortData);let t=document.getElementById("portDetailPanel");if(!t)return;document.getElementById("portDetailName").textContent=e;let n=v.currentPortData[e]||{};document.getElementById("portDetailCurrent").textContent=z(n.currentMa),document.getElementById("portDetailExpected").textContent=z(n.expectedCurrentMa),Sn(n),t.style.display="block",await Dt(e)}function Qa(){let e=document.getElementById("portDetailPanel");e&&(e.style.display="none"),v.selectedPort=null,v.selectedPortConfig=null}function Xa(e){e&&e.stopPropagation();let t=document.getElementById("expectedHelpModal");t&&(t.style.display="flex")}function Ya(){let e=document.getElementById("expectedHelpModal");e&&(e.style.display="none")}function eo(e){e&&e.stopPropagation();let t=document.getElementById("pageHelpModal");t&&(t.style.display="flex")}function to(){let e=document.getElementById("pageHelpModal");e&&(e.style.display="none")}function vn(){me(),ot(),v.selectedPort&&Dt(v.selectedPort)}function no(){var n;let e=((n=v.config)==null?void 0:n.ports)||16;En(e),me().then(()=>{let s=Object.keys(v.currentPortData);if(s.length>0){let a=v.currentPortData["Port 1"]?"Port 1":s.sort((o,r)=>{let i=parseInt(o.replace(/\D/g,""))||0,l=parseInt(r.replace(/\D/g,""))||0;return i-l})[0];kn(a)}}).catch(s=>{console.error("Error in initial load:",s)}),ot();let t=0;v.refreshInterval=setInterval(()=>{t++,me(),t%6===0&&(ot(),v.selectedPort&&Dt(v.selectedPort))},Da)}var Ln={pageId:"efuseMonitorUI",init(e){v.config=e,no()},destroy(){v.refreshInterval&&clearInterval(v.refreshInterval),Object.values(v.charts).forEach(e=>e.destroy()),v={charts:{},currentPortData:{},selectedPort:null,selectedPortConfig:null,refreshInterval:null,chartSkeletonsCreated:!1,lastControlAction:0,confirmModalCallback:null,controlCapabilities:null,config:{}}},refresh:vn,loadAllData:vn,loadCurrentData:me,loadHeatmapData:ot,showPortDetail:kn,closePortDetail:Qa,togglePort:Ht,resetFuse:_t,masterControl:Aa,resetAllTripped:Oa,toggleSelectedPort:qa,resetSelectedPort:ja,portPowerClick:Na,showExpectedHelp:Xa,hideExpectedHelp:Ya,showPageHelp:eo,hidePageHelp:to,showConfirmModal:wn,hideConfirmModal:xn,executeConfirmAction:hn,confirmModalCallback:hn,showToast:N,formatCurrent:z,getEfuseColor:Cn,getEfuseChartColor:bn,downsampleData:ze};var P={controllers:[],isRefreshing:!1,autoRefreshInterval:null,useFahrenheit:!1,configuredHosts:[],config:{}};function Mn(e){return P.useFahrenheit?de(e).toFixed(1)+Y(!0):e.toFixed(1)+Y(!1)}function Bn(e){return e>80?"#f5576c":e>60?"#ffc107":e>40?"#4facfe":"#38ef7d"}function Tn(e){return e>0&&e<11?"warning":e>=11&&e<=13?"good":e>13?"warning":"normal"}function so(e,t=!1){return`
    <div class="watcher-quick-stats">
      ${[{label:"Firmware",value:e==null?void 0:e.firmware_version},{label:"Mode",value:e==null?void 0:e.mode_name},{label:"Ports",value:e==null?void 0:e.num_ports},{label:"Uptime",value:e==null?void 0:e.uptime}].map(s=>`
        <div class="watcher-quick-stats__item">
          <span class="watcher-quick-stats__label">${s.label}</span>
          ${t?'<span class="watcher-skeleton watcher-skeleton--text watcher-skeleton--text-short" style="display:inline-block;"></span>':`<span class="watcher-quick-stats__value">${f(s.value)}</span>`}
        </div>
      `).join("")}
    </div>
  `}function ao(e,t=!1){let n=[{label:"CPU",celsius:e==null?void 0:e.temperature1},{label:"Temp1",celsius:e==null?void 0:e.temperature2},{label:"Temp2",celsius:e==null?void 0:e.temperature3}].filter(s=>s.celsius!==void 0&&s.celsius!==null);return`
    <div class="watcher-section-title"><i class="fas fa-thermometer-half"></i> Temperatures</div>
    <div class="watcher-temp-grid">
      ${(t?[{label:"CPU"},{label:"Temp1"},{label:"Temp2"}]:n).map(s=>{if(t)return`
            <div class="watcher-temp-item">
              <div class="watcher-temp-item__label">${s.label}</div>
              <div class="watcher-skeleton watcher-skeleton--temp"></div>
            </div>
          `;let a=Bn(s.celsius),o=Math.min(s.celsius/100*100,100);return`
          <div class="watcher-temp-item">
            <div class="watcher-temp-item__label">${s.label}</div>
            <div class="watcher-temp-item__value" style="color: ${a};">${Mn(s.celsius)}</div>
            <div class="watcher-temp-item__bar">
              <div class="watcher-temp-item__bar-fill" style="width: ${o}%; background-color: ${a};"></div>
            </div>
          </div>
        `}).join("")}
    </div>
  `}function oo(e,t=!1){if(t)return`
      <div class="watcher-section-title"><i class="fas fa-bolt"></i> Power</div>
      <div class="watcher-voltage-info">
        <div class="watcher-voltage-item">
          <span class="watcher-voltage-item__label">V1</span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:50px;"></span>
        </div>
        <div class="watcher-voltage-item">
          <span class="watcher-voltage-item__label">Input</span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:50px;"></span>
        </div>
      </div>
    `;let n=[];if(e!=null&&e.voltage1&&n.push({label:"V1",value:e.voltage1,status:"normal"}),e!=null&&e.voltage2){let s=e.voltage2.match(/([\d.]+)/),a=s?parseFloat(s[1]):0;n.push({label:"Input",value:e.voltage2,status:Tn(a)})}return n.length===0?"":`
    <div class="watcher-section-title"><i class="fas fa-bolt"></i> Power</div>
    <div class="watcher-voltage-info">
      ${n.map(s=>`
        <div class="watcher-voltage-item">
          <span class="watcher-voltage-item__label">${s.label}</span>
          <span class="watcher-voltage-item__value watcher-voltage-item__value--${s.status}">${f(s.value)}</span>
        </div>
      `).join("")}
    </div>
  `}function ro(e,t=!1){return t?`
      <div class="watcher-section-title"><i class="fas fa-lightbulb"></i> Pixels</div>
      <div class="watcher-pixel-info">
        <div class="watcher-pixel-total">
          <span class="watcher-pixel-total__label">Total Pixels</span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;height:1.5em;"></span>
        </div>
        <div class="watcher-pixel-banks">
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;"></span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;"></span>
          <span class="watcher-skeleton watcher-skeleton--text" style="display:inline-block;width:80px;"></span>
        </div>
      </div>
    `:`
    <div class="watcher-section-title"><i class="fas fa-lightbulb"></i> Pixels</div>
    <div class="watcher-pixel-info">
      <div class="watcher-pixel-total">
        <span class="watcher-pixel-total__label">Total Pixels</span>
        <span class="watcher-pixel-total__value">${((e.pixels_bank0||0)+(e.pixels_bank1||0)+(e.pixels_bank2||0)).toLocaleString()}</span>
      </div>
      <div class="watcher-pixel-banks">
        <span class="watcher-pixel-bank">Bank 0: ${(e.pixels_bank0||0).toLocaleString()}</span>
        <span class="watcher-pixel-bank">Bank 1: ${(e.pixels_bank1||0).toLocaleString()}</span>
        <span class="watcher-pixel-bank">Bank 2: ${(e.pixels_bank2||0).toLocaleString()}</span>
      </div>
    </div>
  `}function io(e,t,n=!1){return`
    <div class="watcher-details">
      <div class="watcher-details__row">
        <span class="watcher-details__label">IP Address</span>
        <a href="http://${f(e)}/" target="_blank" class="watcher-details__value watcher-details__link">${f(e)}</a>
      </div>
      <div class="watcher-details__row">
        <span class="watcher-details__label">Controller Time</span>
        ${n?'<span class="watcher-skeleton watcher-skeleton--text watcher-skeleton--text-medium" style="display:inline-block;"></span>':`<span class="watcher-details__value">${f((t==null?void 0:t.time)||"")} ${f((t==null?void 0:t.date)||"")}</span>`}
      </div>
    </div>
  `}function lo(e,t,n=!1){var i,l,c;if(n)return`
      <div class="watcher-card__footer">
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
        <span class="watcher-skeleton watcher-skeleton--btn"></span>
      </div>
    `;let s=(i=t.testMode)!=null&&i.enabled?"active":"",a=(l=t.testMode)!=null&&l.enabled?"Test mode is ON - Click to disable":"Click to enable test mode",r=((c=t.status)==null?void 0:c.product_code)===130?`
    <div class="watcher-card__footer-row watcher-fuse-controls">
      <button class="btn btn-sm btn-outline-success" onclick="page.setFuses(${e}, true)" title="Enable all fuses">
        <i class="fas fa-bolt"></i> Fuses On
      </button>
      <button class="btn btn-sm btn-outline-secondary" onclick="page.setFuses(${e}, false)" title="Disable all fuses">
        <i class="fas fa-bolt"></i> Fuses Off
      </button>
      <button class="btn btn-sm btn-outline-info" onclick="page.resetFuses(${e})" title="Reset all tripped fuses">
        <i class="fas fa-redo"></i> Reset Fuses
      </button>
    </div>
  `:"";return`
    <div class="watcher-card__footer">
      <a href="http://${f(t.host)}/" target="_blank" class="btn btn-sm btn-outline-primary">
        <i class="fas fa-external-link-alt"></i> Web UI
      </a>
      <button class="btn btn-sm btn-outline-warning watcher-test-btn ${s}"
              onclick="page.toggleTestMode(${e})" title="${a}">
        <i class="fas fa-lightbulb"></i> Test
      </button>
      <button class="btn btn-sm btn-outline-danger" onclick="page.rebootController(${e})" title="Reboot controller">
        <i class="fas fa-power-off"></i>
      </button>
      <button class="btn btn-sm btn-outline-secondary" onclick="page.refreshController(${e})">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
    ${r}
  `}function Je(e,t,n=!1){let s=document.createElement("div"),a=e.host||e,o=n?null:e.online,r=e.status,i="watcher-card",l="watcher-card__header",c="fa-microchip",d="";if(n?(l+=" watcher-card__header--loading",c="fa-spinner fa-spin",d='<span class="watcher-skeleton watcher-skeleton--badge"></span>'):o?d=`<span class="watcher-card__badge watcher-card__badge--online">${f((r==null?void 0:r.model)||"")}</span>`:(i+=" watcher-card--offline",l+=" watcher-card__header--offline",c="fa-times-circle",d='<span class="watcher-card__badge watcher-card__badge--offline">Offline</span>'),s.className=i,s.id="controller-"+t,!n&&!o)return s.innerHTML=`
      <div class="${l}">
        <div class="watcher-card__title"><i class="fas ${c}"></i> ${f(a)}</div>
        ${d}
      </div>
      <div class="watcher-card__body watcher-card__body--offline">
        <i class="fas fa-plug"></i>
        <p>Controller not responding</p>
        <small>${f(e.error||"Connection failed")}</small>
      </div>
    `,s;let p=n?a:(r==null?void 0:r.name)||a;return s.innerHTML=`
    <div class="${l}">
      <div class="watcher-card__title"><i class="fas ${c}"></i> ${f(p)}</div>
      ${d}
    </div>
    <div class="watcher-card__body">
      ${so(r,n)}
      ${ao(r,n)}
      ${oo(r,n)}
      ${ro(r,n)}
      ${io(a,r,n)}
    </div>
    ${lo(t,e,n)}
  `,s}function Pn(){document.getElementById("configPanel").classList.toggle("visible")}function co(){document.getElementById("discoveryResults").classList.remove("visible")}async function uo(){let e=document.getElementById("falconHosts").value;try{(await fetch("/api/plugin/fpp-plugin-watcher/falcon/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({hosts:e})})).ok?(Pn(),it()):alert("Failed to save configuration")}catch(t){console.error("Error saving configuration:",t),alert("Error saving configuration")}}function po(e){let t=document.getElementById("controllersGrid");document.getElementById("loadingIndicator").style.display="none",document.getElementById("noControllersMessage").style.display="none",t.style.display="grid",t.innerHTML="",e.forEach((n,s)=>{t.appendChild(Je({host:n},s,!0))})}function fo(){let e=document.getElementById("controllersGrid");e.innerHTML="",P.controllers.forEach((t,n)=>{e.appendChild(Je(t,n,!1))})}async function it(e=!0){var a,o;if(P.isRefreshing)return;P.isRefreshing=!0;let t=document.querySelector(".refreshButton i");t&&(t.style.animation="spin 1s linear infinite");let s=document.getElementById("controllersGrid").querySelector(".watcher-skeleton")!==null;e&&!s&&(document.getElementById("loadingIndicator").style.display="block",document.getElementById("controllersGrid").style.display="none",document.getElementById("noControllersMessage").style.display="none");try{let i=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/status")).json();if(i.success&&((a=i.controllers)==null?void 0:a.length)>0)P.controllers=i.controllers,fo(),document.getElementById("controllersGrid").style.display="grid",document.getElementById("noControllersMessage").style.display="none";else if(((o=i.controllers)==null?void 0:o.length)===0)document.getElementById("noControllersMessage").style.display="block",document.getElementById("controllersGrid").style.display="none";else throw new Error(i.error||"Failed to load controllers");document.getElementById("loadingIndicator").style.display="none",document.getElementById("lastUpdate").textContent="Last updated: "+new Date().toLocaleTimeString()}catch(r){console.error("Error loading controllers:",r),s||(document.getElementById("loadingIndicator").innerHTML=`
        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
        <p style="color: #dc3545;">Error loading controllers</p>
        <button class="btn btn-primary" onclick="watcher.pages.falconMonitor.loadAllControllers()">Retry</button>
      `)}finally{P.isRefreshing=!1,t&&(t.style.animation="")}}async function Ut(e){var a;let t=P.controllers[e];if(!t)return;let n=document.getElementById("controller-"+e);n&&(n.style.opacity="0.5");try{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/status?host="+encodeURIComponent(t.host))).json();if(r.success&&((a=r.controllers)==null?void 0:a.length)>0){P.controllers[e]=r.controllers[0];let i=Je(P.controllers[e],e,!1);n.replaceWith(i);return}}catch(o){console.error("Error refreshing controller:",o)}let s=document.getElementById("controller-"+e);s&&(s.style.opacity="1")}async function mo(e){let t=P.controllers[e];if(!(t!=null&&t.online))return;let n=document.getElementById("controller-"+e),s=n==null?void 0:n.querySelector(".watcher-test-btn");await fe(s,"fas fa-lightbulb",async()=>{var i;let a=((i=t.testMode)==null?void 0:i.enabled)||!1,r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:t.host,enable:!a,testMode:5})})).json();r.success?(t.testMode||(t.testMode={enabled:!1,mode:0}),t.testMode.enabled=r.testEnabled,s==null||s.classList.toggle("active",r.testEnabled),s&&(s.title=r.testEnabled?"Test mode is ON - Click to disable":"Click to enable test mode")):alert("Failed to toggle test mode: "+(r.error||"Unknown error"))})}async function go(e){var a;let t=P.controllers[e];if(!(t!=null&&t.online)||!confirm(`Are you sure you want to reboot ${((a=t.status)==null?void 0:a.name)||t.host}?`))return;let n=document.getElementById("controller-"+e),s=n==null?void 0:n.querySelector(".btn-outline-danger");await fe(s,"fas fa-power-off",async()=>{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:t.host})})).json();r.success?(t.online=!1,n.replaceWith(Je(t,e,!1))):alert("Failed to reboot: "+(r.error||"Unknown error"))})}async function ho(e,t){var r;let n=P.controllers[e];if(!(n!=null&&n.online))return;let s=t?"enable":"disable";if(!confirm(`Are you sure you want to ${s} all fuses on ${((r=n.status)==null?void 0:r.name)||n.host}?`))return;let a=document.getElementById("controller-"+e),o=a==null?void 0:a.querySelector(t?".btn-outline-success":".watcher-fuse-controls .btn-outline-secondary");await fe(o,"fas fa-bolt",async()=>{let l=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/fuses/master",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:n.host,enable:t})})).json();l.success?Ut(e):alert("Failed to "+s+" fuses: "+(l.error||"Unknown error"))})}async function yo(e){var a;let t=P.controllers[e];if(!(t!=null&&t.online)||!confirm(`Reset all fuses on ${((a=t.status)==null?void 0:a.name)||t.host}?`))return;let n=document.getElementById("controller-"+e),s=n==null?void 0:n.querySelector(".btn-outline-info");await fe(s,"fas fa-redo",async()=>{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/falcon/fuses/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:t.host})})).json();r.success?Ut(e):alert("Failed to reset fuses: "+(r.error||"Unknown error"))})}async function vo(){let e=document.querySelector('button[onclick*="discoverControllers"]'),t=document.getElementById("discoveryResults"),n=document.getElementById("discoveryList");n.innerHTML='<div style="text-align:center;padding:1rem;"><i class="fas fa-spinner fa-spin"></i> Scanning network...<br><small style="color:#6c757d;">This may take a few minutes</small></div>',t.classList.add("visible");let s="",a=window.location.hostname.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3})\.\d{1,3}$/);a&&(s=a[1]),await fe(e,"fas fa-search",async()=>{var o;try{let r="/api/plugin/fpp-plugin-watcher/falcon/discover"+(s?"?subnet="+s:""),l=await(await fetch(r)).json();l.success&&((o=l.controllers)==null?void 0:o.length)>0?(n.innerHTML=`
          <div style="margin-bottom:0.5rem;color:#6c757d;font-size:0.875rem;">
            Found ${l.count} controller(s) on subnet ${f(l.subnet)}
          </div>
          <div style="display:flex;flex-direction:column;gap:0.5rem;">
            ${l.controllers.map(c=>`
              <div class="watcher-discovery-item">
                <div>
                  <strong>${f(c.name||c.ip)}</strong>
                  ${c.model?`<span style="color:#6c757d;font-size:0.875rem;">(${f(c.model)})</span>`:""}
                  <br><small style="color:#6c757d;">${f(c.ip)}${c.firmware?` - FW: ${f(c.firmware)}`:""}</small>
                </div>
                <button class="btn btn-sm btn-outline-primary watcher-add-controller-btn" data-ip="${f(c.ip)}">
                  <i class="fas fa-plus"></i> Add
                </button>
              </div>
            `).join("")}
          </div>
          <div style="margin-top:0.75rem;">
            <button class="btn btn-sm btn-primary" onclick="watcher.pages.falconMonitor.addAllDiscoveredControllers()">
              <i class="fas fa-plus-circle"></i> Add All
            </button>
          </div>
        `,n.querySelectorAll(".watcher-add-controller-btn").forEach(c=>{c.addEventListener("click",()=>At(c.dataset.ip))})):l.success?n.innerHTML=`<div style="text-align:center;padding:1rem;color:#6c757d;"><i class="fas fa-info-circle"></i> No Falcon controllers found on subnet ${f(l.subnet)}</div>`:n.innerHTML=`<div style="text-align:center;padding:1rem;color:#dc3545;"><i class="fas fa-exclamation-triangle"></i> ${f(l.error||"Discovery failed")}</div>`}catch(r){console.error("Error discovering controllers:",r),n.innerHTML='<div style="text-align:center;padding:1rem;color:#dc3545;"><i class="fas fa-exclamation-triangle"></i> Error during discovery</div>'}})}function At(e){let t=document.getElementById("falconHosts"),n=t.value.split(",").map(s=>s.trim()).filter(s=>s);n.includes(e)||(n.push(e),t.value=n.join(", "))}function bo(){document.querySelectorAll("#discoveryList .watcher-add-controller-btn").forEach(e=>{e.dataset.ip&&At(e.dataset.ip)})}async function Co(){P.configuredHosts.length>0&&po(P.configuredHosts);try{let t=await(await fetch("/api/settings/temperatureInF")).json();P.useFahrenheit=t.value==="1"||t.value===1}catch(e){console.warn("Could not fetch temperature setting")}it(),P.autoRefreshInterval=setInterval(()=>it(!1),3e4),window.addEventListener("beforeunload",()=>{P.autoRefreshInterval&&(clearInterval(P.autoRefreshInterval),P.autoRefreshInterval=null)})}var Fn={pageId:"falconMonitorUI",init(e){P.config=e,P.configuredHosts=e.configuredHosts||[],Co()},destroy(){P.autoRefreshInterval&&clearInterval(P.autoRefreshInterval),P={controllers:[],isRefreshing:!1,autoRefreshInterval:null,useFahrenheit:!1,configuredHosts:[],config:{}}},loadAllControllers:it,refreshController:Ut,toggleTestMode:mo,rebootController:go,setFuses:ho,resetFuses:yo,discoverControllers:vo,addDiscoveredController:At,addAllDiscoveredControllers:bo,toggleConfig:Pn,hideDiscoveryResults:co,saveConfiguration:uo,formatTemperature:Mn,getTempColor:Bn,getVoltageStatus:Tn,createControllerCard:Je};var ge={isPlayerMode:!1,watcherEditorOriginalContent:"",config:{}};function Rn(e,t,n){let a=3600/e*6,o=50+18*n,r=a*o,i=t*86400,l=Math.min(360,Math.floor(i/60)),c=Math.min(576,Math.floor(i/300)),d=Math.min(672,Math.floor(i/1800)),p=Math.floor(i/7200),g=50+80*n,h=(l+c+d+p)*g;return r+h}function Ot(){let e=document.getElementById("efuseCollectionInterval"),t=document.getElementById("efuseRetentionDays"),n=document.getElementById("efuseStorageEstimate");if(!e||!t||!n)return;let s=parseInt(e.value),a=parseInt(t.value),o=[4,8,16,32],r='<div class="storageEstimateTitle"><i class="fas fa-hdd"></i> Estimated Storage</div>';r+='<div class="storageEstimateGrid">',o.forEach(i=>{let l=Rn(s,a,i);r+=`<div class="storageEstimateItem">
      <span class="storageEstimatePorts">${i} ports</span>
      <span class="storageEstimateSize">${oe(l)}</span>
    </div>`}),r+="</div>",n.innerHTML=r}function wo(){let e=document.getElementById("efuseMonitorEnabled"),t=document.getElementById("efuseOptionsContainer");e&&t&&(t.style.display=e.checked?"":"none",e.checked&&Ot())}function xo(e){e.closest(".settingsPanel").classList.toggle("collapsed")}function Eo(e){e.key==="Enter"&&(e.preventDefault(),Hn())}function Hn(){let e=document.getElementById("newHostInput"),t=e.value.trim();if(!t)return;if(Array.from(document.querySelectorAll('input[name="testHosts[]"]')).map(o=>o.value).includes(t)){alert("This host is already in the list");return}let s=document.getElementById("testHostsContainer"),a=document.createElement("span");a.className="tag",a.innerHTML=`
    ${f(t)}
    <i class="fas fa-times tagRemove" onclick="page.watcherRemoveTag(this)"></i>
    <input type="hidden" name="testHosts[]" value="${f(t)}">
  `,s.insertBefore(a,e),e.value=""}function Io(e){e.closest(".tag").remove()}async function So(){let e=document.getElementById("clearResetStateBtn"),t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Clearing...';try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/connectivity/state/clear",{method:"POST",headers:{"Content-Type":"application/json"}})).json();s.success?window.location.reload():(alert("Failed to clear reset state: "+(s.error||"Unknown error")),e.disabled=!1,e.innerHTML=t)}catch(n){alert("Error clearing reset state: "+n.message),e.disabled=!1,e.innerHTML=t}}async function lt(){let e=document.getElementById("dataStatsContainer");try{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/data/stats")).json();if(!n.success){e.innerHTML='<div class="dataStatsError">Failed to load data statistics</div>';return}let s='<div class="dataAccordion">',a=0,o=0;for(let[r,i]of Object.entries(n.categories)){if(i.playerOnly&&!ge.isPlayerMode)continue;a+=i.totalSize,o+=i.fileCount;let l=i.fileCount>0,c=i.showFiles!==!1,d=l&&c,p=d?"expandable":"",g=i.warning?"expanded":"";if(s+=`<div class="dataAccordionItem ${g}" data-category="${f(r)}">
        <div class="dataAccordionHeader ${p}" onclick="${d?"page.toggleDataAccordion(this)":""}">
          <div class="dataAccordionTitle">
            ${d?'<i class="fas fa-chevron-right dataAccordionChevron"></i>':'<i class="fas fa-database dataAccordionIcon"></i>'}
            <strong>${f(i.name)}</strong>
            <span class="dataAccordionBadge">${i.fileCount} file${i.fileCount!==1?"s":""}</span>
            <span class="dataAccordionSize">${oe(i.totalSize)}</span>
          </div>
          <div class="dataAccordionActions">
            <button type="button" class="buttons btn-sm btn-outline-danger"
              onclick="event.stopPropagation(); page.clearDataCategory('${f(r)}', '${f(i.name)}')"
              ${l?"":"disabled"}>
              <i class="fas fa-trash"></i> Clear All
            </button>
          </div>
        </div>`,d||i.warning){if(s+='<div class="dataAccordionBody">',s+=`<div class="dataAccordionDesc">${f(i.description)}</div>`,i.warning&&(s+=`<div class="dataWarningInline"><i class="fas fa-info-circle"></i> ${f(i.warning)}</div>`),c&&l){let h=[...i.files].sort((u,y)=>y.modified-u.modified);s+='<div class="dataFileList">';for(let u of h){let y=new Date(u.modified*1e3).toLocaleString(),b=u.name.endsWith(".log")||u.name.endsWith(".json");s+=`<div class="dataFileItem">
              <div class="dataFileInfo">
                <i class="fas fa-file dataFileIcon"></i>
                <span class="dataFileName">${f(u.name)}</span>
                <span class="dataFileMeta">${oe(u.size)} &bull; ${y}</span>
              </div>
              <div class="dataFileActions">
                ${b?`<button type="button" class="buttons btn-xs btn-outline-secondary"
                  onclick="page.viewDataFile('${f(r)}', '${f(u.name)}')"
                  title="View file contents">
                  <i class="fas fa-eye"></i>
                </button>`:""}
                <button type="button" class="buttons btn-xs btn-outline-danger"
                  onclick="page.clearDataFile('${f(r)}', '${f(u.name)}')"
                  title="Delete file">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>`}s+="</div>"}else c&&!l&&(s+='<div class="dataEmptyMessage"><i class="fas fa-check-circle"></i> No data files</div>');s+="</div>"}s+="</div>"}s+=`</div>
      <div class="dataTotalRow">
        <strong>Total:</strong> ${o} files &bull; ${oe(a)}
      </div>`,e.innerHTML=s}catch(t){e.innerHTML='<div class="dataStatsError">Error loading data statistics: '+f(t.message)+"</div>"}}function $o(e){e.closest(".dataAccordionItem").classList.toggle("expanded")}async function ko(e,t){var n;if(confirm(`Are you sure you want to clear all ${t} data?

This action cannot be undone.`))try{let a=await(await fetch(`/api/plugin/fpp-plugin-watcher/data/${encodeURIComponent(e)}`,{method:"DELETE"})).json();a.success?lt():alert("Failed to clear data: "+(((n=a.errors)==null?void 0:n.join(", "))||"Unknown error"))}catch(s){alert("Error clearing data: "+s.message)}}async function Lo(e,t){if(confirm(`Delete "${t}"?

This action cannot be undone.`))try{let s=await(await fetch(`/api/plugin/fpp-plugin-watcher/data/${encodeURIComponent(e)}/${encodeURIComponent(t)}`,{method:"DELETE"})).json();s.success?lt():alert("Failed to delete file: "+(s.error||"Unknown error"))}catch(n){alert("Error deleting file: "+n.message)}}async function Mo(e,t){let n=document.getElementById("terminalModal"),s=document.getElementById("terminalModalTitle"),a=document.getElementById("terminalContent");n.dataset.category=e,n.dataset.filename=t,s.textContent=t,a.textContent="Loading...",n.style.display="flex",await _n()}async function _n(){let e=document.getElementById("terminalModal"),t=document.getElementById("terminalContent"),n=e.dataset.category,s=e.dataset.filename;try{let o=await(await fetch(`/api/plugin/fpp-plugin-watcher/data/${encodeURIComponent(n)}/${encodeURIComponent(s)}/tail?lines=100`)).json();o.success?(t.textContent=o.content||"(empty file)",t.scrollTop=t.scrollHeight):t.textContent="Error: "+(o.error||"Failed to load file")}catch(a){t.textContent="Error: "+a.message}}function Dn(){document.getElementById("terminalModal").style.display="none"}async function Bo(){let e=document.getElementById("collectdViewerModal"),t=document.getElementById("collectdViewerContent");t.textContent="Loading...",e.style.display="flex";try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/config/collectd")).json();s.success?t.textContent=s.content||"(empty file)":t.textContent="Error: "+(s.error||"Failed to load configuration")}catch(n){t.textContent="Error: "+n.message}}function Un(){document.getElementById("collectdViewerModal").style.display="none"}async function To(){let e=document.getElementById("watcherEditorModal"),t=document.getElementById("watcherEditorContent"),n=document.getElementById("watcherEditorStatus");t.value="Loading...",n.textContent="",n.className="configEditorStatus",e.style.display="flex";try{let a=await(await fetch("/api/plugin/fpp-plugin-watcher/config/watcher")).json();a.success?(t.value=a.content,ge.watcherEditorOriginalContent=a.content):(t.value="Error: "+(a.error||"Failed to load configuration"),n.textContent="Load failed",n.className="configEditorStatus error")}catch(s){t.value="Error: "+s.message,n.textContent="Load failed",n.className="configEditorStatus error"}}async function Po(){let e=document.getElementById("watcherEditorContent"),t=document.getElementById("saveWatcherBtn"),n=document.getElementById("watcherEditorStatus"),s=e.value;if(s===ge.watcherEditorOriginalContent){n.textContent="No changes to save",n.className="configEditorStatus";return}let a=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...',n.textContent="",n.className="configEditorStatus";try{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/config/watcher",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:s})})).json();r.success?(ge.watcherEditorOriginalContent=s,n.textContent="Saved! Some changes may require FPP restart.",n.className="configEditorStatus"):(n.textContent="Error: "+(r.error||"Failed to save"),n.className="configEditorStatus error")}catch(o){n.textContent="Error: "+o.message,n.className="configEditorStatus error"}finally{t.disabled=!1,t.innerHTML=a}}function An(){let e=document.getElementById("watcherEditorModal");document.getElementById("watcherEditorContent").value!==ge.watcherEditorOriginalContent&&!confirm("You have unsaved changes. Are you sure you want to close?")||(e.style.display="none")}function On(e){return document.querySelectorAll('input[name="testHosts[]"]').length===0?(e.preventDefault(),alert("Please add at least one test host"),!1):!0}function Fo(){document.addEventListener("keydown",function(e){if(e.key==="Escape"){let t=document.getElementById("terminalModal"),n=document.getElementById("collectdViewerModal"),s=document.getElementById("watcherEditorModal");s&&s.style.display==="flex"?An():n&&n.style.display==="flex"?Un():t&&t.style.display==="flex"&&Dn()}})}function Ro(){let e=document.querySelector(".settingsPanel:has(#dataStatsContainer)");e&&new MutationObserver(function(n){n.forEach(function(s){s.type==="attributes"&&s.attributeName==="class"&&(e.classList.contains("collapsed")||lt())})}).observe(e,{attributes:!0})}function Ho(){Ot();let e=document.getElementById("watcherSettingsForm");e&&e.addEventListener("submit",On),Fo(),Ro()}var qn={pageId:"configUI",init(e){ge.config=e,ge.isPlayerMode=e.isPlayerMode||!1,Ho()},destroy(){ge={isPlayerMode:!1,watcherEditorOriginalContent:"",config:{}}},calculateEfuseStorage:Rn,updateEfuseStorageEstimate:Ot,toggleEfuseOptions:wo,watcherTogglePanel:xo,watcherHandleTagKeypress:Eo,watcherAddTag:Hn,watcherRemoveTag:Io,clearResetState:So,loadDataStats:lt,toggleDataAccordion:$o,clearDataCategory:ko,clearDataFile:Lo,viewDataFile:Mo,refreshTerminalContent:_n,closeTerminalModal:Dn,viewCollectdConfig:Bo,closeCollectdViewer:Un,openWatcherEditor:To,saveWatcherConfig:Po,closeWatcherEditor:An,validateForm:On};var U={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,config:{}},jn=()=>{var e;return((e=document.getElementById("timeRange"))==null?void 0:e.value)||"12"},dt=()=>{var e;return((e=U.config)==null?void 0:e.defaultAdapter)||"default"},_o=()=>{var e;return((e=document.getElementById("interfaceSelect"))==null?void 0:e.value)||dt()};async function Do(){try{U.useFahrenheit=await Be();let e=await B("/api/system/status");Uo(e),Ao(e)}catch(e){console.error("Error loading system status:",e)}}function Uo(e){var s;let t=document.getElementById("temperatureStatusBar");if(!t)return;let n=((s=e==null?void 0:e.sensors)==null?void 0:s.filter(a=>a.valueType==="Temperature"))||[];if(!n.length){t.style.display="none";return}t.innerHTML=n.map((a,o)=>{let r=parseFloat(a.value)||0,i=Ye(r),l=Math.min(r,100),c=a.label.replace(":","").trim(),d=ke(r,U.useFahrenheit);return`<div${o<n.length-1?' style="margin-bottom: 1.5rem;"':""}>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-thermometer-half" style="color: ${i.color};"></i><strong>${f(c)}</strong>
                </div>
                <span style="font-size: 1.5rem; font-weight: bold; color: ${i.color};">${d}</span>
            </div>
            <div class="progressBar" style="background-color: #e9ecef; height: 24px; border-radius: 4px; overflow: hidden;">
                <div style="width: ${l}%; height: 100%; background: ${i.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; font-weight: 500;">${d}</div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: #6c757d;">
                <span>${ke(0,U.useFahrenheit)}</span><span>Status: ${i.icon} ${i.text}</span><span>${ke(100,U.useFahrenheit)}</span>
            </div>
        </div>`}).join(""),t.style.display="block"}function Ao(e){var l,c,d;let t=document.getElementById("diskStatusBar");if(!t)return;let n=(d=(c=(l=e==null?void 0:e.advancedView)==null?void 0:l.Utilization)==null?void 0:c.Disk)==null?void 0:d.Root;if(!n){t.style.display="none";return}let{Free:s=0,Total:a=1}=n,o=a-s,r=o/a*100,i=r>90?"#f5576c":r>75?"#ffc107":"#38ef7d";t.innerHTML=`<div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <strong>Root Filesystem</strong><span style="font-weight: 500;">${oe(o)} / ${oe(a)}</span>
        </div>
        <div class="progressBar" style="background-color: #e9ecef; height: 24px; border-radius: 4px; overflow: hidden;">
            <div style="width: ${r}%; height: 100%; background: ${i}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; font-weight: 500;">${r.toFixed(1)}% Used</div>
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6c757d;">
            <i class="fas fa-check-circle" style="color: #28a745;"></i> Available: ${oe(s)}
        </div>
    </div>`,t.style.display="block"}var Nn=[{key:"memory",canvasId:"memoryChart",loadingId:"memoryLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/memory/free?hours=${e}`,prepare:e=>{var l;if(!(e!=null&&e.success)||!((l=e.data)!=null&&l.length))return null;let t=e.data.filter(c=>c.free_mb!==null).map(c=>c.free_mb),n=e.data.filter(c=>c.buffer_cache_mb!==null).map(c=>c.buffer_cache_mb);if(!t.length)return null;let s=document.getElementById("currentMemory"),a=document.getElementById("avgMemory"),o=document.getElementById("currentBufferCache"),r=document.getElementById("avgBufferCache");s&&(s.textContent=t.at(-1).toFixed(1)+" MB"),a&&(a.textContent=(t.reduce((c,d)=>c+d)/t.length).toFixed(1)+" MB"),n.length&&o&&(o.textContent=n.at(-1).toFixed(1)+" MB",r&&(r.textContent=(n.reduce((c,d)=>c+d)/n.length).toFixed(1)+" MB"));let i=[I("Free Memory",H(e,"free_mb"),"purple")];return n.length&&i.push(I("Buffer Cache",H(e,"buffer_cache_mb"),"teal",{fill:!1})),{datasets:i,opts:{yLabel:"Memory (MB)",yTickFormatter:c=>c.toFixed(0)+" MB",tooltipLabel:c=>c.dataset.label+": "+c.parsed.y.toFixed(1)+" MB"}}}},{key:"cpu",canvasId:"cpuChart",loadingId:"cpuLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/cpu/average?hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[I("CPU Usage (%)",H(e,"cpu_usage"),"red")],opts:{yLabel:"CPU Usage (%)",beginAtZero:!0,yMax:100,yTickFormatter:n=>n.toFixed(0)+"%",tooltipLabel:n=>"CPU Usage: "+n.parsed.y.toFixed(2)+"%"}}}},{key:"load",canvasId:"loadChart",loadingId:"loadLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/load/average?hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[I("1 min",H(e,"shortterm"),"coral",{fill:!1}),I("5 min",H(e,"midterm"),"orange",{fill:!1}),I("15 min",H(e,"longterm"),"teal",{fill:!1})],opts:{yLabel:"Load Average",beginAtZero:!0,yTickFormatter:n=>n.toFixed(2),tooltipLabel:n=>n.dataset.label+" Load: "+n.parsed.y.toFixed(2)}}}},{key:"disk",canvasId:"diskChart",loadingId:"diskLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/disk/free?hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[I("Free Space (GB)",H(e,"free_gb"),"green")],opts:{yLabel:"Free Space (GB)",yTickFormatter:n=>n.toFixed(1)+" GB",tooltipLabel:n=>"Free Space: "+n.parsed.y.toFixed(2)+" GB"}}}},{key:"network",canvasId:"networkChart",loadingId:"networkLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/interface/bandwidth?interface=${_o()}&hours=${e}`,prepare:e=>{var t;return!(e!=null&&e.success)||!((t=e.data)!=null&&t.length)?null:{datasets:[I("Download (RX)",H(e,"rx_kbps"),"blue"),I("Upload (TX)",H(e,"tx_kbps"),"pink")],opts:{yLabel:"Bandwidth (Kbps)",beginAtZero:!0,yTickFormatter:n=>n.toFixed(0)+" Kbps",tooltipLabel:n=>n.dataset.label+": "+n.parsed.y.toFixed(2)+" Kbps"}}}},{key:"thermal",canvasId:"thermalChart",cardId:"thermalCard",loadingId:"thermalLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/thermal?hours=${e}`,prepare:e=>{var o,r;if(!(e!=null&&e.success)||!((o=e.data)!=null&&o.length)||!((r=e.zones)!=null&&r.length))return{hidden:!0};let t=["coral","blue","yellow","teal","indigo","orange","green","pink"],n=Y(U.useFahrenheit),s=(i,l)=>H(i,l).map(c=>({x:c.x,y:U.useFahrenheit?de(c.y):c.y})),a=i=>{var l;return Le(((l=e.zone_names)==null?void 0:l[i])||i)};return{datasets:e.zones.map((i,l)=>I(a(i),s(e,i),t[l%t.length],{fill:!1})),opts:{yLabel:`Temperature (${n})`,yTickFormatter:i=>i.toFixed(0)+n,tooltipLabel:i=>i.dataset.label+": "+i.parsed.y.toFixed(1)+n}}}},{key:"wireless",canvasId:"wirelessChart",cardId:"wirelessCard",loadingId:"wirelessLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/wireless?hours=${e}`,prepare:e=>{var s,a,o;if(!(e!=null&&e.success)||!((s=e.data)!=null&&s.length)||!((a=e.interfaces)!=null&&a.length))return{hidden:!0};let t={signal_quality:"teal",signal_power:"coral",signal_noise:"orange"},n=[];return(o=(e.available_metrics||{})[e.interfaces[0]])==null||o.forEach(r=>{let i=`${e.interfaces[0]}_${r}`,l=r.replace("signal_","").replace("_"," ").replace(/^./,c=>c.toUpperCase());n.push(I(`${e.interfaces[0]} - ${l}`,H(e,i),t[r]||"teal",{fill:!1}))}),n.length?{datasets:n,opts:{yLabel:"Signal Metrics",yTickFormatter:r=>r.toFixed(0),tooltipLabel:r=>r.dataset.label+": "+r.parsed.y.toFixed(1)}}:{hidden:!0}}},{key:"apache",canvasId:"apacheChart",cardId:"apacheCard",loadingId:"apacheLoading",url:e=>`/api/plugin/fpp-plugin-watcher/metrics/apache?hours=${e}`,prepare:e=>{var s;if(!(e!=null&&e.success)||!((s=e.data)!=null&&s.length))return{hidden:!0};let t=e.data.some(a=>a.requests_per_sec!==null),n=e.data.some(a=>a.connections!==null);return!t&&!n?{hidden:!0}:{datasets:[I("Requests/sec",H(e,"requests_per_sec"),"blue",{fill:!1}),I("Connections",H(e,"connections"),"coral",{fill:!1,yAxisID:"y1"}),I("Idle Workers",H(e,"idle_workers"),"teal",{fill:!1,yAxisID:"y1"})],opts:{yLabel:"Requests/sec",beginAtZero:!0,yTickFormatter:a=>a.toFixed(1),tooltipLabel:a=>a.dataset.label+": "+a.parsed.y.toFixed(2),extraScales:{y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"Connections / Workers"},grid:{drawOnChartArea:!1},beginAtZero:!0}}}}}}];async function Vn(e,t){let n=!U.charts[e.key];n&&Ve(e.loadingId,!0);try{let s=e.prepare(await B(e.url(t)));if(!s||s.hidden){if(e.cardId){let a=document.getElementById(e.cardId);a&&(a.style.display="none")}}else{if(e.cardId){let a=document.getElementById(e.cardId);a&&(a.style.display="block")}T(U.charts,e.key,e.canvasId,"line",s.datasets,G(t,s.opts))}}catch(s){if(console.error(`Error updating ${e.key}:`,s),e.cardId){let a=document.getElementById(e.cardId);a&&(a.style.display="none")}}n&&Ve(e.loadingId,!1)}function Oo(e){let t=Nn.find(n=>n.key===e);t&&Vn(t,jn())}async function Wn(){let e=jn();await Promise.all(Nn.map(t=>Vn(t,e)))}async function qo(){try{let{success:e,interfaces:t=[]}=await B("/api/plugin/fpp-plugin-watcher/metrics/interface/list");if(!e||!t.length)return;let n=document.getElementById("interfaceSelect");if(!n)return;let s=n.options.length===1?dt():n.value;n.innerHTML=t.map(a=>`<option value="${f(a)}">${f(a)}</option>`).join(""),n.value=t.includes(s)?s:t.includes(dt())?dt():t[0]}catch(e){console.error("Error loading interfaces:",e)}}async function ct(){if(U.isRefreshing)return;U.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{qo(),await Do(),await Wn(),ee()}catch(t){console.error("Error loading metrics:",t)}e&&(e.style.animation=""),U.isRefreshing=!1}var zn={pageId:"localMetricsUI",init(e={}){U.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ct):ct(),U.refreshInterval=setInterval(()=>{U.isRefreshing||ct()},3e4)},destroy(){U.refreshInterval&&clearInterval(U.refreshInterval),Object.values(U.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),U={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,config:{}}},refresh:ct,refreshMetric:Oo,updateAllCharts:Wn};var K={charts:{},isRefreshing:!1,refreshInterval:null,config:{}};async function jo(){try{let e=await B("/api/plugin/fpp-plugin-watcher/connectivity/state"),t=document.getElementById("networkResetBanner"),n=document.getElementById("resetDetails");if(!t||!n)return;if(e.success&&e.hasResetAdapter){let s=e.resetTime||"Unknown time",a=e.adapter||"Unknown adapter",o=e.reason||"Max failures reached";n.innerHTML=`The network adapter <strong>${f(a)}</strong> was reset on <strong>${f(s)}</strong>.<br>Reason: ${f(o)}`,t.style.display="block"}else t.style.display="none"}catch(e){console.error("Error checking network reset state:",e)}}async function No(){let e=event.target.closest("button");if(!e)return;let t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Clearing...';try{let s=await(await fetch("/api/plugin/fpp-plugin-watcher/connectivity/state/clear",{method:"POST"})).json();if(s.success){let a=document.getElementById("networkResetBanner");a&&(a.style.display="none"),Ge()}else alert("Failed to clear reset state: "+(s.error||"Unknown error")),e.disabled=!1,e.innerHTML=t}catch(n){console.error("Error clearing reset state:",n),alert("Failed to clear reset state: "+n.message),e.disabled=!1,e.innerHTML=t}}async function Jn(){var g,h;let e=parseInt(((g=document.getElementById("timeRange"))==null?void 0:g.value)||"12"),t=await B(`/api/plugin/fpp-plugin-watcher/metrics/ping/rollup?hours=${e}`),n=document.getElementById("noDataMessage"),s=document.getElementById("statsBarSection"),a=document.getElementById("rollupChartsSection");if(!t.success||!((h=t.data)!=null&&h.length))return s&&(s.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="block"),!1;n&&(n.style.display="none"),s&&(s.style.display="block"),a&&(a.style.display="block"),t.tier_info&&["latencyTierBadge","rangeTierBadge","sampleTierBadge"].forEach(u=>{let y=document.getElementById(u);y&&(y.textContent=t.tier_info.label)});let o=t.data.map(u=>u.avg_latency).filter(u=>u!==null),r=t.data.map(u=>u.min_latency).filter(u=>u!==null),i=t.data.map(u=>u.max_latency).filter(u=>u!==null),l=(u,y)=>{let b=document.getElementById(u);b&&(b.textContent=y)};l("currentLatency",be(o.at(-1))),l("avgLatency",be(o.reduce((u,y)=>u+y,0)/o.length)),l("minLatency",be(Math.min(...r))),l("maxLatency",be(Math.max(...i))),l("dataPoints",t.data.length.toLocaleString());let c=G(e,{yLabel:"Latency (ms)",beginAtZero:!0,yTickFormatter:u=>u.toFixed(1)+" ms",tooltipLabel:u=>"Latency: "+u.parsed.y.toFixed(2)+" ms"}),d=G(e,{yLabel:"Number of Samples",beginAtZero:!0,yTickFormatter:u=>u.toFixed(0),tooltipLabel:u=>"Samples: "+u.parsed.y});T(K.charts,"latency","latencyChart","line",[I("Average Latency (ms)",H(t,"avg_latency"),"purple")],c),T(K.charts,"range","rangeChart","line",[I("Min Latency",H(t,"min_latency"),"green",{fill:!1}),I("Avg Latency",H(t,"avg_latency"),"purple",{fill:!1}),I("Max Latency",H(t,"max_latency"),"red",{fill:!1})],c);let p=I("Sample Count",H(t,"sample_count"),"blue");return p.borderWidth=1,T(K.charts,"sample","sampleChart","bar",[p],d),!0}async function Gn(){var o,r;let e=parseInt(((o=document.getElementById("rawTimeRange"))==null?void 0:o.value)||"12"),t=await B(`/api/plugin/fpp-plugin-watcher/metrics/ping/raw?hours=${e}`);if(!t.success||!((r=t.data)!=null&&r.length))return;let n={};t.data.forEach(i=>{(n[i.host]=n[i.host]||[]).push({x:i.timestamp*1e3,y:i.latency})});let s=Object.keys(n).map((i,l)=>{let c=Me(l);return I(i,n[i],c,{pointRadius:2})}),a=G(e,{yLabel:"Latency (ms)",beginAtZero:!0,tooltipLabel:i=>i.dataset.label+": "+i.parsed.y.toFixed(2)+" ms"});T(K.charts,"rawPing","rawPingLatencyChart","line",s,a)}async function Ge(){if(K.isRefreshing)return;K.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{await jo(),await Promise.all([Jn(),Gn()]),J("loadingIndicator"),Q("metricsContent"),ee()}catch(t){console.error("Error loading metrics:",t)}finally{K.isRefreshing=!1,e&&(e.style.animation="")}}var Kn={pageId:"connectivityUI",init(e={}){K.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ge):Ge(),K.refreshInterval=setInterval(()=>{K.isRefreshing||Ge()},3e4)},destroy(){K.refreshInterval&&clearInterval(K.refreshInterval),Object.values(K.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),K={charts:{},isRefreshing:!1,refreshInterval:null,config:{}}},refresh:Ge,updateAllCharts:Jn,updateRawPingLatencyChart:Gn,clearNetworkResetState:No};var L={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,systemMetrics:{},config:{}},Vo=()=>{var e;return((e=document.getElementById("timeRange"))==null?void 0:e.value)||"12"},Qn=e=>L.useFahrenheit?de(e):e,Wo={cpu:{getValue:e=>{var t;return(t=e.cpu)==null?void 0:t.current},getClass:e=>e>80?"danger":e>60?"warning":"",format:e=>e.toFixed(1)+"%",chartKey:"cpu_usage"},memory:{getValue:e=>{var t;return(t=e.memory)==null?void 0:t.current},getClass:e=>e<100?"danger":e<250?"warning":"",format:e=>e.toFixed(0)+" MB",chartKey:"free_mb"},bufferCache:{getValue:e=>{var t;return(t=e.bufferCache)==null?void 0:t.current},getClass:()=>"",format:e=>e.toFixed(0)+" MB",chartKey:"buffer_cache_mb"},disk:{getValue:e=>{var t;return(t=e.disk)==null?void 0:t.current},getClass:e=>e<1?"danger":e<2?"warning":"",format:e=>e.toFixed(1)+" GB",chartKey:"free_gb"},load:{getValue:e=>{var t;return(t=e.load)==null?void 0:t.shortterm},getClass:()=>"",format:e=>e.toFixed(2),chartKey:null},temp:{getValue:e=>{var t;return(t=e.temperature)==null?void 0:t.current},getClass:e=>e>80?"danger":e>70?"warning":"",format:e=>Qn(e).toFixed(1)+Y(L.useFahrenheit),chartKey:"temperature"},wireless:{getValue:e=>{var t;return(t=e.wireless)==null?void 0:t.signal},getClass:e=>e<-80?"danger":e<-70?"warning":"",format:e=>e.toFixed(0)+" dBm",chartKey:"signal_dbm"},ping:{getValue:e=>{var t;return(t=e.ping)==null?void 0:t.current},getClass:e=>e>100?"danger":e>50?"warning":"",format:e=>e.toFixed(1)+" ms",chartKey:"avg_latency"},efuse:{getValue:e=>{var t;return(t=e.efuse)==null?void 0:t.current},getClass:()=>"",format:e=>(e/1e3).toFixed(2)+" A",chartKey:"total_ma"}};function Zn(e,t){let n=Wo[t],s=n.getValue(e);return s==null?{value:"--",class:""}:{value:n.format(s),class:n.getClass(s)}}function ut(e,t){var s;if(!(e!=null&&e.success)||!((s=e.data)!=null&&s.length))return null;let n=e.data.filter(a=>a[t]!==null);return n.length?{current:n.at(-1)[t],average:n.reduce((a,o)=>a+o[t],0)/n.length,data:e.data}:null}async function zo(e){var l,c,d,p,g,h,u,y,b,$,M;let{address:t,hostname:n,model:s,type:a,version:o}=e,r=Vo(),i={hostname:n,address:t,model:s||a||"Unknown",version:o||"",watcherVersion:null,online:!1,noWatcher:!1,error:null,cpu:null,memory:null,bufferCache:null,disk:null,load:null,temperature:null,wireless:null,ping:null,efuse:null};try{let[C,w,S]=await Promise.all([B(`/api/plugin/fpp-plugin-watcher/remote/metrics/all?host=${encodeURIComponent(t)}&hours=${r}`,12e3),B(`/api/plugin/fpp-plugin-watcher/remote/version?host=${encodeURIComponent(t)}`,5e3).catch(()=>null),B(`/api/plugin/fpp-plugin-watcher/remote/efuse/heatmap?host=${encodeURIComponent(t)}&hours=${r}`,8e3).catch(()=>null)]);if(!C.success)return i.error="API returned unsuccessful response",i;if(i.online=!0,w!=null&&w.version&&(i.watcherVersion=w.version),i.cpu=ut(C.cpu,"cpu_usage"),i.memory=ut(C.memory,"free_mb"),i.bufferCache=ut(C.memory,"buffer_cache_mb"),i.disk=ut(C.disk,"free_gb"),(l=C.load)!=null&&l.success&&((c=C.load.data)!=null&&c.length)){let k=C.load.data.filter(x=>x.shortterm!==null);if(k.length){let x=k.at(-1);i.load={shortterm:x.shortterm,midterm:x.midterm,longterm:x.longterm}}}let _=C.thermal;if(_!=null&&_.success&&((d=_.data)!=null&&d.length)&&((p=_.zones)!=null&&p.length)){let k=_.zones.filter(x=>x.startsWith("thermal_zone"));for(let x of k.length?k:_.zones){let W=_.data.filter(D=>D[x]!==null);if(W.length){let D=((g=_.zone_names)==null?void 0:g[x])||x;i.temperature={current:W.at(-1)[x],average:W.reduce((Z,qe)=>Z+qe[x],0)/W.length,data:_.data.map(Z=>({timestamp:Z.timestamp,temperature:Z[x]})),zone:x,friendlyName:D};break}}}let R=C.wireless;if(R!=null&&R.success&&((h=R.data)!=null&&h.length)&&((u=R.interfaces)!=null&&u.length)){let k=R.interfaces[0],x=`${k}_signal_power`,W=R.data.filter(D=>D[x]!==null);if(W.length){let D=W.at(-1);i.wireless={signal:D[x],noise:D[`${k}_signal_noise`],quality:D[`${k}_signal_quality`],data:R.data.map(Z=>({timestamp:Z.timestamp,signal_dbm:Z[x]})),interface:k}}}let q=C.ping;if(q!=null&&q.success&&((y=q.data)!=null&&y.length)){let k=q.data.filter(x=>x.avg_latency!==null);k.length&&(i.ping={current:k.at(-1).avg_latency,average:k.reduce((x,W)=>x+W.avg_latency,0)/k.length,min:Math.min(...k.map(x=>x.min_latency)),max:Math.max(...k.map(x=>x.max_latency)),data:q.data,tier:((b=q.tier_info)==null?void 0:b.label)||"5-min averages"})}if(S!=null&&S.success&&(($=S.totalHistory)!=null&&$.length)){let k=S.totalHistory.filter(x=>x.value!==null&&x.value>0);if(k.length){let x=k.at(-1),W=k.map(D=>D.value);i.efuse={current:x.value,average:W.reduce((D,Z)=>D+Z,0)/W.length,peak:Math.max(...W),portCount:S.portCount||0,hardware:S.hardware,data:S.totalHistory.map(D=>({timestamp:D.timestamp,total_ma:D.value,min:D.min,max:D.max})),tier:((M=S.tier_info)==null?void 0:M.label)||"1-minute averages"}}}}catch(C){try{let w=await B(`/api/plugin/fpp-plugin-watcher/remote/fppd/status?host=${encodeURIComponent(t)}`,8e3);w!=null&&w.success&&w.data&&(i.online=!0,i.noWatcher=!0)}catch(w){i.error=C.message||"Failed to connect"}}return i}function Jo(e,t){return`<div class="systemCard" data-system="${t}">
        <div class="systemHeader">
            <div><div class="systemName">${f(e.hostname)}</div>
            <div class="systemInfo"><a href="http://${f(e.address)}" target="_blank" style="color:#007bff">${f(e.address)}</a> | ${f(e.model||e.type||"Unknown")} | FPP ${f(e.version||"")}</div></div>
            <div class="systemStatus" style="background:#e9ecef;color:#6c757d">Loading...</div>
        </div>
        <div class="noDataMessage"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Fetching metrics...</p></div>
    </div>`}function Go(e,t){if(!e.online)return`<div class="systemCard" data-system="${t}">
            <div class="systemHeader"><div><div class="systemName">${f(e.hostname)}</div>
            <div class="systemInfo"><a href="http://${f(e.address)}" target="_blank" style="color:#007bff">${f(e.address)}</a> | ${f(e.model)} | FPP ${f(e.version)}</div></div>
            <div class="systemStatus offline">Offline</div></div>
            <div class="noDataMessage"><i class="fas fa-exclamation-triangle"></i><p>Unable to fetch metrics: ${f(e.error||"Connection failed")}</p><p style="font-size:0.875rem">Ensure the Watcher plugin is installed and collectd is enabled.</p></div>
        </div>`;if(e.noWatcher)return`<div class="systemCard" data-system="${t}">
            <div class="systemHeader"><div><div class="systemName">${f(e.hostname)}</div>
            <div class="systemInfo"><a href="http://${f(e.address)}" target="_blank" style="color:#007bff">${f(e.address)}</a> | ${f(e.model)} | FPP ${f(e.version)}</div></div>
            <div class="systemStatus online">Online</div></div>
            <div class="noDataMessage"><i class="fas fa-info-circle"></i><p>Watcher plugin not installed or metrics not available</p><p style="font-size:0.875rem">Install the Watcher plugin on this system to view metrics.</p></div>
        </div>`;let n=e.watcherVersion?` | Watcher ${f(e.watcherVersion)}`:"",s={cpu:"CPU Usage",memory:"Free Memory",bufferCache:"Buffer Cache",disk:"Free Disk",load:"Load (1min)"},a=["cpu","memory","bufferCache","disk","load"].filter(i=>i!=="bufferCache"||e.bufferCache).map(i=>{let l=Zn(e,i);return`<div class="metricItem" data-metric="${i}"${i==="bufferCache"?' title="Memory used by Linux to cache frequently accessed files. This memory is automatically released when needed - high usage is good!"':""}><div class="metricLabel">${s[i]}${i==="bufferCache"?' <i class="fas fa-info-circle" style="font-size:0.65rem;color:#6c757d;cursor:help;"></i>':""}</div><div class="metricValue ${l.class}">${l.value}</div></div>`}).join(""),o=[["temp","Temperature",e.temperature],["wireless","WiFi Signal",e.wireless],["ping","Ping Latency",e.ping],["efuse","Total Current",e.efuse]].filter(([,,i])=>i).map(([i,l])=>{let c=Zn(e,i);return`<div class="metricItem" data-metric="${i}"><div class="metricLabel">${l}</div><div class="metricValue ${c.class}">${c.value}</div></div>`}).join(""),r=[`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-microchip"></i> CPU Usage</div><canvas id="cpuChart-${t}" height="150"></canvas></div>`,`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-memory"></i> Free Memory</div><canvas id="memoryChart-${t}" height="150"></canvas></div>`,e.temperature?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-thermometer-half"></i> Temperature</div><canvas id="tempChart-${t}" height="150"></canvas></div>`:"",e.wireless?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-wifi"></i> WiFi Signal</div><canvas id="wirelessChart-${t}" height="150"></canvas></div>`:"",e.ping?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-network-wired"></i> Ping Latency</div><canvas id="pingChart-${t}" height="150"></canvas></div>`:"",e.efuse?`<div class="chartWrapper"><div class="miniChartTitle"><i class="fas fa-bolt"></i> Total Current</div><canvas id="efuseChart-${t}" height="150"></canvas></div>`:""].join("");return`<div class="systemCard" data-system="${t}">
        <div class="systemHeader"><div><div class="systemName">${f(e.hostname)}</div>
        <div class="systemInfo"><a href="http://${f(e.address)}" target="_blank" style="color:#007bff">${f(e.address)}</a> | ${f(e.model)} | FPP ${f(e.version)}${n}</div></div>
        <div class="systemStatus online">Online</div></div>
        <div class="metricsGrid">${a}${o}</div>
        <div class="chartsContainer">${r}</div>
    </div>`}function Ko(e,t,n,s,a){let o=a==="temperature",r=t.map(g=>({x:g.timestamp*1e3,y:o?Qn(g[a]):g[a]})).filter(g=>g.y!==null),i=j[s]||j.purple,c={cpu_usage:g=>g.toFixed(1)+"%",free_mb:g=>g.toFixed(0)+" MB",temperature:g=>g.toFixed(1)+Y(L.useFahrenheit),signal_dbm:g=>g.toFixed(0)+" dBm",avg_latency:g=>g.toFixed(1)+" ms",total_ma:g=>(g/1e3).toFixed(2)+" A"}[a]||(g=>g.toFixed(2)),d=[I(n,r,i)],p={responsive:!0,maintainAspectRatio:!0,animation:!1,interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{display:!1},tooltip:{callbacks:{title:g=>new Date(g[0].parsed.x).toLocaleString(),label:g=>n+": "+c(g.parsed.y)}}},scales:{x:{type:"time",display:!0,grid:{display:!1},ticks:{maxTicksLimit:6,font:{size:10},color:"#6c757d"},time:{displayFormats:{hour:"h:mm a",day:"MMM d"}}},y:{beginAtZero:a==="cpu_usage",display:!0,grid:{display:!1}}}};T(L.charts,e,e,"line",d,p)}function Zo(){let e=Object.values(L.systemMetrics),t=e.filter(s=>s.online),n=(s,a)=>{let o=document.getElementById(s);o&&(o.textContent=a)};if(n("totalSystems",e.length),n("onlineSystems",`${t.length} online`),t.length){let s=c=>c.length?c.reduce((d,p)=>d+p)/c.length:null,a=s(t.filter(c=>c.cpu).map(c=>c.cpu.current)),o=s(t.filter(c=>c.memory).map(c=>c.memory.current)),r=s(t.filter(c=>c.disk).map(c=>c.disk.current));a!==null&&n("avgCpu",a.toFixed(1)+"%"),o!==null&&n("avgMemory",o.toFixed(0)+" MB"),r!==null&&n("avgDisk",r.toFixed(1)+" GB");let i=t.filter(c=>c.efuse),l=document.getElementById("efuseSummaryCard");if(l)if(i.length>0){let c=i.reduce((d,p)=>d+(p.efuse.current||0),0);l.style.display="",n("totalEfuse",(c/1e3).toFixed(2)+" A"),n("efuseSystems",`${i.length} system${i.length>1?"s":""} with eFuse`)}else l.style.display="none"}}function ft(){Object.keys(L.charts).forEach(e=>{L.charts[e]&&(L.charts[e].destroy(),delete L.charts[e])})}async function Qo(e,t,n){let s=[],a=new Set;for(let[o,r]of t.entries()){let i=Promise.resolve().then(()=>n(r,o));s.push(i),a.add(i),i.finally(()=>a.delete(i)),a.size>=e&&await Promise.race(a)}return Promise.all(s)}async function pt(){if(L.isRefreshing)return;L.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite"),L.useFahrenheit=await Be();let t=document.getElementById("systemsContainer"),n=window.remoteSystems||[];if(!n.length){ft(),t&&(t.innerHTML='<div class="noDataMessage"><p>No remote systems found in multi-sync configuration.</p></div>'),J("loadingIndicator"),Q("metricsContent"),L.isRefreshing=!1;return}!Object.keys(L.systemMetrics).length&&t&&(ft(),L.systemMetrics={},t.innerHTML=n.map((a,o)=>Jo(a,o)).join("")),J("loadingIndicator"),Q("metricsContent"),await Qo(6,n,async(a,o)=>{try{let r=await zo(a);L.systemMetrics[o]=r;let i=t==null?void 0:t.querySelector(`[data-system="${o}"]`);i&&(["cpu","memory","temp","wireless","ping","efuse"].forEach(l=>{let c=`${l}Chart-${o}`;L.charts[c]&&(L.charts[c].destroy(),delete L.charts[c])}),i.outerHTML=Go(r,o),r.online&&[["cpu","red","cpu_usage"],["memory","purple","free_mb"],["temp","orange","temperature"],["wireless","teal","signal_dbm"],["ping","indigo","avg_latency"],["efuse","yellow","total_ma"]].forEach(([l,c,d])=>{var h,u,y,b,$,M,C;let p=l==="cpu"?(h=r.cpu)==null?void 0:h.data:l==="memory"?(u=r.memory)==null?void 0:u.data:l==="temp"?(y=r.temperature)==null?void 0:y.data:l==="wireless"?(b=r.wireless)==null?void 0:b.data:l==="ping"?($=r.ping)==null?void 0:$.data:(M=r.efuse)==null?void 0:M.data,g=l==="cpu"?"CPU %":l==="memory"?"Memory MB":l==="temp"?Le(((C=r.temperature)==null?void 0:C.friendlyName)||"Temp")+" "+Y(L.useFahrenheit):l==="wireless"?"Signal dBm":l==="ping"?"Latency ms":"Amps";p&&Ko(`${l==="temp"?"temp":l}Chart-${o}`,p,g,c,d)})),Zo()}catch(r){console.error(`Failed to fetch metrics for ${a.hostname}:`,r)}}),ee(),e&&(e.style.animation=""),L.isRefreshing=!1}var Xn={pageId:"remoteMetricsUI",init(e={}){L.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",pt):pt(),L.refreshInterval=setInterval(()=>{L.isRefreshing||pt()},6e4),window.addEventListener("beforeunload",ft)},destroy(){L.refreshInterval&&clearInterval(L.refreshInterval),ft(),L={charts:{},isRefreshing:!1,useFahrenheit:!1,refreshInterval:null,systemMetrics:{},config:{}}},refresh:pt};var X={charts:{},isRefreshing:!1,refreshInterval:null,config:{}};function Yn(e){let t={};return e.forEach(n=>{let s=n.hostname||"unknown";(t[s]=t[s]||{entries:[],address:n.address||""}).entries.push(n)}),t}function qt(e,t,n=0){return Object.keys(e).sort().map((s,a)=>{let o=Me(a);return I(s,e[s].entries.map(t),o,{fill:!1,pointRadius:n})})}async function es(){var o,r;let e=parseInt(((o=document.getElementById("rawTimeRange"))==null?void 0:o.value)||"12"),t=await B(`/api/plugin/fpp-plugin-watcher/metrics/multisync/ping/raw?hours=${e}`);if(!t.success||!((r=t.data)!=null&&r.length)){Q("noDataMessage");return}J("noDataMessage");let n=Yn(t.data),s=qt(n,i=>({x:i.timestamp*1e3,y:i.latency}),2),a=G(e,{yLabel:"Latency (ms)",beginAtZero:!0,tooltipLabel:i=>i.dataset.label+": "+i.parsed.y.toFixed(2)+" ms"});T(X.charts,"rawPing","rawPingLatencyChart","line",s,a)}async function ts(){var g,h;let e=parseInt(((g=document.getElementById("timeRange"))==null?void 0:g.value)||"12"),t=await B(`/api/plugin/fpp-plugin-watcher/metrics/multisync/ping/rollup?hours=${e}`),n=["statsBarSection","rollupChartsSection","perHostStatsSection"];if(!t.success||!((h=t.data)!=null&&h.length)){n.forEach(u=>{let y=document.getElementById(u);y&&(y.style.display="none")});return}if(n.forEach(u=>{let y=document.getElementById(u);y&&(y.style.display="block")}),t.tier_info){let u=document.getElementById("latencyTierBadge"),y=document.getElementById("successTierBadge");u&&(u.textContent=t.tier_info.label),y&&(y.textContent=t.tier_info.label)}let s=Yn(t.data),a=Object.keys(s).sort(),o=a.map(u=>{let y=s[u].entries,b=y.map(w=>w.avg_latency).filter(w=>w!==null),$=y.reduce((w,S)=>w+(S.success_count||0),0),M=y.reduce((w,S)=>w+(S.failure_count||0),0),C=$+M;return{hostname:u,address:s[u].address,avgLatency:b.length?b.reduce((w,S)=>w+S)/b.length:null,minLatency:b.length?Math.min(...b):null,maxLatency:b.length?Math.max(...b):null,successRate:C?$/C*100:0}}),r=document.getElementById("perHostStats");r&&(r.innerHTML=o.map(u=>{let y=u.avgLatency===null?"":u.avgLatency>100?"danger":u.avgLatency>50?"warning":"success",b=u.successRate>=99?"success":u.successRate>=90?"warning":"danger";return`<div class="hostStatCard" style="border-left-color:${{danger:"#dc3545",warning:"#ffc107",success:"#28a745"}[y]||"#6c757d"}">
            <div class="hostname">${f(u.hostname)}</div>
            <div class="address">${f(u.address)}</div>
            <div class="stats-row">
                <div class="stat"><div class="stat-label">Avg Latency</div><div class="stat-value ${y}">${u.avgLatency!==null?u.avgLatency.toFixed(1)+" ms":"--"}</div></div>
                <div class="stat"><div class="stat-label">Min/Max</div><div class="stat-value">${u.minLatency!==null?u.minLatency.toFixed(1):"--"} / ${u.maxLatency!==null?u.maxLatency.toFixed(1):"--"}</div></div>
                <div class="stat"><div class="stat-label">Success Rate</div><div class="stat-value ${b}">${u.successRate.toFixed(1)}%</div></div>
            </div></div>`}).join(""));let i=o.filter(u=>u.avgLatency!==null).map(u=>u.avgLatency),l=(u,y)=>{let b=document.getElementById(u);b&&(b.textContent=y)};l("hostsCount",a.length.toString()),l("overallAvgLatency",i.length?(i.reduce((u,y)=>u+y)/i.length).toFixed(2)+" ms":"-- ms"),l("bestLatency",i.length?Math.min(...i).toFixed(2)+" ms":"-- ms"),l("worstLatency",i.length?Math.max(...i).toFixed(2)+" ms":"-- ms"),l("dataPoints",t.data.length.toLocaleString());let c=G(e,{yLabel:"Latency (ms)",beginAtZero:!0,yTickFormatter:u=>u.toFixed(1)+" ms",tooltipLabel:u=>u.dataset.label+": "+u.parsed.y.toFixed(2)+" ms"});T(X.charts,"latency","latencyChart","line",qt(s,u=>({x:u.timestamp*1e3,y:u.avg_latency})),c);let d=G(e,{yLabel:"Success Rate (%)",yMax:100,yTickFormatter:u=>u+"%",tooltipLabel:u=>u.dataset.label+": "+u.parsed.y.toFixed(1)+"%"}),p=qt(s,u=>{let y=(u.success_count||0)+(u.failure_count||0);return{x:u.timestamp*1e3,y:y?u.success_count/y*100:100}});T(X.charts,"success","successChart","line",p,d)}async function mt(){if(X.isRefreshing)return;X.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{await Promise.all([es(),ts()]),J("loadingIndicator"),Q("metricsContent"),ee()}catch(t){console.error("Error loading metrics:",t)}finally{X.isRefreshing=!1,e&&(e.style.animation="")}}var ns={pageId:"remotePingUI",init(e={}){X.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",mt):mt(),X.refreshInterval=setInterval(()=>{X.isRefreshing||mt()},6e4)},destroy(){X.refreshInterval&&clearInterval(X.refreshInterval),Object.values(X.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),X={charts:{},isRefreshing:!1,refreshInterval:null,config:{}}},refresh:mt,updateAllCharts:ts,updateRawPingLatencyChart:es};var V={charts:{},isRefreshing:!1,refreshInterval:null,allEvents:[],displayedEvents:50,config:{}};function Xo(e){return{ss:"seq-start",se:"seq-stop",ps:"pl-start",pe:"pl-stop",st:"status",ms:"media-start",me:"media-stop",wn:"warning"}[e]||""}async function Yo(){var s;let t=`/api/plugin/fpp-plugin-watcher/mqtt/stats?hours=${((s=document.getElementById("timeRange"))==null?void 0:s.value)||"24"}`,n=await B(t);if(n!=null&&n.success&&n.stats){let a=n.stats,o=(r,i)=>{let l=document.getElementById(r);l&&(l.textContent=i)};o("totalEvents",a.totalEvents||0),o("sequencesPlayed",Object.keys(a.sequencesPlayed||{}).length),o("playlistsStarted",Object.keys(a.playlistsStarted||{}).length),o("totalRuntime",We(a.totalRuntime||0)),tr(a.hourlyDistribution||[]),nr(a.sequencesPlayed||{})}}async function er(){var s;let t=`/api/plugin/fpp-plugin-watcher/mqtt/events?hours=${((s=document.getElementById("timeRange"))==null?void 0:s.value)||"24"}`,n=await B(t);if(n!=null&&n.success){V.allEvents=n.data||[],V.displayedEvents=50,ss();let a=document.getElementById("eventCount");a&&(a.textContent=V.allEvents.length+" events")}}function tr(e){var o;let t=e.map(r=>({x:new Date(r.timestamp*1e3),y:r.count})),n=parseInt(((o=document.getElementById("timeRange"))==null?void 0:o.value)||"24"),s=[I("Events",t,"blue",{pointRadius:2})],a=G(n,{yLabel:"Events",beginAtZero:!0,showLegend:!1});T(V.charts,"timeline","timelineChart","line",s,a)}function nr(e){let t=document.getElementById("topSequences");if(!t)return;let n=Object.entries(e).slice(0,10);if(n.length===0){t.innerHTML='<p class="noData">No sequence data available</p>';return}t.innerHTML=n.map(([s,a],o)=>`
        <div class="topItem">
            <span class="rank">${o+1}</span>
            <span class="name">${f(s)}</span>
            <span class="count">${a} plays</span>
        </div>
    `).join("")}function ss(){let e=document.getElementById("eventsTableBody");if(!e)return;let t=V.allEvents.slice(0,V.displayedEvents);if(t.length===0){e.innerHTML='<tr><td colspan="5" class="noData">No events found</td></tr>',J("showMoreContainer");return}e.innerHTML=t.map(n=>{let s=Xo(n.eventType),a=n.duration?We(n.duration):"";return`
            <tr>
                <td>${f(n.datetime)}</td>
                <td>${f(n.hostname)}</td>
                <td><span class="eventBadge ${s}">${f(n.eventLabel)}</span></td>
                <td>${f(n.data||"-")}</td>
                <td>${a}</td>
            </tr>
        `}).join(""),V.allEvents.length>V.displayedEvents?Q("showMoreContainer"):J("showMoreContainer")}function sr(){V.displayedEvents+=50,ss()}async function gt(){if(V.isRefreshing)return;V.isRefreshing=!0;let e=document.querySelector(".refreshButton i");e&&(e.style.animation="spin 1s linear infinite");try{await Promise.all([Yo(),er()]),J("loadingIndicator"),Q("metricsContent");let t=document.getElementById("lastUpdate");t&&(t.textContent="Updated: "+new Date().toLocaleTimeString())}catch(t){console.error("Error loading data:",t)}finally{V.isRefreshing=!1,e&&(e.style.animation="")}}var as={pageId:"eventsUI",init(e={}){V.config=e,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",gt):gt(),V.refreshInterval=setInterval(gt,3e4)},destroy(){V.refreshInterval&&clearInterval(V.refreshInterval),Object.values(V.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),V={charts:{},isRefreshing:!1,refreshInterval:null,allEvents:[],displayedEvents:50,config:{}}},refresh:gt,showMoreEvents:sr};var ie={bulkStatus:{interval:1e4,lastFetch:0},bulkUpdates:{interval:6e4,lastFetch:0},localStatus:{interval:1e4,lastFetch:0},localSysStatus:{interval:3e4,lastFetch:0},localConnectivity:{interval:3e4,lastFetch:0},localVersion:{interval:6e4,lastFetch:0},localUpdates:{interval:6e4,lastFetch:0},discrepancies:{interval:6e4,lastFetch:0},fppRelease:{interval:6e4,lastFetch:0}},Ce=new Map,Ke=new Map,F={status:null,testMode:null,sysStatus:null,connectivity:null,version:null,updates:[]},le=new Map,we=new Map,he=new Map,te=new Map,ue=new Map,Ze=!1,Qe=null,ht=null,ne=null;function jt(e){Ze=e}function Nt(e){Qe=e}function Vt(e){ht=e}function os(e){ne=e}function se(e){let t=Date.now(),n=ie[e];return n?t-n.lastFetch>=n.interval:!0}function ae(e){ie[e]&&(ie[e].lastFetch=Date.now())}function Pe(e){ie[e]&&(ie[e].lastFetch=0)}var re={remoteAddresses:[],remoteHostnames:{},localHostname:"localhost"};function rs(e){re.remoteAddresses=(e==null?void 0:e.remoteAddresses)||[],re.remoteHostnames=(e==null?void 0:e.remoteHostnames)||{},re.localHostname=(e==null?void 0:e.localHostname)||"localhost"}function is(){Object.keys(ie).forEach(e=>{ie[e].lastFetch=0}),Ce.clear(),Ke.clear(),F.status=null,F.testMode=null,F.sysStatus=null,F.connectivity=null,F.version=null,F.updates=[],le.clear(),we.clear(),he.clear(),te.clear(),ue.clear(),Ze=!1,Qe=null,ht=null,ne=null}function E(e){return e.replace(/\./g,"-")}function ls(e){return e==="localhost"?re.localHostname:re.remoteHostnames[e]||e}function yt(e){if(!e)return[0,0];let n=e.replace(/^v/,"").match(/^(\d+)\.(\d+)/);return n?[parseInt(n[1]),parseInt(n[2])]:[0,0]}function ar(e,t){let[n,s]=yt(e),[a,o]=yt(t);return n<a?-1:n>a?1:s<o?-1:s>o?1:0}function cs(e){if(!ne||!ne.latestVersion)return null;if(ar(e,ne.latestVersion)<0){let[n]=yt(e),[s]=yt(ne.latestVersion),a=s>n;return{available:!0,currentVersion:e?e.replace(/^v/,""):"unknown",latestVersion:ne.latestVersion,isMajorUpgrade:a}}return null}function Wt(e){var a;let t={fppLocalVersion:null,fppRemoteVersion:null,diskUtilization:null,cpuUtilization:null,memoryUtilization:null,ipAddress:null};if(!(e!=null&&e.advancedView))return t;t.fppLocalVersion=e.advancedView.LocalGitVersion||null,t.fppRemoteVersion=e.advancedView.RemoteGitVersion||null;let n=e.advancedView.IPs;n&&typeof n=="object"&&(t.ipAddress=n.eth0||n.wlan0||Object.values(n)[0]||null);let s=e.advancedView.Utilization;if(s){let o=(a=s.Disk)==null?void 0:a.Root;(o==null?void 0:o.Total)>0&&(t.diskUtilization=Math.round((o.Total-o.Free)/o.Total*100)),typeof s.CPU=="number"&&(t.cpuUtilization=Math.round(s.CPU)),typeof s.Memory=="number"&&(t.memoryUtilization=Math.round(s.Memory))}return t}async function ds(){try{let e=await fetch("/api/plugin/fpp-plugin-watcher/fpp/release");if(!e.ok)return null;let t=await e.json();if(t.success)return os(t),t}catch(e){console.log("Failed to fetch latest FPP release:",e)}return null}async function us(){if(se("bulkStatus"))try{let e=await fetch("/api/plugin/fpp-plugin-watcher/remote/bulk/status");if(!e.ok)return;let t=await e.json();if(t.success&&t.hosts)for(let[n,s]of Object.entries(t.hosts))Ce.set(n,s);ae("bulkStatus")}catch(e){console.log("Failed to fetch bulk status:",e)}}async function ps(){if(se("bulkUpdates"))try{let e=await fetch("/api/plugin/fpp-plugin-watcher/remote/bulk/updates");if(!e.ok)return;let t=await e.json();if(t.success&&t.hosts)for(let[n,s]of Object.entries(t.hosts))Ke.set(n,s);ae("bulkUpdates")}catch(e){console.log("Failed to fetch bulk updates:",e)}}async function zt(){try{if(se("localStatus")){let[e,t]=await Promise.all([fetch("/api/fppd/status"),fetch("/api/testmode")]);if(e.ok){let n=await e.json();F.status={platform:n.platform||"--",branch:n.branch||"--",mode_name:n.mode_name||"--",status_name:n.status_name||"idle",rebootFlag:n.rebootFlag||0,restartFlag:n.restartFlag||0,warnings:n.warnings||[]}}if(t.ok){let n=await t.json();F.testMode={enabled:n.enabled?1:0}}else F.testMode={enabled:0};ae("localStatus")}if(se("localSysStatus")){let e=await fetch("/api/system/status");if(e.ok){let t=await e.json();F.sysStatus=Wt(t)}ae("localSysStatus")}if(se("localConnectivity")){let e=await fetch("/api/plugin/fpp-plugin-watcher/connectivity/state");if(e.ok){let t=await e.json();F.connectivity=t.success&&t.hasResetAdapter?t:null}ae("localConnectivity")}if(se("localVersion")){let e=await fetch("/api/plugin/fpp-plugin-watcher/version");if(e.ok){let t=await e.json();F.version=t.version||null}ae("localVersion")}if(se("localUpdates")){let e=await fetch("/api/plugin/fpp-plugin-watcher/plugins/updates");if(e.ok){let t=await e.json();F.updates=t.success&&t.updatesAvailable?t.updatesAvailable:[]}ae("localUpdates")}}catch(e){console.log("Failed to fetch local status:",e)}}function fs(e){let t=Ce.get(e),n=Ke.get(e);if(!t||!t.success)return{success:!1,address:e,error:(t==null?void 0:t.error)||"No data available"};let s=t.sysStatus?Wt(t.sysStatus):{fppLocalVersion:null,fppRemoteVersion:null,diskUtilization:null,cpuUtilization:null,memoryUtilization:null,ipAddress:null},a=t.connectivity&&t.connectivity.hasResetAdapter?t.connectivity:null;return{success:!0,address:e,status:t.status,testMode:t.testMode,watcherVersion:(n==null?void 0:n.version)||null,pluginUpdates:(n==null?void 0:n.updates)||[],connectivityState:a,...s}}function Jt(){return F.status?{success:!0,address:"localhost",status:F.status,testMode:F.testMode,watcherVersion:F.version,pluginUpdates:F.updates,connectivityState:F.connectivity,...F.sysStatus||{}}:{success:!1,address:"localhost",error:"No data available"}}async function Fe(e){let t=e==="localhost";try{if(t)return ie.localStatus.lastFetch=0,ie.localSysStatus.lastFetch=0,ie.localConnectivity.lastFetch=0,await zt(),Jt();{let[n,s,a]=await Promise.all([fetch(`/api/plugin/fpp-plugin-watcher/remote/status?host=${encodeURIComponent(e)}`),fetch(`/api/plugin/fpp-plugin-watcher/remote/sysStatus?host=${encodeURIComponent(e)}`).catch(()=>null),fetch(`/api/plugin/fpp-plugin-watcher/remote/connectivity/state?host=${encodeURIComponent(e)}`).catch(()=>null)]);if(!n.ok)return{success:!1,address:e,error:"Failed to fetch status"};let o=await n.json();if(!o.success)return{success:!1,address:e,error:o.error||"Failed"};let r={fppLocalVersion:null,fppRemoteVersion:null,diskUtilization:null,cpuUtilization:null,memoryUtilization:null,ipAddress:null};if(s!=null&&s.ok){let c=await s.json();r=Wt(c.data||c)}let i=null;if(a!=null&&a.ok){let c=await a.json();i=c.success&&c.hasResetAdapter?c:null}let l=Ke.get(e);return Ce.set(e,{success:!0,status:o.status,testMode:o.testMode,sysStatus:r,connectivity:i}),{success:!0,address:e,status:o.status,testMode:o.testMode,watcherVersion:(l==null?void 0:l.version)||null,pluginUpdates:(l==null?void 0:l.updates)||[],connectivityState:i,...r}}}catch(n){return{success:!1,address:e,error:n.message}}}function Re(e,t,n,s=1){let a=document.getElementById(e),o=document.getElementById(t);if(!a||!o)return;let r=n.size;a.classList.toggle("visible",r>=s),o.textContent=r}function ms(e,t,n=null){let s="";return e.forEach((a,o)=>{let r=n?n(a):"";s+=`
      <div class="host-item" id="${t}-${E(o)}">
        <div class="host-name">${a.hostname} (${o})${r}</div>
        <div class="host-status pending" id="${t}-status-${E(o)}">
          <i class="fas fa-clock"></i> Pending
        </div>
      </div>`}),s}function pe(e,t){let n=document.getElementById(`card-${e}`),s=document.getElementById(`status-${e}`),a=document.getElementById(`platform-${e}`),o=document.getElementById(`version-${e}`),r=document.getElementById(`mode-${e}`),i=document.getElementById(`watcher-${e}`),l=document.getElementById(`testmode-${e}`),c=document.getElementById(`restart-btn-${e}`),d=document.getElementById(`reboot-btn-${e}`),p=document.getElementById(`updates-container-${e}`),g=document.getElementById(`upgrades-list-${e}`),h=document.getElementById(`fpp-major-row-${e}`),u=document.getElementById(`fpp-major-version-${e}`),y=document.getElementById(`fpp-crossversion-row-${e}`),b=document.getElementById(`fpp-crossversion-version-${e}`),$=document.getElementById(`fpp-branch-row-${e}`),M=document.getElementById(`fpp-branch-version-${e}`);if(!n)return;if(n.classList.remove("offline","status-ok","status-warning","status-restart","status-update","status-testing"),!t.success){or(n,s,a,o,r,i,l,c,d,p,h,y,$,e);return}let{status:C,testMode:w,pluginUpdates:S=[],fppLocalVersion:_,fppRemoteVersion:R,connectivityState:q,diskUtilization:k,cpuUtilization:x,memoryUtilization:W,ipAddress:D}=t,Z=(w==null?void 0:w.enabled)===1,qe=C.rebootFlag===1,Bt=C.restartFlag===1;if(e==="localhost"&&D){let Ne=document.getElementById("localhost-address");Ne&&(Ne.innerHTML=`<a href="http://${D}/" target="_blank">${D} (This System)</a>`)}let je=_&&R&&R!=="Unknown"&&R!==""&&_!==R,$e=cs(C.branch),on=je||$e&&$e.available,Xe=q&&q.hasResetAdapter,ka=S.length>0,rn=k!==null&&k>=90,ln=x!==null&&x>=80,cn=W!==null&&W>=90;Z?n.classList.add("status-testing"):qe||Bt?n.classList.add("status-restart"):on||ka?n.classList.add("status-update"):Xe||rn||ln||cn?n.classList.add("status-warning"):n.classList.add("status-ok");let La=rr(C,Z,qe,Bt,Xe,ln,cn,rn,x,W,k,$e,je);if(s.innerHTML='<div class="status-indicators">'+La.join("")+"</div>",a.textContent=C.platform||"--",o.innerHTML=ir(C.branch,$e,je),r.textContent=C.mode_name||"--",i.textContent=t.watcherVersion||"Not installed",l.disabled=!1,l.checked=Z,c.disabled=!1,d.disabled=!1,e==="localhost"){let Ne=document.getElementById("multisync-test-row-localhost"),dn=document.getElementById("testmode-multisync-localhost"),un=C.mode_name&&C.mode_name.toLowerCase()==="player";Ne&&(Ne.style.display=un?"flex":"none"),dn&&(dn.disabled=!un)}lr(e,S,qe,Bt,$e,je,_,R,C.branch,Xe,q),cr(e,$e,je,C.branch,_,R,h,u,y,b,$,M),dr(e,Xe,q),ur(e,S,g),on||S.length>0?p.classList.add("visible"):p.classList.remove("visible")}function or(e,t,n,s,a,o,r,i,l,c,d,p,g,h){e.classList.add("offline"),t.innerHTML='<div class="status-indicators"><span class="status-indicator status-indicator--offline"><span class="dot"></span>Offline</span></div>',n.textContent="--",s.textContent="--",a.textContent="--",o.textContent="--",r.disabled=!0,r.checked=!1,i.disabled=!0,l.disabled=!0,c.classList.remove("visible"),d==null||d.classList.remove("visible"),p==null||p.classList.remove("visible"),g==null||g.classList.remove("visible");let u=document.getElementById(`connectivity-alert-${h}`);u==null||u.classList.remove("visible"),ue.delete(h),Re("connectivityFailBtn","connectivityFailCount",ue)}function rr(e,t,n,s,a,o,r,i,l,c,d,p,g){let h=['<span class="status-indicator status-indicator--online"><span class="dot"></span>Online</span>'],u=e.status_name||"idle";if(u==="playing"?h.push('<span class="status-indicator status-indicator--playing"><span class="dot"></span>Playing</span>'):!t&&u==="idle"&&h.push('<span class="status-indicator status-indicator--idle"><span class="dot"></span>Idle</span>'),a&&h.push('<span class="status-indicator status-indicator--connectivity"><span class="dot"></span>Conn. Failed</span>'),o&&h.push(`<span class="status-indicator status-indicator--high-cpu"><span class="dot"></span>High CPU (${l}%)</span>`),r&&h.push(`<span class="status-indicator status-indicator--low-memory"><span class="dot"></span>Low Memory (${c}%)</span>`),i&&h.push(`<span class="status-indicator status-indicator--low-storage"><span class="dot"></span>Low Storage (${d}%)</span>`),t&&h.push('<span class="status-indicator status-indicator--testing"><span class="dot"></span>Test Mode</span>'),p&&p.available&&(p.isMajorUpgrade?h.push(`<span class="status-indicator status-indicator--major-upgrade" title="Major version upgrade requires OS Upgrade"><span class="dot"></span>FPP v${p.latestVersion}</span>`):h.push(`<span class="status-indicator status-indicator--update"><span class="dot"></span>FPP v${p.latestVersion}</span>`)),g){let y=e.branch?e.branch.replace(/^v/,""):"";h.push(`<span class="status-indicator status-indicator--update"><span class="dot"></span>${y} Update</span>`)}return n?h.push('<span class="status-indicator status-indicator--reboot"><span class="dot"></span>Reboot Req</span>'):s&&h.push('<span class="status-indicator status-indicator--restart"><span class="dot"></span>Restart Req</span>'),h}function ir(e,t,n){let s=e||"--",a=[];return t&&t.available&&(t.isMajorUpgrade?a.push(`<span class="version-major" title="Major version upgrade requires OS Upgrade">v${t.latestVersion} Upgrade</span>`):a.push(`<span class="version-update">v${t.latestVersion}</span>`)),n&&a.push('<span class="version-update">branch update</span>'),a.length>0&&(s+=` (${a.join(", ")})`),s}function lr(e,t,n,s,a,o,r,i,l,c,d){let p=ls(e),g=t.find(b=>b.repoName==="fpp-plugin-watcher");g?le.set(e,{hostname:p,installedVersion:g.installedVersion,latestVersion:g.latestVersion}):le.delete(e),Re("upgradeAllBtn","upgradeAllCount",le);let h=t.filter(b=>b.repoName!=="fpp-plugin-watcher");h.length>0?we.set(e,{hostname:p,plugins:h}):we.delete(e),Re("upgradeOtherPluginsBtn","upgradeOtherPluginsCount",we),n?he.set(e,{hostname:p,type:"reboot"}):s?he.set(e,{hostname:p,type:"restart"}):he.delete(e),Re("restartAllBtn","restartAllCount",he);let u=a&&a.available&&a.isMajorUpgrade,y=a&&a.available&&!u;if(y||o?te.set(e,{hostname:p,branch:l,crossVersion:y?{localVersion:a.currentVersion,remoteVersion:a.latestVersion}:null,branchUpdate:o?{localVersion:r,remoteVersion:i}:null}):te.delete(e),Re("fppUpgradeAllBtn","fppUpgradeAllCount",te),c){let b=d.resetTime||"Unknown time",$=d.adapter||"Unknown";ue.set(e,{hostname:p,resetTime:b,adapter:$})}else ue.delete(e);Re("connectivityFailBtn","connectivityFailCount",ue)}function cr(e,t,n,s,a,o,r,i,l,c,d,p){let g=t&&t.available&&t.isMajorUpgrade,h=t&&t.available&&!g;if(g&&r?(r.classList.add("visible"),i&&(i.textContent=`v${t.currentVersion} \u2192 v${t.latestVersion}`)):r&&r.classList.remove("visible"),h&&l){l.classList.add("visible"),c&&(c.textContent=`v${t.currentVersion} \u2192 v${t.latestVersion}`);let u=document.getElementById(`fpp-crossversion-btn-${e}`);u&&(n?(u.disabled=!0,u.title="Complete branch update first",l.classList.add("blocked-by-branch")):(u.disabled=!1,u.title="",l.classList.remove("blocked-by-branch")))}else l&&(l.classList.remove("visible"),l.classList.remove("blocked-by-branch"));if(n&&d){let u=s?s.replace(/^v/,""):"";d.classList.add("visible"),p&&(p.textContent=`${u}: ${a.substring(0,7)} \u2192 ${o.substring(0,7)}`)}else d&&d.classList.remove("visible")}function dr(e,t,n){let s=document.getElementById(`connectivity-alert-${e}`),a=document.getElementById(`connectivity-details-${e}`);if(s)if(t){let o=n.resetTime||"Unknown time",r=n.adapter||"Unknown";a&&(a.textContent=`Adapter ${r} reset at ${o}`),s.classList.add("visible")}else s.classList.remove("visible")}function ur(e,t,n){if(n)if(t.length>0){let s="";t.forEach(a=>{let o=a.latestVersion?`v${a.installedVersion} \u2192 v${a.latestVersion}`:`v${a.installedVersion}`,r=a.repoName==="fpp-plugin-watcher"?`page.upgradeWatcherSingle('${e}')`:`page.upgradePlugin('${e}', '${a.repoName}')`;s+=`
        <div class="upgrade-item" id="upgrade-item-${e}-${a.repoName}">
          <div class="update-info">
            <span class="update-name">${a.name}</span>
            <span class="update-version">${o}</span>
          </div>
          <button class="banner-btn" onclick="${r}" id="upgrade-btn-${e}-${a.repoName}">
            <i class="fas fa-download"></i> Upgrade
          </button>
        </div>`}),n.innerHTML=s}else n.innerHTML=""}async function gs(e,t){let n=e==="localhost",s=document.getElementById(`testmode-${e}`);if(s){s.disabled=!0;try{let a="1-8388608";if(t)try{let i=n?"/api/system/info":`/api/plugin/fpp-plugin-watcher/remote/sysInfo?host=${encodeURIComponent(e)}`,l=await fetch(i);if(l.ok){let c=await l.json(),d=n?c:c.data||c;if(d.channelRanges){let p=d.channelRanges.split("-");p.length===2&&(a=`${parseInt(p[0])+1}-${parseInt(p[1])+1}`)}}}catch(i){}let o=t?"Test Start":"Test Stop",r=t?["1000","RGB Cycle",a,"R-G-B"]:[];if(n){if(!(await fetch("/api/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:o,args:r})})).ok)throw new Error("Failed to toggle test mode")}else{let l=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e,command:o,multisyncCommand:!1,multisyncHosts:"",args:r})})).json();if(!l.success)throw new Error(l.error||"Failed to toggle test mode")}setTimeout(async()=>{let i=await Fe(e);pe(e,i)},500)}catch(a){s.checked=!t,alert(`Failed to toggle test mode: ${a.message}`)}finally{s.disabled=!1}}}async function hs(e){let t=document.getElementById("testmode-multisync-localhost"),n=document.getElementById("testmode-localhost");if(t){t.disabled=!0;try{let s="1-8388608";if(e)try{let i=await fetch("/api/system/info");if(i.ok){let l=await i.json();if(l.channelRanges){let c=l.channelRanges.split("-");c.length===2&&(s=`${parseInt(c[0])+1}-${parseInt(c[1])+1}`)}}}catch(i){}if(!(await fetch("/api/command",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:e?"Test Start":"Test Stop",multisyncCommand:!0,multisyncHosts:"",args:e?["1000","RGB Cycle",s,"R-G-B"]:[]})})).ok)throw new Error("Failed to toggle multisync test mode");n&&(n.checked=e)}catch(s){t.checked=!e,alert(`Failed to toggle multisync test mode: ${s.message}`)}finally{t.disabled=!1}}}async function Gt(e){let t=e==="localhost",n=document.getElementById(`restart-btn-${e}`);if(!n)return;let s=n.innerHTML;n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Restarting...',n.disabled=!0;try{if(t){if(!(await fetch("/api/fppd/restart",{method:"GET"})).ok)throw new Error("Failed to restart FPPD")}else{let o=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})})).json();if(!o.success)throw new Error(o.error||"Failed to restart FPPD")}n.innerHTML='<i class="fas fa-check"></i> Restarted!',setTimeout(async()=>{n.innerHTML=s,n.disabled=!1;let a=await Fe(e);pe(e,a)},3e3)}catch(a){n.innerHTML=s,n.disabled=!1,alert(`Failed to restart FPPD: ${a.message}`)}}function Kt(e,t){Nt({address:e,hostname:t});let n=document.getElementById("confirmMessage"),s=document.getElementById("confirmDialog");n&&(n.textContent=`Are you sure you want to reboot "${t}" (${e})? This will take the system offline temporarily.`),s&&(s.style.display="flex")}function vt(){let e=document.getElementById("confirmDialog");e&&(e.style.display="none"),Nt(null)}async function ys(){if(!Qe)return;let{address:e}=Qe,t=e==="localhost";vt();let n=document.getElementById(`reboot-btn-${e}`),s=(n==null?void 0:n.innerHTML)||'<i class="fas fa-power-off"></i> Reboot';n&&(n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Rebooting...',n.disabled=!0);try{t?await fetch("/api/system/reboot",{method:"GET"}):await fetch("/api/plugin/fpp-plugin-watcher/remote/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})});let a=document.getElementById(`card-${e}`),o=document.getElementById(`status-${e}`);if(a&&a.classList.add("offline"),o&&(o.innerHTML='<span class="status-indicator status-indicator--offline"><span class="dot"></span> Rebooting...</span>'),!t){let r=0,i=setInterval(async()=>{if(++r>60){clearInterval(i),n&&(n.innerHTML=s,n.disabled=!1);return}let l=await Fe(e);l.success&&(clearInterval(i),pe(e,l),n&&(n.innerHTML=s,n.disabled=!1))},2e3)}}catch(a){let o=document.getElementById(`card-${e}`),r=document.getElementById(`status-${e}`);o&&o.classList.add("offline"),r&&(r.innerHTML='<span class="status-indicator status-indicator--offline"><span class="dot"></span> Rebooting...</span>'),!t&&n&&(n.innerHTML=s,n.disabled=!1)}}async function Zt(e){let t=e==="localhost",n=document.getElementById(`connectivity-clear-btn-${e}`);if(!n)return;let s=n.innerHTML;n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{let a=t?"/api/plugin/fpp-plugin-watcher/connectivity/state/clear":"/api/plugin/fpp-plugin-watcher/remote/connectivity/state/clear",o=t?{method:"POST"}:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})},i=await(await fetch(a,o)).json();if(!i.success)throw new Error(i.error||"Failed to clear reset state");setTimeout(async()=>{let l=await Fe(e);pe(e,l)},1e3)}catch(a){n.innerHTML=s,n.disabled=!1,alert(`Failed to clear reset state: ${a.message}`)}}async function vs(e,t){let n=document.getElementById(`upgrade-btn-${e}-${t}`),s=document.getElementById(`upgrade-item-${e}-${t}`);if(!n)return;let a=n.innerHTML;if(confirm(`Upgrade ${t} on ${e}?`)){n.innerHTML='<i class="fas fa-spinner fa-spin"></i>',n.disabled=!0;try{let r=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e,plugin:t})})).json();if(!r.success)throw new Error(r.error||"Upgrade failed");n.innerHTML='<i class="fas fa-check"></i> Done',s&&setTimeout(()=>{s.style.opacity="0.5"},500),setTimeout(async()=>{let i=await Fe(e);pe(e,i)},3e3)}catch(o){n.innerHTML=a,n.disabled=!1,alert(`Upgrade failed: ${o.message}`)}}}function bs(){Gt("localhost")}function Cs(){Kt("localhost",re.localHostname)}function ws(){Zt("localhost")}var xs={connectivity:{title:'<i class="fas fa-network-wired" style="color: #ffc107;"></i> Clearing Connectivity Failures',getHosts:()=>ue,extraInfo:e=>`<span style="font-size: 0.8em; color: #666;"> - ${e.adapter} at ${e.resetTime}</span>`,operation:async([e])=>{let n=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/connectivity/state/clear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})})).json();if(!n.success)throw new Error(n.error)},refreshDelay:1e3},restart:{title:'<i class="fas fa-sync" style="color: #fd7e14;"></i> Restarting Systems',getHosts:()=>he,extraInfo:e=>`<span class="restart-type ${e.type}">${e.type==="reboot"?"Reboot":"FPPD Restart"}</span>`,operation:async([e,t])=>{let n=t.type==="reboot"?"/api/plugin/fpp-plugin-watcher/remote/reboot":"/api/plugin/fpp-plugin-watcher/remote/restart",a=await(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})})).json();if(!a.success)throw new Error(a.error)},refreshDelay:3e3},otherPlugins:{title:'<i class="fas fa-puzzle-piece" style="color: #17a2b8;"></i> Upgrading Plugins',getHosts:()=>we,extraInfo:e=>`<span style="font-size: 0.8em; color: #666;"> - ${e.plugins.map(t=>t.name).join(", ")}</span>`,parallel:!0,operation:async([e,t],n)=>{let s=t.plugins;for(let a=0;a<s.length;a++){let o=s[a];n("spinner fa-spin",`Upgrading ${o.name} (${a+1}/${s.length})...`);let i=await(await fetch("/api/plugin/fpp-plugin-watcher/remote/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e,plugin:o.repoName})})).json();if(!i.success)throw new Error(`Failed to upgrade ${o.name}: ${i.error}`)}},refreshDelay:3e3}};async function pr(e,t,n,s,a=!1){let o=0,r=0,i=e.length;if(a)s.textContent=`Processing ${i} hosts in parallel...`,e.forEach(c=>{let d=Array.isArray(c)?c[0]:c,p=document.getElementById(`${n}-status-${E(d)}`);p&&(p.className="host-status in-progress",p.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...')}),(await Promise.allSettled(e.map(async c=>{let d=Array.isArray(c)?c[0]:c,p=document.getElementById(`${n}-status-${E(d)}`),g=(h,u,y="in-progress")=>{p&&(p.className=`host-status ${y}`,p.innerHTML=`<i class="fas fa-${h}"></i> ${u}`)};try{return await t(c,g),p&&(p.className="host-status success",p.innerHTML='<i class="fas fa-check"></i> Done'),{success:!0}}catch(h){return console.error(`Error processing ${d}:`,h),p&&(p.className="host-status error",p.innerHTML='<i class="fas fa-times"></i> Failed'),{success:!1}}}))).forEach(c=>{var d;return(d=c.value)!=null&&d.success?o++:r++});else{s.textContent=`Processing 0 of ${i} hosts...`;for(let l of e){let c=Array.isArray(l)?l[0]:l,d=document.getElementById(`${n}-status-${E(c)}`);d&&(d.className="host-status in-progress",d.innerHTML='<i class="fas fa-spinner fa-spin"></i> Processing...');let p=(g,h,u="in-progress")=>{d&&(d.className=`host-status ${u}`,d.innerHTML=`<i class="fas fa-${g}"></i> ${h}`)};try{await t(l,p),d&&(d.className="host-status success",d.innerHTML='<i class="fas fa-check"></i> Done'),o++}catch(g){console.error(`Error processing ${c}:`,g),d&&(d.className="host-status error",d.innerHTML='<i class="fas fa-times"></i> Failed'),r++}s.textContent=`Processed ${o+r} of ${i} hosts...`}}return{completed:o,failed:r,total:i}}async function Es(e,t,n){if(e==="fpp"){t();return}if(e==="upgrade"){n();return}let s=xs[e];if(!s)return;let a=s.getHosts();if(a.size<1)return;Vt(e);let o=document.getElementById("bulkModal"),r=document.getElementById("bulkModalTitle"),i=document.getElementById("bulkModalHostList"),l=document.getElementById("bulkModalProgress"),c=document.getElementById("bulkModalCloseBtn");if(!o||!r||!i||!l||!c)return;r.innerHTML=s.title,i.innerHTML=ms(a,"bulk",s.extraInfo),o.style.display="flex",c.disabled=!0;let d=Array.from(a.entries()),{completed:p,failed:g}=await pr(d,s.operation,"bulk",l,s.parallel||!1);l.textContent=g===0?`Successfully processed ${p} hosts!`:`Completed: ${p} succeeded, ${g} failed`,c.disabled=!1}function Is(e){var s;let t=document.getElementById("bulkModal");t&&(t.style.display="none");let n=((s=xs[ht])==null?void 0:s.refreshDelay)||0;setTimeout(e,n),Vt(null)}var A=new Map,Ee=!1,ce="crossVersion";function fr(e){let t=new Map;return te.forEach((n,s)=>{if(e==="crossVersion"&&n.crossVersion){let a=!!n.branchUpdate;t.set(s,{hostname:n.hostname,localVersion:n.crossVersion.localVersion,remoteVersion:n.crossVersion.remoteVersion,isCrossVersion:!0,blockedByBranch:a})}else if(e==="branchUpdate"&&n.branchUpdate){let a=n.branch?n.branch.replace(/^v/,""):"";t.set(s,{hostname:n.hostname,localVersion:n.branchUpdate.localVersion.substring(0,7),remoteVersion:n.branchUpdate.remoteVersion.substring(0,7),branch:a,isCrossVersion:!1,blockedByBranch:!1})}}),t}function mr(){let e=0,t=0;return te.forEach(n=>{n.crossVersion&&e++,n.branchUpdate&&t++}),{crossVersionCount:e,branchUpdateCount:t}}function Ss(e){Ee||(ce=e,$s())}function $s(){let e=document.getElementById("fppAccordion");if(!e)return;let t=fr(ce);A.clear();let n="";t.size===0?n='<div style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-info-circle"></i> No hosts available for this upgrade type</div>':t.forEach((s,a)=>{let o=E(a),r=s.blockedByBranch;A.set(a,{status:r?"blocked":"pending",abortController:null,expanded:!1,selected:!r,upgradeInfo:s,blockedByBranch:r});let i=s.branch?`${s.branch}: ${s.localVersion} \u2192 ${s.remoteVersion}`:`v${s.localVersion} \u2192 v${s.remoteVersion}`,l=r?"fpp-accordion-item blocked excluded":"fpp-accordion-item",c=r?"disabled":"checked",d=r?"blocked":"pending",p=r?"fa-ban":"fa-clock",g=r?"Branch Update Required":"Pending";n+=`
        <div class="${l}" id="fpp-item-${o}" data-address="${a}">
          <div class="fpp-accordion-header" onclick="page.toggleFPPAccordion('${a}')">
            <input type="checkbox" class="fpp-accordion-checkbox" id="fpp-check-${o}" ${c} onclick="event.stopPropagation(); page.toggleFPPSelection('${a}')"${r?' title="Complete branch update first"':""}>
            <div class="fpp-accordion-toggle"><i class="fas fa-chevron-right"></i></div>
            <div class="fpp-accordion-info">
              <span class="fpp-accordion-hostname">${s.hostname}</span>
              <span class="fpp-accordion-address">${a}</span>
              <span class="fpp-accordion-version">${i}</span>
            </div>
            <div class="fpp-accordion-status ${d}" id="fpp-status-${o}" onclick="event.stopPropagation()">
              <i class="fas ${p}"></i> ${g}
            </div>
          </div>
          ${r?'<div class="fpp-accordion-blocked-note"><i class="fas fa-info-circle"></i> Complete the branch update before upgrading to a new version</div>':""}
          <div class="fpp-accordion-body">
            <div class="fpp-accordion-log" id="fpp-log-${o}"></div>
          </div>
        </div>`}),e.innerHTML=n,Ie()}function He(){if(te.size<1)return;let e=document.getElementById("fppUpgradeModal"),t=document.getElementById("fppUpgradeStartBtn"),n=document.getElementById("fppUpgradeCloseBtn");if(!e||!t||!n)return;Ee=!1;let{crossVersionCount:s,branchUpdateCount:a}=mr(),o=document.getElementById("fppCrossVersionCount"),r=document.getElementById("fppBranchUpdateCount");o&&(o.textContent=s,o.setAttribute("data-count",s)),r&&(r.textContent=a,r.setAttribute("data-count",a));let i=document.getElementById("fppCrossVersionDesc");i&&ne&&ne.latestVersion&&(i.textContent=`Upgrade to v${ne.latestVersion}`);let l=document.querySelector('input[name="fppUpgradeType"][value="crossVersion"]'),c=document.querySelector('input[name="fppUpgradeType"][value="branchUpdate"]');l&&(l.disabled=s===0),c&&(c.disabled=a===0),ce==="crossVersion"&&s>0||ce==="branchUpdate"&&a>0||(s>0?ce="crossVersion":a>0&&(ce="branchUpdate"));let p=document.querySelector(`input[name="fppUpgradeType"][value="${ce}"]`);p&&(p.checked=!0),$s(),t.disabled=!1,t.style.display="",t.innerHTML='<i class="fas fa-play"></i> Start Selected',n.disabled=!1,n.classList.remove("btn-success"),n.classList.add("btn-muted"),n.innerHTML="Close",e.style.display="flex"}function ks(e){A.forEach(n=>{n.abortController&&n.abortController.abort()}),A.clear(),Ee=!1;let t=document.getElementById("fppUpgradeModal");t&&(t.style.display="none"),Pe("bulkUpdates"),Pe("localVersion"),e()}function Ls(e){let t=E(e),n=document.getElementById(`fpp-item-${t}`),s=A.get(e);!n||!s||(s.expanded=!s.expanded,n.classList.toggle("expanded",s.expanded))}function bt(e){let t=A.get(e);if(t){t.expanded=!0;let n=document.getElementById(`fpp-item-${E(e)}`);n==null||n.classList.add("expanded")}}function Ms(){A.forEach((e,t)=>{var n;e.expanded=!0,(n=document.getElementById(`fpp-item-${E(t)}`))==null||n.classList.add("expanded")})}function Bs(){A.forEach((e,t)=>{var n;e.expanded=!1,(n=document.getElementById(`fpp-item-${E(t)}`))==null||n.classList.remove("expanded")})}function Ts(e){let t=E(e),n=document.getElementById(`fpp-check-${t}`),s=document.getElementById(`fpp-item-${t}`),a=A.get(e);if(!(!a||!n||!s)){if(a.blockedByBranch){n.checked=!1;return}a.selected=n.checked,s.classList.toggle("excluded",!a.selected),Ie()}}function Ps(){A.forEach((e,t)=>{if(e.status==="pending"&&!e.blockedByBranch){e.selected=!0;let n=E(t),s=document.getElementById(`fpp-check-${n}`),a=document.getElementById(`fpp-item-${n}`);s&&(s.checked=!0),a==null||a.classList.remove("excluded")}}),Ie()}function Fs(){A.forEach((e,t)=>{if(e.status==="pending"){e.selected=!1;let n=E(t),s=document.getElementById(`fpp-check-${n}`),a=document.getElementById(`fpp-item-${n}`);s&&(s.checked=!1),a==null||a.classList.add("excluded")}}),Ie()}function xe(e,t,n,s){let a=E(e),o=document.getElementById(`fpp-status-${a}`),r=A.get(e);o&&r&&(r.status=t,o.className=`fpp-accordion-status ${t}`,o.innerHTML=`<i class="fas fa-${n}"></i> ${s}`)}function Ie(){let e=document.getElementById("fppUpgradeCount"),t=document.getElementById("fppUpgradeStartBtn"),n=0,s=0,a=0,o=0,r=0,i=0;A.forEach(d=>{d.status==="blocked"?i++:d.status==="pending"?(n++,d.selected&&r++):d.status==="upgrading"?s++:d.status==="success"?a++:d.status==="error"&&o++});let l=A.size,c=l-i;e&&(s>0?e.textContent=`${s} upgrading, ${a+o} of ${c} complete`:a+o>0?e.textContent=`${a} succeeded, ${o} failed of ${c}`:i>0&&c===0?e.textContent=`${i} blocked (branch update required)`:i>0?e.textContent=`${r} of ${c} selected (${i} blocked)`:e.textContent=`${r} of ${l} selected`),t&&!Ee&&(t.disabled=r===0)}async function gr(e){let t=E(e),n=document.getElementById(`fpp-log-${t}`),s=document.getElementById(`fpp-item-${t}`),a=A.get(e);if(!n||!a)return;let o=a.upgradeInfo,r=ce==="crossVersion";a.abortController=new AbortController,xe(e,"upgrading","spinner fa-spin","Upgrading..."),Ie(),n.textContent="";let i={host:e};r&&o&&(i.version="v"+o.remoteVersion);try{let l=await fetch("/api/plugin/fpp-plugin-watcher/remote/fpp/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:a.abortController.signal});if(!l.ok)throw new Error(`HTTP error: ${l.status}`);let c=l.body.getReader(),d=new TextDecoder,p="";for(;;){let{done:h,value:u}=await c.read();if(h)break;let y=d.decode(u,{stream:!0});p+=y,n.textContent+=y,n.scrollTop=n.scrollHeight}if(p.includes("=== ERROR:")){xe(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded");return}if(n.textContent+=`

=== Upgrade complete ===`,r){n.textContent+=`

=== Initiating reboot for cross-version upgrade ===`,xe(e,"success","sync fa-spin","Rebooting...");try{e==="localhost"||e==="127.0.0.1"?await fetch("/api/system/reboot",{method:"GET"}):await fetch("/api/plugin/fpp-plugin-watcher/remote/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})}),n.textContent+=`
Reboot command sent. System will restart shortly.`}catch(h){n.textContent+=`
Reboot initiated (connection closed as expected).`}xe(e,"success","check","Rebooting")}else xe(e,"success","check","Complete")}catch(l){l.name==="AbortError"?(n.textContent+=`

=== Upgrade cancelled ===`,xe(e,"error","ban","Cancelled")):(n.textContent+=`

=== ERROR: ${l.message} ===`,xe(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded"))}finally{a.abortController=null,Ie()}}async function Rs(){if(Ee)return;let e=[];if(A.forEach((o,r)=>{o.status==="pending"&&o.selected&&e.push(r)}),e.length===0)return;Ee=!0;let t=document.getElementById("fppUpgradeStartBtn"),n=document.getElementById("fppUpgradeCloseBtn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Upgrading...'),n&&(n.disabled=!0),A.forEach((o,r)=>{let i=document.getElementById(`fpp-check-${E(r)}`);i&&(i.disabled=!0)}),e[0]&&bt(e[0]);let s=e.map(o=>gr(o));await Promise.allSettled(s),Ee=!1,n&&(n.disabled=!1);let a=!1;A.forEach(o=>{o.status==="pending"&&(a=!0)}),a&&t?(t.disabled=!1,t.innerHTML='<i class="fas fa-play"></i> Start Selected',A.forEach((o,r)=>{if(o.status==="pending"){let i=document.getElementById(`fpp-check-${E(r)}`);i&&(i.disabled=!1)}})):t&&n&&(t.style.display="none",n.classList.remove("btn-muted"),n.classList.add("btn-success"),n.innerHTML='<i class="fas fa-check"></i> Done'),Ie()}function Hs(e){if(!te.has(e)){alert("No FPP update available.");return}He(),setTimeout(()=>bt(e),100)}function _s(e){let t=te.get(e);if(!t||!t.crossVersion){alert("No cross-version upgrade available for this host.");return}ce="crossVersion",He(),setTimeout(()=>bt(e),100)}function Ds(e){let t=te.get(e);if(!t||!t.branchUpdate){alert("No branch update available for this host.");return}ce="branchUpdate",He(),setTimeout(()=>bt(e),100)}var O=new Map,De=!1;function hr(){let e=document.getElementById("watcherAccordion");if(!e)return;O.clear();let t="";le.size===0?t='<div style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-info-circle"></i> No hosts need Watcher updates</div>':le.forEach((n,s)=>{let a=E(s);O.set(s,{status:"pending",abortController:null,expanded:!1,selected:!0});let o=`${n.installedVersion||"?"} \u2192 ${n.latestVersion||"?"}`;t+=`
        <div class="fpp-accordion-item" id="watcher-item-${a}" data-address="${s}">
          <div class="fpp-accordion-header" onclick="page.toggleWatcherAccordion('${s}')">
            <input type="checkbox" class="fpp-accordion-checkbox" id="watcher-check-${a}" checked onclick="event.stopPropagation(); page.toggleWatcherSelection('${s}')">
            <div class="fpp-accordion-toggle"><i class="fas fa-chevron-right"></i></div>
            <div class="fpp-accordion-info">
              <span class="fpp-accordion-hostname">${n.hostname}</span>
              <span class="fpp-accordion-address">${s}</span>
              <span class="fpp-accordion-version">${o}</span>
            </div>
            <div class="fpp-accordion-status pending" id="watcher-status-${a}" onclick="event.stopPropagation()">
              <i class="fas fa-clock"></i> Pending
            </div>
          </div>
          <div class="fpp-accordion-body">
            <div class="fpp-accordion-log" id="watcher-log-${a}"></div>
          </div>
        </div>`}),e.innerHTML=t,Se()}function Ct(){if(le.size<1)return;let e=document.getElementById("watcherUpgradeModal"),t=document.getElementById("watcherUpgradeStartBtn"),n=document.getElementById("watcherUpgradeCloseBtn");!e||!t||!n||(De=!1,hr(),t.disabled=!1,t.style.display="",t.innerHTML='<i class="fas fa-play"></i> Start Selected',n.disabled=!1,n.classList.remove("btn-success"),n.classList.add("btn-muted"),n.innerHTML="Close",e.style.display="flex")}function Us(e){O.forEach(n=>{n.abortController&&n.abortController.abort()}),O.clear(),De=!1;let t=document.getElementById("watcherUpgradeModal");t&&(t.style.display="none"),Pe("bulkUpdates"),Pe("localVersion"),e()}function As(e){let t=E(e),n=document.getElementById(`watcher-item-${t}`),s=O.get(e);!n||!s||(s.expanded=!s.expanded,n.classList.toggle("expanded",s.expanded))}function yr(e){let t=E(e),n=document.getElementById(`watcher-item-${t}`),s=O.get(e);n&&s&&(s.expanded=!0,n.classList.add("expanded"))}function Os(){O.forEach((e,t)=>{var n;e.expanded=!0,(n=document.getElementById(`watcher-item-${E(t)}`))==null||n.classList.add("expanded")})}function qs(){O.forEach((e,t)=>{var n;e.expanded=!1,(n=document.getElementById(`watcher-item-${E(t)}`))==null||n.classList.remove("expanded")})}function js(e){let t=E(e),n=document.getElementById(`watcher-check-${t}`),s=document.getElementById(`watcher-item-${t}`),a=O.get(e);!a||!n||!s||(a.selected=n.checked,s.classList.toggle("excluded",!a.selected),Se())}function Ns(){O.forEach((e,t)=>{if(e.status==="pending"){e.selected=!0;let n=E(t),s=document.getElementById(`watcher-check-${n}`),a=document.getElementById(`watcher-item-${n}`);s&&(s.checked=!0),a==null||a.classList.remove("excluded")}}),Se()}function Vs(){O.forEach((e,t)=>{if(e.status==="pending"){e.selected=!1;let n=E(t),s=document.getElementById(`watcher-check-${n}`),a=document.getElementById(`watcher-item-${n}`);s&&(s.checked=!1),a==null||a.classList.add("excluded")}}),Se()}function _e(e,t,n,s){let a=E(e),o=document.getElementById(`watcher-status-${a}`),r=O.get(e);o&&r&&(r.status=t,o.className=`fpp-accordion-status ${t}`,o.innerHTML=`<i class="fas fa-${n}"></i> ${s}`)}function Se(){let e=document.getElementById("watcherUpgradeCount"),t=document.getElementById("watcherUpgradeStartBtn"),n=0,s=0,a=0,o=0,r=0;O.forEach(l=>{l.status==="pending"?(n++,l.selected&&r++):l.status==="upgrading"?s++:l.status==="success"?a++:l.status==="error"&&o++});let i=O.size;e&&(s>0?e.textContent=`${s} upgrading, ${a+o} of ${i} complete`:a+o>0?e.textContent=`${a} succeeded, ${o} failed of ${i}`:e.textContent=`${r} of ${i} selected`),t&&!De&&(t.disabled=r===0)}async function vr(e){let t=E(e),n=document.getElementById(`watcher-log-${t}`),s=document.getElementById(`watcher-item-${t}`),a=O.get(e);if(!(!n||!a)){a.abortController=new AbortController,_e(e,"upgrading","spinner fa-spin","Upgrading..."),Se(),n.textContent="";try{let o=await fetch("/api/plugin/fpp-plugin-watcher/remote/watcher/upgrade",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e}),signal:a.abortController.signal});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);let r=o.body.getReader(),i=new TextDecoder,l="";for(;;){let{done:d,value:p}=await r.read();if(d)break;let g=i.decode(p,{stream:!0});l+=g,n.textContent+=g,n.scrollTop=n.scrollHeight}if(l.includes("=== ERROR:")){_e(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded");return}n.textContent+=`

=== Upgrade complete, restarting FPPD... ===`,_e(e,"success","sync fa-spin","Restarting...");try{await fetch("/api/plugin/fpp-plugin-watcher/remote/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({host:e})}),n.textContent+=`
FPPD restart initiated.`}catch(d){n.textContent+=`
FPPD restart may have failed: `+d.message}_e(e,"success","check","Complete")}catch(o){o.name==="AbortError"?(n.textContent+=`

=== Upgrade cancelled ===`,_e(e,"error","ban","Cancelled")):(n.textContent+=`

=== ERROR: ${o.message} ===`,_e(e,"error","times","Failed"),a.expanded=!0,s==null||s.classList.add("expanded"))}finally{a.abortController=null,Se()}}}async function Ws(){if(De)return;let e=[];if(O.forEach((o,r)=>{o.status==="pending"&&o.selected&&e.push(r)}),e.length===0)return;De=!0;let t=document.getElementById("watcherUpgradeStartBtn"),n=document.getElementById("watcherUpgradeCloseBtn");t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Upgrading...'),n&&(n.disabled=!0),O.forEach((o,r)=>{let i=document.getElementById(`watcher-check-${E(r)}`);i&&(i.disabled=!0)});let s=e.map(o=>vr(o));await Promise.allSettled(s),De=!1,n&&(n.disabled=!1);let a=!1;O.forEach(o=>{o.status==="pending"&&(a=!0)}),a&&t?(t.disabled=!1,t.innerHTML='<i class="fas fa-play"></i> Start Selected',O.forEach((o,r)=>{if(o.status==="pending"){let i=document.getElementById(`watcher-check-${E(r)}`);i&&(i.disabled=!1)}})):t&&n&&(t.style.display="none",n.classList.remove("btn-muted"),n.classList.add("btn-success"),n.innerHTML='<i class="fas fa-check"></i> Done'),Se()}function zs(e){if(!le.has(e)){alert("No Watcher update available.");return}Ct(),setTimeout(()=>yr(e),100)}var wt=!1,Ue=null;async function Js(){if(!se("discrepancies"))return Ue;try{let e=await fetch("/api/plugin/fpp-plugin-watcher/outputs/discrepancies");if(!e.ok)return Ue;let t=await e.json();return t.success?(Ue=t,ae("discrepancies"),t):Ue}catch(e){return console.log("Failed to fetch issues:",e),Ue}}function br(){let e=[],t=re.localHostname;return F.status&&Array.isArray(F.status.warnings)&&F.status.warnings.forEach(n=>{e.push({type:"fpp_warning",severity:"warning",address:"localhost",hostname:t,message:n})}),Ce.forEach((n,s)=>{n.sysStatus&&Array.isArray(n.sysStatus.warnings)&&n.sysStatus.warnings.forEach(a=>{e.push({type:"fpp_warning",severity:"warning",address:s,hostname:n.hostname||s,message:a})})}),e}function Gs(e){let t=document.getElementById("issuesBanner"),n=document.getElementById("issuesCount"),s=document.getElementById("issuesList");if(!t||!n||!s)return;let a=e&&e.discrepancies?[...e.discrepancies]:[],o=br(),r=[...a,...o];if(r.length===0){t.classList.remove("visible");return}n.textContent=r.length;let i="";r.forEach(l=>{let c,d=[];switch(l.type){case"channel_mismatch":c="fa-not-equal",d.push(`<span><strong>Player:</strong> ${f(l.playerRange)}</span>`),d.push(`<span><strong>Remote:</strong> ${f(l.remoteRange)}</span>`);break;case"output_to_remote":c="fa-exclamation-triangle",l.description&&d.push(`<span><strong>Name:</strong> ${f(l.description)}</span>`),d.push(`<span><strong>Channels:</strong> ${l.startChannel}-${l.startChannel+l.channelCount-1}</span>`);break;case"inactive_output":c="fa-info-circle",l.description&&d.push(`<span><strong>Name:</strong> ${f(l.description)}</span>`),d.push(`<span><strong>Channels:</strong> ${l.startChannel}-${l.startChannel+l.channelCount-1}</span>`);break;case"missing_sequences":if(c="fa-file-audio",l.sequences&&l.sequences.length>0){let p=l.sequences.slice(0,5).map(h=>f(h)).join(", "),g=l.sequences.length>5?` (+${l.sequences.length-5} more)`:"";d.push(`<span><strong>Missing:</strong> ${p}${g}</span>`)}break;case"output_host_not_in_sync":c="fa-unlink",l.description&&d.push(`<span><strong>Output:</strong> ${f(l.description)}</span>`),l.startChannel&&l.channelCount&&d.push(`<span><strong>Channels:</strong> ${l.startChannel}-${l.startChannel+l.channelCount-1}</span>`);break;case"fpp_warning":c="fa-exclamation-circle";break;default:c="fa-question-circle"}i+=`
      <div class="issues-item severity-${l.severity}">
        <div class="issues-item__icon"><i class="fas ${c}"></i></div>
        <div class="issues-item__content">
          <div class="issues-item__message">
            ${f(l.message)}
          </div>
          <div class="issues-item__details">
            ${d.join("")}
          </div>
        </div>
        <span class="issues-item__address">${f(l.hostname||l.address)}</span>
      </div>`}),s.innerHTML=i,t.classList.add("visible")}function Ks(){let e=document.getElementById("issuesBody"),t=document.getElementById("issuesToggle");!e||!t||(wt=!wt,wt?(e.style.display="block",t.innerHTML='<i class="fas fa-chevron-up"></i> Hide'):(e.style.display="none",t.innerHTML='<i class="fas fa-chevron-down"></i> Details'))}function Zs(){wt=!1,Ue=null}var xt=null;async function ye(){if(Ze)return;jt(!0);let e=document.getElementById("refreshBtn");e&&(e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Refreshing...',e.disabled=!0);let t=document.getElementById("loadingIndicator"),n=document.getElementById("controlContent");t&&(t.style.display="none"),n&&(n.style.display="block");try{se("fppRelease")&&(await ds(),ae("fppRelease")),await Promise.all([zt(),us(),ps(),Js().then(a=>Gs(a))]),pe("localhost",Jt());for(let a of re.remoteAddresses)pe(a,fs(a));let s=document.getElementById("lastUpdateTime");s&&(s.textContent=new Date().toLocaleTimeString())}finally{e&&(e.innerHTML='<i class="fas fa-sync-alt"></i> Refresh All',e.disabled=!1),jt(!1)}}function Cr(){let e=document.getElementById("confirmRebootBtn");e&&e.addEventListener("click",ys),document.addEventListener("keydown",t=>{t.key==="Escape"&&(vt(),Qs(),Xs(),Ys())})}function wr(e){Es(e,He,Ct)}function Qs(){Is(ye)}function Xs(){ks(ye)}function Ys(){Us(ye)}async function xr(e){await hs(e),setTimeout(ye,1e3)}var ea={pageId:"remoteControlUI",init(e){rs(e),Cr(),ye(),xt=setInterval(()=>{Ze||ye()},1e4)},destroy(){xt&&(clearInterval(xt),xt=null),is(),Zs()},refresh:ye,refreshAllStatus:ye,toggleTestMode:gs,toggleMultiSyncTestMode:xr,restartFppd:Gt,confirmReboot:Kt,closeConfirmDialog:vt,restartLocalFppd:bs,confirmLocalReboot:Cs,clearResetState:Zt,clearLocalResetState:ws,upgradePlugin:vs,showBulkModal:wr,closeBulkModal:Qs,showFPPUpgradeModal:He,closeFPPUpgradeModal:Xs,toggleFPPAccordion:Ls,toggleFPPSelection:Ts,fppSelectAll:Ps,fppSelectNone:Fs,fppExpandAll:Ms,fppCollapseAll:Bs,switchFPPUpgradeType:Ss,startAllFPPUpgrades:Rs,upgradeFPPSingle:Hs,upgradeFPPCrossVersion:_s,upgradeFPPBranch:Ds,showWatcherUpgradeModal:Ct,closeWatcherUpgradeModal:Ys,toggleWatcherAccordion:As,toggleWatcherSelection:js,watcherSelectAll:Ns,watcherSelectNone:Vs,watcherExpandAll:Os,watcherCollapseAll:qs,startAllWatcherUpgrades:Ws,upgradeWatcherSingle:zs,toggleIssuesDetails:Ks};var m={config:{isPlayerMode:!1,isRemoteMode:!1,remoteSystems:[],localHostname:"",multiSyncPingEnabled:!1},fastRefreshInterval:null,slowRefreshInterval:null,charts:{},localStatus:null,localFppStatus:null,fppSystems:[],systemsData:[],sequenceMeta:null,lastSequenceName:null,clockDriftData:{},currentSort:{column:"hostname",direction:"asc"},slowDataLoaded:!1,lastPacketCount:0,lastPacketTime:null,packetRate:0,consecutiveFailures:{},lastKnownGoodState:{}};function ta(e){m.config={isPlayerMode:e.isPlayerMode||!1,isRemoteMode:e.isRemoteMode||!1,remoteSystems:e.remoteSystems||[],localHostname:e.localHostname||"",multiSyncPingEnabled:e.multiSyncPingEnabled||!1}}function na(){m.fastRefreshInterval&&(clearInterval(m.fastRefreshInterval),m.fastRefreshInterval=null),m.slowRefreshInterval&&(clearInterval(m.slowRefreshInterval),m.slowRefreshInterval=null),Object.values(m.charts).forEach(e=>{var t;return(t=e==null?void 0:e.destroy)==null?void 0:t.call(e)}),m.charts={},m.localStatus=null,m.localFppStatus=null,m.fppSystems=[],m.systemsData=[],m.sequenceMeta=null,m.lastSequenceName=null,m.clockDriftData={},m.currentSort={column:"hostname",direction:"asc"},m.slowDataLoaded=!1,m.lastPacketCount=0,m.lastPacketTime=null,m.packetRate=0,m.consecutiveFailures={},m.lastKnownGoodState={}}function ve(){return m.config.isPlayerMode}function Ae(){return m.config.isRemoteMode}function Et(){return m.config.localHostname}function sa(){return m.config.multiSyncPingEnabled}function It(e){let t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}function St(e){if(e===void 0||e<0)return"--";if(e<1e3)return e+"ms";if(e<1e4)return(e/1e3).toFixed(1)+"s";let t=Math.floor(e/1e3);return t<60?t+"s":t<3600?Math.floor(t/60)+"m":t<86400?Math.floor(t/3600)+"h":Math.floor(t/86400)+"d"}function $t(e,t){let n=document.getElementById(e);n&&(n.className="msm-quality-value",t&&n.classList.add("msm-quality-"+t))}function aa(){let e=document.getElementById("lastUpdate");e&&(e.textContent="Updated: "+new Date().toLocaleTimeString())}function Qt(e){let t=document.getElementById("pluginErrorMessage"),n=document.getElementById("pluginError");t&&(t.textContent=e),n&&(n.style.display="flex")}function oa(){let e=document.getElementById("pluginError");e&&(e.style.display="none")}function ra(){let e=document.getElementById("helpTooltip");e&&e.classList.toggle("show")}function Xt(e){let t=document.getElementById("helpTooltip"),n=document.querySelector(".msm-help-btn");t&&t.classList.contains("show")&&!t.contains(e.target)&&(!n||!n.contains(e.target))&&t.classList.remove("show")}function ia(e){return e<100?"msm-drift-good":e<1e3?"msm-drift-fair":"msm-drift-poor"}function kt(e){return e<20?"good":e<50?"warning":"critical"}function la(e){return e>10?"critical":e>5?"warning":"good"}async function ca(e){var $,M,C;let t=document.getElementById("systemHostname");t&&(t.textContent=Et());let n=e.currentMasterSequence||"",s=n.replace(/\.fseq$/i,"")||"None",a=document.getElementById("systemSequence");a&&(a.textContent=s);let o=document.getElementById("systemStatus");if(o&&(o.textContent=e.sequencePlaying?"Playing":"Idle"),n&&n!==m.lastSequenceName){m.lastSequenceName=n;try{let w=await fetch(`/api/sequence/${encodeURIComponent(n)}/meta`);w.ok?m.sequenceMeta=await w.json():m.sequenceMeta=null}catch(w){m.sequenceMeta=null}}else n||(m.sequenceMeta=null,m.lastSequenceName=null);let r=ve()?e.sequencePlaying:e.secondsSinceLastSync!==void 0&&e.secondsSinceLastSync>=0&&e.secondsSinceLastSync<5,i=e.localCurrentFrame!==void 0&&e.localCurrentFrame>=0?e.localCurrentFrame:e.lastMasterFrame||0,l=(($=m.sequenceMeta)==null?void 0:$.NumFrames)||0,c=document.getElementById("systemFrame");c&&(r&&l>0?c.textContent=`${i.toLocaleString()} / ${l.toLocaleString()}`:r&&i>0?c.textContent=i.toLocaleString():c.textContent="--");let d=Ae()&&((M=m.localFppStatus)==null?void 0:M.seconds_played)!==void 0?m.localFppStatus.seconds_played:e.lastMasterSeconds||0,p=((C=m.sequenceMeta)==null?void 0:C.StepTime)||25,g=l>0?l*p/1e3:0,h=document.getElementById("systemTime");h&&(r&&g>0?h.textContent=`${It(d)} / ${It(g)}`:r&&d>0?h.textContent=It(d):h.textContent="--");let u=document.getElementById("systemStepTime");if(u)if(m.sequenceMeta){let w=Math.round(1e3/m.sequenceMeta.StepTime);u.textContent=`${m.sequenceMeta.StepTime}ms (${w}fps)`}else u.textContent="--";if(ve()){let w=document.getElementById("systemChannels");w&&(w.textContent=m.sequenceMeta?m.sequenceMeta.ChannelCount.toLocaleString():"--");let S=document.getElementById("systemPacketsSent");S&&(S.textContent=(e.totalPacketsSent||0).toLocaleString())}let y=document.getElementById("systemPacketsReceived");if(y&&(y.textContent=(e.totalPacketsReceived||0).toLocaleString()),Ae()){let w=document.getElementById("systemAvgDrift");w&&(w.textContent=r&&e.avgFrameDrift!==void 0?e.avgFrameDrift.toFixed(1)+" frames":"--");let S=document.getElementById("systemMaxDrift");if(S){let q=r&&e.maxFrameDrift!==void 0?Math.abs(e.maxFrameDrift):null;S.textContent=q!==null?q.toFixed(1)+" frames":"--"}let _=document.getElementById("systemSyncInterval");_&&(r&&e.avgSyncIntervalMs!==void 0&&e.syncIntervalSamples>0?_.textContent=e.avgSyncIntervalMs.toFixed(0)+"ms":_.textContent="--");let R=document.getElementById("systemSyncJitter");if(R)if(r&&e.syncIntervalJitterMs!==void 0&&e.syncIntervalSamples>0){let q=e.syncIntervalJitterMs;R.textContent=q.toFixed(1)+"ms",R.classList.remove("status-good","status-warning","status-critical");let k=kt(q);k==="good"?R.classList.add("status-good"):k==="warning"?R.classList.add("status-warning"):R.classList.add("status-critical")}else R.textContent="--",R.classList.remove("status-good","status-warning","status-critical")}let b=document.getElementById("systemLastSync");b&&(b.textContent=St(e.millisecondsSinceLastSync))}function da(e){let t=e.packetsSent||{},n=e.packetsReceived||{},s=e.lifecycle||{},a={lcSeqOpen:s.seqOpen||0,lcSeqStart:s.seqStart||0,lcSeqStop:s.seqStop||0,lcMediaOpen:s.mediaOpen||0,lcMediaStart:s.mediaStart||0,lcMediaStop:s.mediaStop||0};for(let[g,h]of Object.entries(a)){let u=document.getElementById(g);u&&(u.textContent=h.toLocaleString())}let o=Ae(),r=o?n.sync||0:(t.sync||0)+(n.sync||0),i=o?n.mediaSync||0:(t.mediaSync||0)+(n.mediaSync||0),l=o?n.blank||0:(t.blank||0)+(n.blank||0),c=o?n.command||0:(t.command||0)+(n.command||0),d=o?n.plugin||0:(t.plugin||0)+(n.plugin||0),p={lcSyncPackets:r,lcMediaPackets:i,lcBlankPackets:l,lcCmdPackets:c,lcPluginPackets:d};for(let[g,h]of Object.entries(p)){let u=document.getElementById(g);u&&(u.textContent=h.toLocaleString())}}function pa(e){let t=e.packetsReceived||{},s={summaryTotalReceived:e.totalPacketsReceived||0,summarySyncReceived:t.sync||0,summaryMediaReceived:t.mediaSync||0,summaryCmdReceived:t.command||0};for(let[a,o]of Object.entries(s)){let r=document.getElementById(a);r&&(r.textContent=o.toLocaleString())}}function fa(){let e=document.getElementById("syncSourceHostname"),t=document.getElementById("syncSourceIP"),n=document.getElementById("syncSourceStatus");if(!e)return;let s=m.fppSystems.find(a=>a.fppModeString==="player"||a.fppMode===2);if(s){e.textContent=s.hostname||"Unknown",t.textContent=s.address||"--";let a=s.lastSeen?new Date(s.lastSeen*1e3):null,r=a?Math.floor((new Date-a)/1e3):null;r!==null&&r<60?(n.textContent="Online",n.className="msm-sync-source-value status-good"):r!==null?(n.textContent=`Last seen ${r}s ago`,n.className="msm-sync-source-value status-warning"):(n.textContent="Unknown",n.className="msm-sync-source-value")}else e.textContent="No player found",t.textContent="--",n.textContent="Not detected",n.className="msm-sync-source-value status-warning"}function ma(e,t){var u,y;let n=document.getElementById("syncHealthBadge");if(!n)return;let s=n.querySelector("i"),a=n.querySelector("span"),o=(u=e.secondsSinceLastSync)!=null?u:-1,r=Math.abs((y=e.avgFrameDrift)!=null?y:0),i=t&&t.length>0,l=t&&t.some(b=>b.severity>=3),c=e.sequencePlaying===!0,d="good",p="Healthy",g=c&&o>30,h=c&&o>10;l||g||r>10?(d="critical",p="Critical"):i||h||r>5?(d="warning",p="Warning"):(o<0||e.totalPacketsReceived===0)&&(d="unknown",p="No Data"),n.className=`msm-sync-health msm-sync-health-${d}`,a&&(a.textContent=p)}function ga(e){let t=document.getElementById("systemPacketRate");if(!t)return;let n=e.totalPacketsReceived||0,s=Date.now();if(m.lastPacketTime!==null&&m.lastPacketCount>0){let a=(s-m.lastPacketTime)/1e3;if(a>0){let o=n-m.lastPacketCount;m.packetRate=o/a}}m.lastPacketCount=n,m.lastPacketTime=s,m.packetRate>0?t.textContent=`${m.packetRate.toFixed(1)}/sec`:t.textContent="--"}async function ha(e){let t=document.getElementById("compLocalSeq"),n=document.getElementById("compSyncSeq"),s=document.getElementById("compLocalStatus"),a=document.getElementById("compSyncStatus"),o=document.getElementById("comparisonStatus");if(!t)return;try{let h=await fetch("/api/fppd/status");h.ok&&(m.localFppStatus=await h.json())}catch(h){console.error("Error fetching local FPP status:",h)}let r=(e.currentMasterSequence||"").replace(/\.fseq$/i,"")||"(none)",i=e.sequencePlaying?"Playing":"Idle";n.textContent=r,a.textContent=i;let l="(none)",c="Idle",d=0;m.localFppStatus&&(l=(m.localFppStatus.current_sequence||"").replace(/\.fseq$/i,"")||"(none)",c=m.localFppStatus.status_name==="playing"?"Playing":"Idle"),t.textContent=l,s.textContent=c;let p=l===r||l==="(none)"&&r==="(none)",g=c===i;ua("compLocalSeq","compSyncSeq",p),ua("compLocalStatus","compSyncStatus",g),p||d++,g||d++,d===0?(o.textContent="Match",o.className="msm-comparison-status status-good"):(o.textContent=`${d} Mismatch${d>1?"es":""}`,o.className="msm-comparison-status status-critical")}function ua(e,t,n){let s=document.getElementById(e),a=document.getElementById(t);if(!(!s||!a))if(n){s.classList.remove("mismatch"),a.classList.remove("mismatch");let o=s.closest(".msm-comparison-row");if(o){let r=o.querySelector(".msm-comparison-vs");r&&(r.textContent="=",r.classList.remove("mismatch"))}}else{s.classList.add("mismatch"),a.classList.add("mismatch");let o=s.closest(".msm-comparison-row");if(o){let r=o.querySelector(".msm-comparison-vs");r&&(r.textContent="\u2260",r.classList.add("mismatch"))}}}function ya(e){return e.map(t=>{let n=t.address;return t.online?(m.consecutiveFailures[n]=0,m.lastKnownGoodState[n]=JSON.parse(JSON.stringify(t)),t):(m.consecutiveFailures[n]=(m.consecutiveFailures[n]||0)+1,m.consecutiveFailures[n]<3&&m.lastKnownGoodState[n]?{...m.lastKnownGoodState[n],_staleSinceFailure:m.consecutiveFailures[n]}:t)})}function va(e){let t=document.getElementById("remotesGrid");if(t){if(!e||e.length===0){t.innerHTML=`
      <div class="msm-empty" style="grid-column: 1/-1;">
        <i class="fas fa-satellite-dish"></i>
        <p>No remote systems found in multi-sync configuration</p>
      </div>
    `;return}t.innerHTML=e.map(n=>Ir(n)).join("")}}function Ir(e){let t="msm-remote-card",n="";e.online?e.pluginInstalled?n='<span class="msm-remote-badge online">Online</span>':(t+=" no-plugin",n='<span class="msm-remote-badge no-plugin">No Plugin</span>'):(t+=" offline",n='<span class="msm-remote-badge offline">Offline</span>'),e.maxSeverity>=3?t+=" critical":e.maxSeverity>=2&&(t+=" has-issues");let s=Sr(e),a=$r(e);return`
    <div class="${t}">
      <div class="msm-remote-header">
        <div>
          <div class="msm-remote-hostname">${f(e.hostname)}</div>
          <div class="msm-remote-address"><a href="http://${f(e.address)}/" target="_blank" class="msm-host-link">${f(e.address)}</a></div>
        </div>
        ${n}
      </div>
      <div class="msm-remote-body">${s}</div>
      ${a}
    </div>
  `}function Sr(e){if(!e.online)return'<div class="msm-remote-message"><i class="fas fa-plug"></i> Unreachable</div>';if(!e.pluginInstalled)return'<div class="msm-remote-message"><i class="fas fa-info-circle"></i> Watcher plugin not installed</div>';let t=e.metrics||{},n=e.fppStatus||{},s=n.sequence||t.currentMasterSequence||"--",a=n.status||(t.sequencePlaying?"playing":"idle"),o=a==="playing"?"Playing":"Idle",r=t.localCurrentFrame!==void 0&&t.localCurrentFrame>=0?t.localCurrentFrame:t.lastMasterFrame,i=a==="playing"&&r!==void 0?r.toLocaleString():"--",l=t.totalPacketsReceived!==void 0?t.totalPacketsReceived.toLocaleString():"--",c=t.millisecondsSinceLastSync!==void 0?St(t.millisecondsSinceLastSync):"--",d=t.sequencePlaying,p=a==="playing",g=p&&t.avgFrameDrift!==void 0?Math.abs(t.avgFrameDrift):null,h=g!==null?g.toFixed(1):"--",u=p&&t.maxFrameDrift!==void 0?Math.abs(t.maxFrameDrift):null,y=p&&t.avgSyncIntervalMs!==void 0&&t.syncIntervalSamples>0?t.avgSyncIntervalMs.toFixed(0)+"ms":"--",b=p&&t.syncIntervalJitterMs!==void 0&&t.syncIntervalSamples>0?t.syncIntervalJitterMs.toFixed(1)+"ms":"--",$=p&&t.avgSyncIntervalMs!==void 0&&t.avgSyncIntervalMs>0&&t.syncIntervalSamples>0?(1e3/t.avgSyncIntervalMs).toFixed(1)+"/s":"--",M="";p&&t.syncIntervalJitterMs!==void 0&&t.syncIntervalSamples>0&&(M=kt(t.syncIntervalJitterMs));let C="";g!==null&&(C=la(g));let w=p?"good":"";return d&&!p&&(w="critical"),`
    <div class="msm-remote-metrics">
      <div><span class="msm-remote-metric-label">Received Sequence</span><br><span class="msm-remote-metric-value">${f(s)||"(none)"}</span></div>
      <div><span class="msm-remote-metric-label">Status</span><br><span class="msm-remote-metric-value ${w}">${o}</span></div>
      <div><span class="msm-remote-metric-label">Packets Recv</span><br><span class="msm-remote-metric-value">${l}</span></div>
      <div><span class="msm-remote-metric-label">Frame</span><br><span class="msm-remote-metric-value msm-mono">${i}</span></div>
      <div><span class="msm-remote-metric-label">Seq Sync Rate</span><br><span class="msm-remote-metric-value">${$}</span></div>
      <div><span class="msm-remote-metric-label">Seq Sync Interval</span><br><span class="msm-remote-metric-value">${y}</span></div>
      <div><span class="msm-remote-metric-label">Seq Sync Jitter</span><br><span class="msm-remote-metric-value ${M}">${b}</span></div>
      <div><span class="msm-remote-metric-label">Last Sync</span><br><span class="msm-remote-metric-value">${c}</span></div>
      <div><span class="msm-remote-metric-label">Avg Frame Drift</span><br><span class="msm-remote-metric-value ${C}">${h}f</span></div>
      <div><span class="msm-remote-metric-label">Max Frame Drift</span><br><span class="msm-remote-metric-value ${C}">${u!==null?u+"f":"--"}</span></div>
    </div>
  `}function $r(e){if(!e.issues||e.issues.length===0)return"";let t=e.issues.filter(a=>a.type!=="no_plugin");if(t.length===0)return"";let n=e.maxSeverity>=3?"critical":"",s=t.map(a=>a.description).join("; ");return`<div class="msm-remote-issues ${n}"><i class="fas fa-exclamation-triangle"></i> ${f(s)}</div>`}function ba(e,t){if(!document.getElementById("systemsPacketBody"))return;m.systemsData=[];let s=m.fppSystems.find(i=>i.local===1)||{},a=(t==null?void 0:t.packetsSent)||{},o=(t==null?void 0:t.packetsReceived)||{},r=Et();m.systemsData.push({isLocal:!0,status:"local",hostname:r,address:s.address||"127.0.0.1",type:s.type||"FPP",mode:ve()?"Player":Ae()?"Remote":s.fppModeString||"--",syncSent:a.sync||0,syncRecv:o.sync||0,mediaSent:a.mediaSync||0,mediaRecv:o.mediaSync||0,blankSent:a.blank||0,blankRecv:o.blank||0,pluginSent:a.plugin||0,pluginRecv:o.plugin||0,hasMetrics:!0}),e&&e.length>0&&e.forEach(i=>{let l=m.fppSystems.find(g=>g.address===i.address)||{},c=i.metrics||{},d=c.packetsSent||{},p=c.packetsReceived||{};m.systemsData.push({isLocal:!1,status:i.online?i.pluginInstalled?"online":"no-plugin":"offline",hostname:i.hostname||l.hostname||i.address,address:i.address,type:l.type||"--",mode:l.fppModeString||"--",syncSent:d.sync||0,syncRecv:p.sync||0,mediaSent:d.mediaSync||0,mediaRecv:p.mediaSync||0,blankSent:d.blank||0,blankRecv:p.blank||0,pluginSent:d.plugin||0,pluginRecv:p.plugin||0,hasMetrics:i.online&&i.pluginInstalled})}),m.fppSystems.forEach(i=>{i.local!==1&&(m.systemsData.some(l=>l.address===i.address)||m.systemsData.push({isLocal:!1,status:"unknown",hostname:i.hostname,address:i.address,type:i.type||"--",mode:i.fppModeString||"--",drift:null,driftFrames:null,syncSent:0,syncRecv:0,mediaSent:0,mediaRecv:0,blankSent:0,blankRecv:0,pluginSent:0,pluginRecv:0,hasMetrics:!1}))}),Lt(),Mr()}function Lt(){let e=document.getElementById("systemsPacketBody");if(!e||m.systemsData.length===0)return;let t=m.currentSort.column,n=m.currentSort.direction==="asc"?1:-1;m.systemsData.sort((s,a)=>{var i,l,c,d,p,g;if(s.isLocal&&!a.isLocal)return-1;if(!s.isLocal&&a.isLocal)return 1;let o=s[t],r=a[t];if(t==="status"){let h={local:0,online:1,"no-plugin":2,offline:3,unknown:4};o=(i=h[o])!=null?i:5,r=(l=h[r])!=null?l:5}if(t==="drift"){let h=(d=(c=m.clockDriftData[s.address])==null?void 0:c.drift_ms)!=null?d:null,u=(g=(p=m.clockDriftData[a.address])==null?void 0:p.drift_ms)!=null?g:null;return h===null&&u===null?0:h===null?1:u===null?-1:n*(Math.abs(h)-Math.abs(u))}return typeof o=="string"?n*o.localeCompare(r):n*((o!=null?o:0)-(r!=null?r:0))}),e.innerHTML=m.systemsData.map(s=>kr(s)).join("")}function kr(e){let t=e.isLocal?"msm-status-local":e.status==="online"?"msm-status-online":e.status==="offline"?"msm-status-offline":e.status==="no-plugin"?"msm-status-noplugin":"msm-status-unknown",n=e.isLocal?"Local":e.status==="online"?"Online":e.status==="offline"?"Offline":e.status==="no-plugin"?"No Plugin":"--",s=e.syncSent+e.syncRecv+e.mediaSent+e.mediaRecv+e.blankSent+e.blankRecv+e.pluginSent+e.pluginRecv,a=!e.hasMetrics&&!e.isLocal?"msm-row-dim":"",o=Lr(e),r;return e.isLocal?r=`<i class="fas fa-home msm-home-icon"></i>${f(e.hostname)}`:r=`<a href="http://${f(e.address)}/" target="_blank" class="msm-host-link" title="${f(e.address)}">${f(e.hostname)}</a>`,`<tr class="${a}">
    <td><span class="msm-status-badge ${t}">${n}</span></td>
    <td>${r}</td>
    <td>${f(e.type)}</td>
    <td>${f(e.mode)}</td>
    <td class="msm-td-num">${o}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.syncSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.syncRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.mediaSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.mediaRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.blankSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.blankRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-sent">${e.hasMetrics?e.pluginSent.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-recv">${e.hasMetrics?e.pluginRecv.toLocaleString():"--"}</td>
    <td class="msm-td-num msm-td-total">${e.hasMetrics?s.toLocaleString():"--"}</td>
  </tr>`}function Lr(e){if(e.isLocal)return'<span class="msm-drift-ref">ref</span>';let t=m.clockDriftData[e.address];if(t&&t.drift_ms!==null){let n=t.drift_ms,s=Math.abs(n),a=n>=0?"+":"",o=ia(s),r=t.rtt_ms?`RTT: ${t.rtt_ms}ms`:"";return`<span class="${o}" title="${r}">${a}${n}ms</span>`}return e.hasMetrics?'<span class="msm-drift-pending">...</span>':"--"}function Mr(){let e=document.getElementById("systemsPacketTable");e&&e.querySelectorAll("th[data-sort]").forEach(t=>{let n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.onclick=()=>{let s=n.dataset.sort;m.currentSort.column===s?m.currentSort.direction=m.currentSort.direction==="asc"?"desc":"asc":(m.currentSort.column=s,m.currentSort.direction="asc"),e.querySelectorAll("th").forEach(a=>{a.classList.remove("msm-th-sorted-asc","msm-th-sorted-desc")}),n.classList.add(m.currentSort.direction==="asc"?"msm-th-sorted-asc":"msm-th-sorted-desc"),Lt()}})}function Ca(e){if(typeof Chart=="undefined"){console.error("Chart.js is not loaded");return}let t=e.labels.map(a=>new Date(a)),n=[{label:"Latency (ms)",data:t.map((a,o)=>({x:a,y:e.latency[o]})),borderColor:"#17a2b8",backgroundColor:"rgba(23, 162, 184, 0.1)",fill:!0,tension:.3},{label:"Jitter (ms)",data:t.map((a,o)=>({x:a,y:e.jitter[o]})),borderColor:"#ffc107",backgroundColor:"rgba(255, 193, 7, 0.1)",fill:!1,tension:.3}],s={responsive:!0,maintainAspectRatio:!1,animation:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"}},scales:{x:{type:"time",time:{displayFormats:{minute:"HH:mm",hour:"HH:mm"}},ticks:{maxTicksLimit:8}},y:{beginAtZero:!0,title:{display:!0,text:"Milliseconds"}}}};T(m.charts,"latencyJitter","latencyJitterChart","line",n,s)}function wa(e){if(typeof Chart=="undefined"){console.error("Chart.js is not loaded");return}let t=e.labels.map(l=>new Date(l)),n=e.packetLoss,s=n.filter(l=>l!=null),a=s.length>0?Math.max(...s):0,o=a<=5?5:Math.ceil(a/5)*5,r=[{label:"Packet Loss (%)",data:t.map((l,c)=>({x:l,y:n[c]})),borderColor:"#dc3545",backgroundColor:"rgba(220, 53, 69, 0.1)",fill:!0,tension:.3}],i={responsive:!0,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{type:"time",time:{displayFormats:{minute:"HH:mm",hour:"HH:mm"}},ticks:{maxTicksLimit:8}},y:{beginAtZero:!0,max:o,title:{display:!0,text:"Packet Loss %"}}}};T(m.charts,"packetLoss","packetLossChart","line",r,i)}function xa(e){let t=e.summary||{},n=document.getElementById("overallQuality");if(n){let c=t.overallQuality||"unknown";n.textContent=c.charAt(0).toUpperCase()+c.slice(1),n.className="msm-quality-indicator msm-quality-"+c}let s=t.avgLatency,a=document.getElementById("qualityLatency");a&&(a.textContent=s!==null?s+"ms":"--");let o=t.avgJitter,r=document.getElementById("qualityJitter");r&&(r.textContent=o!==null?o+"ms":"--");let i=t.avgPacketLoss,l=document.getElementById("qualityPacketLoss");if(l&&(l.textContent=i!==null?i+"%":"--"),e.hosts&&e.hosts.length>0){let c=e.hosts[0];$t("qualityLatency",c.latency_quality),$t("qualityJitter",c.jitter_quality),$t("qualityPacketLoss",c.packet_loss_quality)}}function Yt(){let e=`
    <div class="msm-ping-disabled">
      <i class="fas fa-info-circle"></i>
      <div>
        <strong>Remote Ping is disabled</strong>
        <p>Enable "Remote Ping" in <a href="plugin.php?plugin=fpp-plugin-watcher&page=configUI.php">Plugin Settings</a> to collect network quality metrics.</p>
      </div>
    </div>
  `,t=document.getElementById("latencyJitterChart");if(t){let a=t.parentElement;a&&(a.innerHTML=e)}let n=document.getElementById("packetLossChart");if(n){let a=n.parentElement;a&&(a.innerHTML=e)}let s=document.getElementById("overallQuality");s&&(s.textContent="Disabled",s.className="msm-quality-indicator msm-quality-unknown"),["qualityLatency","qualityJitter","qualityPacketLoss"].forEach(a=>{let o=document.getElementById(a);o&&(o.textContent="--",o.className=o.className.replace(/msm-quality-\w+/g,"").trim())})}function en(){return sa()}function Ea(e,t,n,s){let a={statRemotes:e,statOnline:t,statWithPlugin:n};for(let[r,i]of Object.entries(a)){let l=document.getElementById(r);l&&(l.textContent=i)}let o=document.getElementById("statIssues");o&&(o.textContent=s,o.className="msm-stat-value",s>0&&o.classList.add("warning"))}function tn(e){let t=document.getElementById("issuesPanel"),n=document.getElementById("issuesHeader"),s=document.getElementById("issuesList"),a=document.getElementById("issueCount");if(!t||!s)return;if(!e||e.length===0){t.classList.add("hidden");return}t.classList.remove("hidden"),a&&(a.textContent=e.length);let o=e.some(r=>r.severity>=3);n&&n.classList.toggle("critical",o),s.innerHTML=e.map(r=>Br(r)).join("")}function Br(e){let t=e.severity===3?"critical":e.severity===2?"warning":"info",n=e.severity===3?"times-circle":e.severity===2?"exclamation-triangle":"info-circle",s="";return e.expected&&e.actual?s=`Expected: ${e.expected}, Actual: ${e.actual}`:e.maxDrift!==void 0?s=`Max: ${e.maxDrift} frames, Avg: ${e.avgDrift} frames`:e.secondsSinceSync!==void 0&&(s=`Last sync: ${e.secondsSinceSync}s ago`),`
    <div class="msm-issue-item">
      <div class="msm-issue-icon ${t}"><i class="fas fa-${n}"></i></div>
      <div class="msm-issue-content">
        <div class="msm-issue-host">${f(e.host||"Local")}</div>
        <div class="msm-issue-description">${f(e.description)}</div>
        ${s?`<div class="msm-issue-details">${f(s)}</div>`:""}
      </div>
    </div>
  `}async function nn(){try{let e=document.querySelector(".msm-refresh-btn i");e&&e.classList.add("fa-spin");let[t,n]=await Promise.all([fetch("/api/plugin-apis/fpp-plugin-watcher/multisync/status"),fetch("/api/fppd/status")]);if(!t.ok){Qt("C++ plugin not responding. Restart FPP to load the plugin.");return}let s=await t.json();m.localStatus=s,n.ok&&(m.localFppStatus=await n.json()),oa(),await ca(s),da(s);let a=await fetch("/api/plugin-apis/fpp-plugin-watcher/multisync/issues"),o=[];a.ok&&(o=(await a.json()).issues||[]),ve()?(await Tr(o),await Fr()):(tn(o),pa(s),fa(),ma(s,o),ga(s),await ha(s)),aa()}catch(e){console.error("Error loading fast data:",e),Qt("Error connecting to multi-sync plugin: "+e.message)}finally{let e=document.querySelector(".msm-refresh-btn i");e&&e.classList.remove("fa-spin")}}async function sn(){try{if(ve()){let[e]=await Promise.all([fetch("/api/fppd/multiSyncSystems"),Pr(),an()]);if(e.ok){let t=await e.json();m.fppSystems=t.systems||[]}}else{let e=await fetch("/api/fppd/multiSyncSystems");if(e.ok){let t=await e.json();m.fppSystems=t.systems||[]}}m.slowDataLoaded=!0}catch(e){console.error("Error loading slow data:",e)}}async function Mt(){m.slowDataLoaded||await sn(),await nn()}async function Tr(e){try{let t=await fetch("/api/plugin/fpp-plugin-watcher/multisync/comparison");if(!t.ok)return;let n=await t.json();if(!n.success)return;let s=ya(n.remotes),a=n.issues.filter(l=>{if(l.type==="offline"){let c=s.find(d=>d.hostname===l.host||d.address===l.host);return c&&!c.online}return!0}),o=[...e,...a],r=s.filter(l=>l.online).length,i=s.filter(l=>l.pluginInstalled).length;Ea(s.length,r,i,o.length),tn(o),va(s),ba(s,m.localStatus)}catch(t){console.error("Error loading comparison:",t)}}async function Pr(){try{let e=await fetch("/api/plugin/fpp-plugin-watcher/multisync/clock-drift");if(!e.ok)return;let t=await e.json();if(!t.success)return;m.clockDriftData={},(t.hosts||[]).forEach(n=>{m.clockDriftData[n.address]={drift_ms:n.drift_ms,rtt_ms:n.rtt_ms,hasPlugin:n.hasPlugin}}),m.systemsData.length>0&&Lt()}catch(e){console.error("Error loading clock drift:",e)}}async function Fr(){if(!en()){Yt();return}try{let e=await fetch("/api/plugin/fpp-plugin-watcher/metrics/network-quality/current");if(!e.ok)return;let t=await e.json();if(!t.success)return;xa(t)}catch(e){console.error("Error loading network quality:",e)}}async function an(){if(!en()){Yt();return}let e=document.getElementById("qualityTimeRange"),t=(e==null?void 0:e.value)||6;try{let n=await fetch(`/api/plugin/fpp-plugin-watcher/metrics/network-quality/history?hours=${t}`);if(!n.ok)return;let s=await n.json();if(!s.success||!s.chartData)return;Ca(s.chartData),wa(s.chartData)}catch(n){console.error("Error loading quality charts:",n)}}async function Ia(){let e=m.systemsData.filter(s=>!s.isLocal&&s.hasMetrics),t=e.length,n=t>0?`Reset multi-sync metrics on this system and ${t} remote${t>1?"s":""}?`:"Reset all multi-sync metrics?";if(confirm(n))try{let s=[fetch("/api/plugin-apis/fpp-plugin-watcher/multisync/reset",{method:"POST"})];e.forEach(a=>{s.push(fetch(`http://${a.address}/api/plugin-apis/fpp-plugin-watcher/multisync/reset`,{method:"POST",mode:"cors"}).catch(o=>console.warn(`Failed to reset ${a.hostname}:`,o)))}),await Promise.all(s),await Mt()}catch(s){console.error("Error resetting:",s)}}var Sa={pageId:"multiSyncMetricsUI",init(e){ta(e),document.addEventListener("click",Xt),Mt(),m.fastRefreshInterval=setInterval(nn,2e3),m.slowRefreshInterval=setInterval(sn,3e4)},destroy(){document.removeEventListener("click",Xt),na()},refresh:Mt,resetMetrics:Ia,toggleHelpTooltip:ra,loadQualityCharts:an};var Oe={efuseMonitorUI:Ln,falconMonitorUI:Fn,configUI:qn,localMetricsUI:zn,connectivityUI:Kn,remoteMetricsUI:Xn,remotePingUI:ns,eventsUI:as,remoteControlUI:ea,multiSyncMetricsUI:Sa};function $a(){var s;let e=document.querySelector("[data-watcher-page]"),t=(s=e==null?void 0:e.dataset)==null?void 0:s.watcherPage,n=window.watcherConfig||{};t&&Oe[t]&&(Oe[t].init(n),window.page=Oe[t]),window.watcher={utils:et,charts:tt,api:nt,CHART_COLORS:j,pages:Oe}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$a):$a();return Ra(_r);})();
